<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Minecraft RCON Panel</title>
<style>
:root{
  --bg:#0b0f14;--panel:#0f1524;--card:#111a2d;--stroke:#1e2a46;--text:#e9f0ff;--muted:#9db0cc;
  --accent:#2a66ff;--accent-2:#39ff14;--danger:#ff4d57;--warn:#f7b731;--ok:#2ecc71
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f14,#0c1220 60%,#0a0f1a);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu}
.sidebar{position:fixed;inset:0 auto 0 0;width:260px;background:linear-gradient(180deg,#0f1524,#0b1020);border-right:1px solid var(--stroke);padding:18px}
.brand{display:flex;gap:10px;align-items:center;margin-bottom:16px}
.logo{width:28px;height:28px;border-radius:6px;background:radial-gradient(circle at 30% 30%, #48ff48, #146614)}
.brand h1{font-size:16px;margin:0;color:#cfe2ff}
.nav a{display:block;padding:10px 12px;border-radius:10px;color:#cbd5e0;text-decoration:none;margin:5px 0;border:1px solid transparent}
.nav a.active,.nav a:hover{background:#14203a;border-color:#21325a}
.main{margin-left:260px;min-height:100%;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
h2{margin:0 0 8px 0;font-size:18px}
h3{margin:0 0 8px 0;font-size:15px;color:#cfe2ff}
.small{color:var(--muted);font-size:12px}
input,select,textarea{width:100%;padding:10px;border-radius:10px;background:#0e1628;border:1px solid var(--stroke);color:#e6f1ff;margin:6px 0}
textarea{min-height:86px;resize:vertical}
.btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:9px 12px;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--stroke)}
.btn.danger{background:var(--danger)}
.btn.ok{background:var(--ok)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #1a2540}th{color:#a9bbd9;text-align:left;font-weight:600}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
.win{background:#0f172a;border:1px solid #223355;border-radius:12px;max-width:900px;width:100%;max-height:85vh;overflow:auto;padding:16px}
pre{white-space:pre-wrap;background:#0c1426;padding:10px;border-radius:10px}
.toast{position:fixed;right:16px;bottom:16px;background:#0f172a;border:1px solid #213358;padding:10px 12px;border-radius:10px;display:none}
.tag{display:inline-block;border:1px solid #2753a6;color:#cfe2ff;background:#0f1c39;border-radius:999px;padding:2px 8px;font-size:12px}
/* Ban bubbles */
.bubbles{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.bubble{background:#0f172a;border:1px solid #223355;border-radius:14px;padding:12px}
.bubble h4{margin:0 0 6px 0;font-size:14px;color:#cfe2ff}
.meta{font-size:12px;color:#9db0cc;margin:6px 0}
.kv{display:grid;grid-template-columns:90px 1fr;gap:6px;font-size:12px}
.kv div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.reason{margin-top:8px;padding:8px;border-radius:10px;background:#0c1426;border:1px solid #1b2b4d;font-size:12px}
.badge{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #2a4ea2;background:#0f1c39;color:#cfe2ff;margin-left:6px}
</style>
</head>
<body>
<div class="sidebar">
  <div class="brand"><div class="logo"></div><h1>MC RCON Panel</h1></div>
  <div class="nav">
    <a href="#" data-page="dash" class="active">üè† Dashboard</a>
    <a href="#" data-page="players">üë• Players</a>
    <a href="#" data-page="bans">üö´ Bans</a>
    <a href="#" data-page="rest">‚è±Ô∏è Restarts</a>
    <a href="#" data-page="cmd">‚å®Ô∏è Commands</a>
    <a href="#" data-page="bc">üì£ Broadcasts</a>
  </div>
</div>

<div class="main">
  <!-- Dashboard -->
  <div id="page-dash" class="page">
    <div class="header">
      <h2>Dashboard</h2>
      <button id="btn-emerg" class="btn danger">Emergency Restart</button>
    </div>
    <div class="cards">
      <div class="card">
        <h3>Status</h3>
        <div>Server: <b id="status">‚Äî</b></div>
        <div>Players: <b id="pcount">‚Äî</b></div>
        <div>Next restart: <span id="next">None</span> <span id="nextRel" class="small"></span></div>
      </div>
      <div class="card"><h3>Recent Online</h3><pre id="recent" class="small">‚Äî</pre></div>
      <div class="card">
        <h3>Quick Broadcast</h3>
        <input id="bcText" placeholder="Server restarting soon‚Ä¶"/>
        <div><button id="bcSend" class="btn ok">Send</button> <button id="bcPick" class="btn ghost">Use Preset</button></div>
      </div>
    </div>
  </div>

  <!-- Players -->
  <div id="page-players" class="page" style="display:none">
    <div class="header"><h2>Players</h2><input id="psearch" placeholder="Search username/IP"/></div>
    <div class="card">
      <table id="ptbl"><thead><tr><th>Username</th><th>UUID</th><th>Latest IP</th><th>First</th><th>Last</th><th>Playtime</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- Bans -->
  <div id="page-bans" class="page" style="display:none">
    <div class="header"><h2>Bans</h2></div>
    <div class="card">
      <h3>Ban IP</h3>
      <input id="ban-ip" placeholder="IP to ban (x.x.x.x)"/>
      <select id="ban-preset"></select>
      <input id="ban-reason" placeholder="Reason (optional)"/>
      <div><button id="ban-do" class="btn danger">Ban IP</button> <button id="ban-refresh" class="btn ghost">Refresh</button></div>
    </div>
    <div class="card">
      <h3>Ban Presets</h3>
      <input id="ban-label" placeholder="Label (e.g. Cheats)"/>
      <input id="ban-msg" placeholder="Reason (e.g. Hacked client)"/>
      <button id="ban-save" class="btn">Save Preset</button>
      <div class="small" id="ban-presets-note" style="margin-top:6px"></div>
    </div>
    <div class="card"><h3>Current Bans</h3><div id="bans-list" class="bubbles"></div></div>
  </div>

  <!-- Restarts -->
  <div id="page-rest" class="page" style="display:none">
    <div class="header"><h2>Scheduled Restarts</h2></div>
    <div class="card">
      <table id="stbl"><thead><tr><th>ID</th><th>Cron</th><th>Label</th><th>Enabled</th><th>Actions</th></tr></thead><tbody></tbody></table>
      <div style="margin-top:8px"><input id="cron" placeholder="Cron (e.g. 0 3 * * *)"/> <input id="label" placeholder="Label (optional)"/> <button id="sadd" class="btn">Add</button> <button id="sref" class="btn ghost">Refresh</button></div>
      <div class="small" style="margin-top:6px">Tips: <span class="tag">0 3 * * *</span> daily 3:00 ¬∑ <span class="tag">0 */6 * * *</span> every 6h ¬∑ <span class="tag">*/30 * * * *</span> every 30m</div>
    </div>
  </div>

  <!-- Commands -->
  <div id="page-cmd" class="page" style="display:none">
    <div class="header"><h2>Commands</h2></div>
    <div class="card"><input id="cmd" placeholder='say Hello from panel'/> <button id="send" class="btn">Run</button> <pre id="cout"></pre></div>
  </div>

  <!-- Broadcast presets -->
  <div id="page-bc" class="page" style="display:none">
    <div class="header"><h2>Broadcast Presets</h2></div>
    <div class="card">
      <input id="bp-label" placeholder="Label (e.g. Maintenance)"/>
      <textarea id="bp-msg" placeholder="Message (no quotes)"></textarea>
      <button id="bp-save" class="btn">Save</button>
    </div>
    <div class="card">
      <select id="bp-select"></select>
      <button id="bp-send" class="btn ok">Send Broadcast</button>
    </div>
  </div>
</div>

<div id="modal" class="modal"><div class="win"><div id="modal-body"></div><div style="text-align:right;margin-top:8px"><button id="modal-close" class="btn ghost">Close</button></div></div></div>
<div id="toast" class="toast"></div>

<script>
/* -------- Auth helpers (Basic) -------- */
function getAuthToken() { return localStorage.getItem('auth_b64') || ''; }
function setAuthToken(b64) { if (b64) localStorage.setItem('auth_b64', b64); }
function clearAuthToken() { localStorage.removeItem('auth_b64'); }
async function promptForCreds() {
  const u = prompt('Panel username:');
  if (!u) return null;
  const p = prompt('Panel password:');
  if (p == null) return null;
  const b64 = btoa(`${u}:${p}`);
  setAuthToken(b64);
  return b64;
}

/* -------- UI helpers -------- */
const pages=['dash','players','bans','rest','cmd','bc'];
document.querySelectorAll('.nav a').forEach(a=>{
  a.onclick=(e)=>{e.preventDefault();
    pages.forEach(p=>document.getElementById('page-'+p).style.display='none');
    document.querySelectorAll('.nav a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    document.getElementById('page-'+a.dataset.page).style.display='block';
  };
});
function showModal(html){const m=document.getElementById('modal');document.getElementById('modal-body').innerHTML=html;m.style.display='flex';}
document.getElementById('modal-close').onclick=()=>{document.getElementById('modal').style.display='none';};
function toast(t){const el=document.getElementById('toast');el.textContent=t;el.style.display='block';setTimeout(()=>el.style.display='none',1600);}
function fmtDur(s){s=Number(s||0);const d=Math.floor(s/86400);s%=86400;const h=Math.floor(s/3600);s%=3600;const m=Math.floor(s/60);return (d?d+'d ':'')+h+'h '+m+'m';}
function relFromSeconds(s){if(s==null)return'';const m=Math.floor(s/60),sec=s%60;if(s>=3600){const h=Math.floor(m/60),rm=m%60;return`in ${h}h ${rm}m`;}if(s>=60)return`in ${m}m ${sec}s`;return`in ${sec}s`;}
function safe(v, def=''){return v==null?def:String(v);}

/* -------- fetch wrapper with Basic Auth & retry -------- */
async function api(p,o){
  const auth = getAuthToken();
  const baseHeaders = { 'Content-Type':'application/json' };
  const headers = auth ? { ...baseHeaders, 'Authorization':'Basic '+auth } : baseHeaders;
  const r = await fetch(p,{credentials:'include',headers, ...o});
  if(r.status===401){
    const newAuth = await promptForCreds();
    if(!newAuth) throw new Error('Auth cancelled');
    const r2 = await fetch(p,{credentials:'include',headers:{...baseHeaders,'Authorization':'Basic '+newAuth},...o});
    if(!r2.ok) throw new Error(await r2.text());
    return r2.json();
  }
  if(!r.ok) throw new Error(await r.text());
  // some endpoints might return empty
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : {};
}

/* -------- Buttons / actions -------- */
document.getElementById('btn-emerg').onclick=async()=>{
  if(!confirm('Emergency restart now?'))return;
  try{await api('/api/restart-now',{method:'POST'});toast('Restart sent');}catch(e){toast('Failed: '+e.message);}
};

document.getElementById('bcSend').onclick=async()=>{
  const message=document.getElementById('bcText').value.trim();if(!message)return;
  try{await api('/api/broadcast',{method:'POST',body:JSON.stringify({message})});toast('Broadcast sent');}catch(e){toast('Failed: '+e.message);}
};
document.getElementById('bcPick').onclick=async()=>{
  try{
    const rows=await api('/api/broadcast-presets');
    if(!rows.length){toast('No presets yet');return;}
    const html='<h3>Presets</h3><ul>'+rows.map(r=>`<li><button class="btn ghost bp" data-msg="${encodeURIComponent(r.message||'')}">${r.label}</button></li>`).join('')+'</ul>';
    showModal(html);
  }catch(e){toast('Failed: '+e.message);}
};
document.getElementById('modal-body').onclick=(e)=>{
  if(e.target.classList.contains('bp')){
    document.getElementById('bcText').value=decodeURIComponent(e.target.dataset.msg||'');
    document.getElementById('modal').style.display='none';
  }
};

document.getElementById('send').onclick=async()=>{
  const c=document.getElementById('cmd').value.trim();if(!c)return;
  try{
    const out=await api('/api/command',{method:'POST',body:JSON.stringify({command:c})});
    document.getElementById('cout').textContent=out.out||JSON.stringify(out,null,2);
  }catch(e){document.getElementById('cout').textContent='Error: '+e.message;}
};

document.getElementById('ban-do').onclick=async()=>{
  const ip=document.getElementById('ban-ip').value.trim();
  const preset=document.getElementById('ban-preset').value;
  const manual=document.getElementById('ban-reason').value.trim();
  const reason=manual||preset||undefined;
  if(!ip) return toast('Enter IP');
  try{await api('/api/ban-ip',{method:'POST',body:JSON.stringify({ip,reason})});toast('IP banned');refreshBans();}catch(e){toast('Failed: '+e.message);}
};
document.getElementById('ban-save').onclick=async()=>{
  const label=document.getElementById('ban-label').value.trim();
  const reason=document.getElementById('ban-msg').value.trim();
  if(!label||!reason) return toast('Fill both');
  try{await api('/api/ban-presets',{method:'POST',body:JSON.stringify({label,reason})});toast('Preset saved');refreshBanPresets();}catch(e){toast('Failed: '+e.message);}
};
document.getElementById('ban-refresh').onclick=()=>refreshBans();

document.getElementById('bp-save').onclick=async()=>{
  const label=document.getElementById('bp-label').value.trim();
  const message=document.getElementById('bp-msg').value.trim();
  if(!label||!message) return toast('Fill both');
  try{await api('/api/broadcast-presets',{method:'POST',body:JSON.stringify({label,message})});toast('Saved');}catch(e){toast('Failed: '+e.message);}
};
document.getElementById('bp-send').onclick=async()=>{
  const sel=document.getElementById('bp-select');
  const opt=sel.options[sel.selectedIndex];
  if(!opt) return;
  try{await api('/api/broadcast',{method:'POST',body:JSON.stringify({message:opt.dataset.message||''})});toast('Broadcast sent');}catch(e){toast('Failed: '+e.message);}
};

document.getElementById('stbl').onclick=async(e)=>{
  if(e.target.classList.contains('t')){
    await api('/api/schedules/'+e.target.dataset.id+'/toggle',{method:'POST'}).catch(()=>{});
    refreshSchedules();
  }
  if(e.target.classList.contains('d')){
    await api('/api/schedules/'+e.target.dataset.id,{method:'DELETE'}).catch(()=>{});
    refreshSchedules();
  }
};
document.getElementById('sadd').onclick=async()=>{
  const cron=document.getElementById('cron').value.trim();
  const label=document.getElementById('label').value.trim();
  if(!cron) return;
  await api('/api/schedules',{method:'POST',body:JSON.stringify({cron,label})}).catch(()=>{});
  document.getElementById('cron').value='';document.getElementById('label').value='';
  refreshSchedules();
};
document.getElementById('sref').onclick=refreshSchedules;

document.getElementById('psearch').addEventListener('input', refreshPlayers);
document.getElementById('ptbl').onclick=async(e)=>{
  if(!e.target.classList.contains('v'))return;
  const id=e.target.dataset.id;
  try{
    const d=await api('/api/player/'+id);
    const p=d.player||{};
    const lines=[];
    lines.push(`<h3>${safe(p.username,'(unknown)')} ${p.uuid?`<span class="tag">${p.uuid}</span>`:''}</h3>`);
    lines.push(`<div class="small">Latest IP: ${safe(p.last_ip,'-')} ¬∑ First: ${safe(p.first_seen,'-')} ¬∑ Last: ${safe(p.last_seen,'-')} ¬∑ Playtime: ${p.total_playtime!=null?fmtDur(p.total_playtime):'-'}</div>`);
    const ips=(d.ips||[]).map(x=>`<li>${safe(x.ip)} <span class="small">${safe(x.seen_at,'')}</span></li>`).join('');
    const ses=(d.sessions||[]).map(s=>`<li>${safe(s.login_time)} ‚Üí ${safe(s.logout_time||'(active)')} <span class="small">${s.duration?fmtDur(s.duration):''}</span></li>`).join('');
    const cmds=(d.commands||[]).map(c=>`<li>${safe(c.executed_at)}: <code>${safe((c.command||'').replace(/</g,'&lt;'))}</code></li>`).join('');
    lines.push('<h4>IPs</h4><ul>'+(ips||'<li class="small">None</li>')+'</ul>');
    lines.push('<h4>Sessions</h4><ul>'+(ses||'<li class="small">None</li>')+'</ul>');
    lines.push('<h4>Commands</h4><ul>'+(cmds||'<li class="small">None</li>')+'</ul>');
    showModal(lines.join(''));
  }catch(e){toast('Failed: '+e.message);}
};

/* -------- Data refreshers -------- */
async function refreshStatus(){
  try{
    const st=await api('/api/status');
    document.getElementById('status').textContent=st.online?'Online':'Offline';
    document.getElementById('next').textContent=st.next_restart_iso?new Date(st.next_restart_iso).toLocaleString():'None';
    document.getElementById('nextRel').textContent=st.next_restart_seconds!=null?`(${relFromSeconds(st.next_restart_seconds)})`:'';
  }catch(e){
    document.getElementById('status').textContent='‚Äî';
  }
}
async function refreshOnline(){
  try{
    const on=await api('/api/online');
    document.getElementById('pcount').textContent = (on && typeof on.count==='number') ? on.count : '0';
    const lines = (on && Array.isArray(on.players) ? on.players : [])
      .map(p=>{
        const name = safe(p.username,'unknown');
        const id = safe(p.uuid,'');
        return id ? `${name} (${id})` : name;
      });
    document.getElementById('recent').textContent = lines.length ? lines.join('\n') : '‚Äî';
  }catch(e){
    document.getElementById('pcount').textContent='‚Äî';
    document.getElementById('recent').textContent='‚Äî';
  }
}
async function refreshPlayers(){
  try{
    const ps=await api('/api/players');
    const q=(document.getElementById('psearch').value||'').toLowerCase();
    const rows=(Array.isArray(ps)?ps:[]).filter(p=>{
      const u=(p.username||'').toLowerCase();
      const ip=p.last_ip||'';
      return !q || u.includes(q) || ip.includes(q);
    }).map(p=>`<tr>
      <td>${safe(p.username)}</td>
      <td class="small">${safe(p.uuid,'')}</td>
      <td>${safe(p.last_ip,'')}</td>
      <td class="small">${safe(p.first_seen,'')}</td>
      <td class="small">${safe(p.last_seen,'')}</td>
      <td>${p.total_playtime!=null?fmtDur(p.total_playtime):'-'}</td>
      <td><button class="v btn ghost" data-id="${p.id}">View</button></td>
    </tr>`).join('');
    document.querySelector('#ptbl tbody').innerHTML = rows || '<tr><td colspan="7" class="small">No players.</td></tr>';
  }catch(e){
    document.querySelector('#ptbl tbody').innerHTML = '<tr><td colspan="7" class="small">Failed to load.</td></tr>';
  }
}
async function refreshBans(){
  try{
    const data = await api('/api/bans');
    const root = document.getElementById('bans-list');
    const renderCard = (b) => {
      const when = b.banned_at ? new Date(b.banned_at).toLocaleString() : '‚Äî';
      const title = b.type==='ip' ? safe(b.target,'(ip)') : safe(b.username||b.target,'(player)');
      const badge = b.type==='ip' ? 'IP ban' : 'Player ban';
      const uuid = b.uuid ? `<div>UUID</div><div>${safe(b.uuid)}</div>` : '';
      const lastSeen = b.last_seen ? new Date(b.last_seen).toLocaleString() : '‚Äî';
      const playDur = (b.playtime_seconds!=null) ? fmtDur(b.playtime_seconds) : '‚Äî';
      const lastIp = b.last_ip || (b.type==='ip' ? b.target : '‚Äî');
      const by = safe(b.by,'Server');
      const reason = safe((b.reason||'No reason provided').replace(/</g,'&lt;'));

      return `
        <div class="bubble">
          <h4>${title} <span class="badge">${badge}</span></h4>
          <div class="meta">Banned: <b>${when}</b> ¬∑ By: <b>${by}</b></div>
          <div class="kv">
            <div>Last IP</div><div>${safe(lastIp)}</div>
            ${uuid}
            <div>Last Seen</div><div>${lastSeen}</div>
            <div>Playtime</div><div>${playDur}</div>
            <div>Reason</div><div class="reason">${reason}</div>
          </div>
        </div>
      `;
    };
    const players = (data.players||[]).map(renderCard).join('');
    const ips = (data.ips||[]).map(renderCard).join('');
    root.innerHTML = (players + ips) || '<div class="small">No active bans.</div>';
  }catch(e){
    document.getElementById('bans-list').innerHTML='<div class="small">Failed to load.</div>';
  }
}
async function refreshBanPresets(){
  try{
    const rows=await api('/api/ban-presets');
    const sel=document.getElementById('ban-preset');
    sel.innerHTML='<option value="">(no preset)</option>'+rows.map(r=>`<option value="${(r.reason||'').replace(/"/g,'&quot;')}">${r.label}</option>`).join('');
    document.getElementById('ban-presets-note').textContent=rows.length?`${rows.length} preset(s) available.`:'No presets yet.';
  }catch(e){/* ignore */}
}
async function refreshBcPresets(){
  try{
    const rows=await api('/api/broadcast-presets');
    const sel=document.getElementById('bp-select');
    sel.innerHTML=rows.map(r=>`<option data-message="${(r.message||'').replace(/"/g,'&quot;')}">${r.label}</option>`).join('');
  }catch(e){/* ignore */}
}
async function refreshSchedules(){
  try{
    const rows=await api('/api/schedules');
    const tb=document.querySelector('#stbl tbody');
    tb.innerHTML=rows.map(r=>`<tr>
      <td>${r.id}</td><td>${r.cron}</td><td>${r.label||''}</td>
      <td>${r.enabled?'yes':'no'}</td>
      <td><button class="t btn ghost" data-id="${r.id}">Toggle</button> <button class="d btn ghost" data-id="${r.id}">Delete</button></td>
    </tr>`).join('');
  }catch(e){
    document.querySelector('#stbl tbody').innerHTML='<tr><td colspan="5" class="small">Failed to load.</td></tr>';
  }
}

/* -------- Poll tick -------- */
async function tick(){
  await refreshStatus();
  await refreshOnline();
  await refreshPlayers();
}
setInterval(tick,2000);
tick();
refreshBans().catch(()=>{});
refreshBanPresets().catch(()=>{});
refreshBcPresets().catch(()=>{});
refreshSchedules().catch(()=>{});
</script>
</body>
</html>

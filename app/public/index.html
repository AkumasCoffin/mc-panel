<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minecraft WebGUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    [hidden]{display:none !important;}
    :root{
      --bg:#0f1115; --panel:#151823; --muted:#8b90a3; --text:#e6e9ef;
      --brand:#7c5cff; --brand-2:#44d3a8; --warn:#ffb020; --danger:#ff5d5d;
      --border:#212535; --chip:#1b2030;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0f1115,#0d0f14); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Inter,Arial,sans-serif;}
    a{color:inherit; text-decoration:none}
    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .side{position:sticky; top:0; height:100vh; padding:18px; border-right:1px solid var(--border); background:rgba(13,16,22,.65); backdrop-filter: blur(8px); display:flex; flex-direction:column; gap:14px;}
    .brand{display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background:linear-gradient(90deg,rgba(124,92,255,.15),rgba(68,211,168,.08)); border:1px solid var(--border);}
    .brand svg{width:22px; height:22px}
    .brand h1{font-size:16px; margin:0}
    .nav{display:flex; flex-direction:column; gap:6px; margin-top:8px}
    .nav button{display:flex; align-items:center; gap:10px; width:100%; background:transparent; color:var(--text); border:1px solid transparent; padding:10px 12px; border-radius:10px; cursor:pointer; text-align:left; transition:.15s;}
    .nav button:hover{background:var(--chip); border-color:var(--border)}
    .nav button.active{background:linear-gradient(90deg,rgba(124,92,255,.18),rgba(68,211,168,.12)); border-color:#2a2f44}
    .nav svg{width:16px;height:16px; opacity:.9}
    .side .foot{margin-top:auto; color:var(--muted); font-size:12px; opacity:.8}
    .main{padding:22px;}
    .toolbar{display:flex; align-items:center; gap:10px; margin-bottom:16px}
    .toolbar .chip{padding:6px 10px; background:var(--chip); border:1px solid var(--border); border-radius:999px; color:#cdd3e1}
    .cards{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:14px; grid-column: span 12;}
    @media (min-width: 900px){ .card.half{grid-column: span 6} .card.third{grid-column: span 4} .card.two{grid-column: span 8}}
    .card h3{margin:0 0 10px 0; font-size:15px}
    .muted{color:var(--muted)}
    .split{display:flex; gap:8px; flex-wrap:wrap}
    input[type=text], textarea, select{background:#0d111a; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; width:100%;}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .btn{background:#1a1f2e; color:#dfe6f3; border:1px solid var(--border); border-radius:10px; padding:10px 12px; cursor:pointer; transition:.15s;}
    .btn:hover{filter:brightness(1.1)}
    .btn.brand{background:linear-gradient(90deg,rgba(124,92,255,.25),rgba(68,211,168,.18)); border-color:#2a2f44}
    .btn.warn{background:rgba(255,176,32,.12); border-color:#4b3b1a}
    .btn.danger{background:rgba(255,93,93,.12); border-color:#4b1a1a}
    .btn.ghost{background:transparent}
    .tag{background:#0e1220; border:1px solid var(--border); color:#cdd3e1; padding:4px 8px; border-radius:999px; font-size:12px}
    .grid{display:grid; gap:10px}
    .grid.cols-2{grid-template-columns: repeat(2, 1fr)}
    .grid.cols-3{grid-template-columns: repeat(3, 1fr)}
    .grid.cols-4{grid-template-columns: repeat(4, 1fr)}
    @media (max-width: 900px){ .grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border-bottom:1px dashed #23283a; text-align:left}
    th{color:#aab3c7; font-weight:600; background:#121624; position:sticky; top:0}
    tr:hover td{background:#111522}
    .ban-card{display:flex; flex-direction:column; gap:8px; padding:12px; border:1px solid var(--border); border-radius:14px; background:#121627;}
    .ban-card .head{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .ban-card .who{display:flex; align-items:center; gap:8px}
    .pill{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .pill.player{background:rgba(124,92,255,.15)}
    .pill.ip{background:rgba(68,211,168,.15)}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50; padding:20px;}
    .modal.open{display:flex}
    .modal .sheet{width:min(980px,100%); max-height:90vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 10px 40px rgba(0,0,0,.5);}
    .toast{position:fixed; right:16px; bottom:16px; background:#121827; border:1px solid var(--border); color:#e8eefc; padding:10px 12px; border-radius:10px; z-index:60; display:none;}
    .toast.show{display:block; animation:fade 2.2s ease}
    @keyframes fade{0%{opacity:0; transform:translateY(8px)} 10%{opacity:1; transform:none} 80%{opacity:1} 100%{opacity:0}}
    .small{font-size:12px; color:#aab3c7}
    .right{margin-left:auto}
    .center{display:flex; justify-content:center; align-items:center}
    .empty{padding:18px; border:1px dashed #2b3147; border-radius:12px; color:#aab3c7; background:#0f1320}
  </style>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12l7-9 7 9-7 9-7-9z" stroke-width="1.5"/><path d="M3 12h18" stroke-width="1.5"/></svg>
        <h1>MC Panel</h1>
        <span class="right chip">Forge 1.20.1</span>
      </div>
      <div class="nav">
        <button data-tab="status" class="active"><svg viewBox="0 0 24 24"><path d="M3 12h6v9H3zM9 3h6v18H9zM15 8h6v13h-6z" fill="currentColor"/></svg>Dashboard</button>
        <button data-tab="online"><svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-9 9a9 9 0 1118 0H3z" fill="currentColor"/></svg>Online <span class="right tag" id="onlineCount">0</span></button>
        <button data-tab="players"><svg viewBox="0 0 24 24"><path d="M16 13a4 4 0 10-8 0 7 7 0 00-7 7h22a7 7 0 00-7-7z" fill="currentColor"/></svg>Players</button>
        <button data-tab="bans"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm5 10a5 5 0 01-8.536 3.536L15.536 8.464A4.982 4.982 0 0117 12zm-10 0a5 5 0 018.536-3.536L8.464 15.536A4.982 4.982 0 017 12z" fill="currentColor"/></svg>Bans</button>
        <button data-tab="schedules"><svg viewBox="0 0 24 24"><path d="M7 2v3M17 2v3M3 9h18M5 5h14a2 2 0 012 2v13H3V7a2 2 0 012-2z" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Scheduled Restarts</button>
        <button data-tab="presets"><svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h10M4 17h7" stroke="currentColor" fill="none" stroke-width="1.4"/></svg>Presets</button>
        <button data-tab="audit"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4zM8 8h8M8 12h8M8 16h5" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Audit / Commands</button>
      </div>
      <div class="foot small">
        <div id="statusChip">Status: <span class="tag">loading…</span></div>
        <div style="margin-top:6px">Next restart: <span id="nextRestart" class="tag">—</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <div class="chip">Basic Auth protected</div>
        <div id="tip" class="chip">Tip: click a player to open details</div>
        <button class="btn ghost right" id="refreshBtn">↻ Refresh</button>
      </div>

      <!-- STATUS -->
      <div id="tab-status" class="cards">
        <section class="card half">
          <h3>Server Status</h3>
          <div class="grid cols-2">
            <div class="empty" id="statusBox">Checking…</div>
            <div class="empty" id="restartBox">
              <div>Next Restart</div>
              <div class="row" style="margin-top:8px">
                <div><span class="tag" id="nextRestart2">—</span></div>
                <div><span class="tag" id="nextRestartIn">—</span></div>
              </div>
              <div class="small" style="margin-top:8px">Configured in <b>Scheduled Restarts</b>.</div>
            </div>
          </div>
        </section>

        <section class="card half">
          <h3>Online Now</h3>
          <div id="onlineList" class="grid cols-2"></div>
          <div id="onlineEmpty" class="empty" style="display:none">No one online.</div>
        </section>

        <section class="card">
          <h3>Quick Command</h3>
          <div class="row">
            <input id="cmdInput" type="text" value="list" />
            <button class="btn brand" id="sendCmd">Run</button>
          </div>
          <pre id="cmdOut" class="small" style="margin-top:10px; white-space:pre-wrap; background:#0e1220; border:1px solid var(--border); padding:10px; border-radius:10px; min-height:40px"></pre>
          <div class="small muted" id="rconNote" style="margin-top:8px"></div>
        </section>
      </div>

      <!-- ONLINE -->
      <div id="tab-online" class="cards" hidden>
        <section class="card">
          <h3>Online Players</h3>
          <div id="onlineList2" class="grid cols-3"></div>
          <div id="onlineEmpty2" class="empty" style="display:none">No one online.</div>
        </section>
      </div>

      <!-- PLAYERS -->
      <div id="tab-players" class="cards" hidden>
        <section class="card">
          <h3>All Players</h3>
          <div class="row" style="margin-bottom:8px">
            <input id="playerSearch" type="text" placeholder="Search username…" />
            <div class="chip" id="playerCountChip">0 players</div>
          </div>
          <div style="overflow:auto; max-height:70vh">
            <table id="playersTable">
              <thead><tr><th>User</th><th>UUID</th><th>Last IP</th><th>First Seen</th><th>Last Seen</th><th>Playtime</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- BANS -->
      <div id="tab-bans" class="cards" hidden>
        <section class="card two">
          <h3>Banned Players</h3>
          <div id="banPlayers" class="grid cols-2"></div>
          <div id="banPlayersEmpty" class="empty" style="display:none">No player bans found.</div>
        </section>
        <section class="card third">
          <h3>Banned IPs</h3>
          <div id="banIps" class="grid"></div>
          <div id="banIpsEmpty" class="empty" style="display:none">No IP bans found.</div>
        </section>
      </div>

      <!-- SCHEDULES -->
      <div id="tab-schedules" class="cards" hidden>
        <section class="card">
          <h3>Add Schedule</h3>
          <div class="row">
            <input id="cronExpr" type="text" placeholder="Cron (e.g. 0 */6 * * *)" />
            <input id="cronLabel" type="text" placeholder="Optional label" />
            <button class="btn brand" id="addSchedule">Add</button>
          </div>
          <div class="small" style="margin-top:6px">
            Tips:
            <span class="tag">0 3 * * *</span> daily 03:00 ·
            <span class="tag">0 */6 * * *</span> every 6h ·
            <span class="tag">*/30 * * * *</span> every 30m
          </div>
        </section>
        <section class="card">
          <h3>Schedules</h3>
          <div style="overflow:auto; max-height:60vh">
            <table id="schedTable">
              <thead><tr><th>ID</th><th>Label</th><th>Cron</th><th>Enabled</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- PRESETS -->
      <div id="tab-presets" class="cards" hidden>
        <section class="card half">
          <h3>Broadcast Presets</h3>
          <div class="row">
            <input id="bcLabel" type="text" placeholder="Label (optional)" />
            <input id="bcMessage" type="text" placeholder="Message" />
            <button class="btn brand" id="bcAdd">Save</button>
          </div>
          <div style="overflow:auto; max-height:50vh">
            <table id="bcTable"><thead><tr><th>ID</th><th>Label</th><th>Message</th><th></th></tr></thead><tbody></tbody></table>
          </div>
          <div class="row" style="margin-top:10px">
            <select id="bcSelect"><option value="">Select preset…</option></select>
            <button class="btn" id="bcSend">Send Broadcast</button>
          </div>
        </section>
        <section class="card half">
          <h3>Ban Presets</h3>
          <div class="row">
            <input id="banLabel" type="text" placeholder="Label (optional)" />
            <input id="banReason" type="text" placeholder="Reason" />
            <button class="btn brand" id="banAdd">Save</button>
          </div>
          <div style="overflow:auto; max-height:50vh">
            <table id="banTable"><thead><tr><th>ID</th><th>Label</th><th>Reason</th><th></th></tr></thead><tbody></tbody></table>
          </div>
          <div class="row" style="margin-top:10px">
            <input id="banUser" type="text" placeholder="Username to ban" />
            <select id="banSelect"><option value="">Select reason…</option></select>
            <button class="btn danger" id="banSend">Ban with Preset</button>
          </div>
          <div class="small muted">Requires RCON. Command: <code>ban &lt;user&gt; &lt;reason&gt;</code></div>
        </section>
      </div>

      <!-- AUDIT -->
      <div id="tab-audit" class="cards" hidden>
        <section class="card">
          <h3>Recent Audit Events</h3>
          <div style="overflow:auto; max-height:70vh">
            <table id="auditTable">
              <thead><tr><th>When</th><th>Action</th><th>Payload</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Player Modal -->
  <div class="modal" id="playerModal">
    <div class="sheet">
      <div class="row" style="align-items:center">
        <h3 id="pmTitle" style="margin:0">Player</h3>
        <button class="btn right" onclick="closePlayerModal()">Close</button>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="card">
          <h3>Profile</h3>
          <div class="small"><b>UUID:</b> <span id="pmUuid">—</span></div>
          <div class="small"><b>Last IP:</b> <span id="pmLastIp">—</span></div>
          <div class="small"><b>First Seen:</b> <span id="pmFirst">—</span></div>
          <div class="small"><b>Last Seen:</b> <span id="pmLast">—</span></div>
          <div class="small"><b>Total Playtime:</b> <span id="pmPlaytime">—</span></div>
        </div>
        <div class="card two">
          <h3>Sessions</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmSessions"><thead><tr><th>Login</th><th>Logout</th><th>Duration</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card two">
          <h3>Commands</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmCommands"><thead><tr><th>When</th><th>Command</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>IPs Seen</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmIps"><thead><tr><th>IP</th><th>When</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved.</div>

  <script>
    // Defensive: ensure only Dashboard is visible at boot, in case of cachey CSS
    ['online','players','bans','schedules','presets','audit']
      .forEach(t => { const el = document.getElementById('tab-'+t); if (el) el.hidden = true; });
    document.getElementById('tab-status').hidden = false;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function toast(msg='Saved.') { const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }
    function fmtDate(s){ if(!s) return '—'; const d = new Date(s); if (isNaN(d)) return s; return d.toLocaleString(); }
    function fmtDur(sec){ if(sec==null) return '—'; sec = Math.max(0, +sec|0); const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60; const parts = []; if(h) parts.push(h+'h'); if(m||h) parts.push((h?String(m).padStart(2,'0'):m)+'m'); parts.push(String(s).padStart(2,'0')+'s'); return parts.join(' '); }
    async function jget(url){ const r = await fetch(url); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function jpost(url,data){ const r = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function jdel(url){ const r = await fetch(url,{method:'DELETE'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Tabs
    const tabBtns = $$('.nav button');
    tabBtns.forEach(btn=>btn.addEventListener('click',()=>{
      tabBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.tab;
      $$('#tab-status,#tab-online,#tab-players,#tab-bans,#tab-schedules,#tab-presets,#tab-audit').forEach(x=>x.hidden = true);
      $('#tab-'+t).hidden = false;
      if (t==='online'){ loadOnline(true); }
      if (t==='players'){ loadPlayers(); }
      if (t==='bans'){ loadBans(); }
      if (t==='schedules'){ loadSchedules(); }
      if (t==='presets'){ loadPresets(); }
      if (t==='audit'){ loadAudit(); }
    }));

    // Status
    async function loadStatus(){
      try{
        const s = await jget('/api/status');
        $('#statusChip').innerHTML = 'Status: <span class="tag">online</span>' + (s.rcon? ' <span class="tag">RCON</span>' : ' <span class="tag">no RCON</span>');
        $('#rconNote').textContent = s.rcon ? 'RCON enabled.' : 'RCON disabled; only "list" is emulated.';
        $('#nextRestart').textContent = s.next_restart_iso ? fmtDate(s.next_restart_iso) : '—';
        $('#nextRestart2').textContent = $('#nextRestart').textContent;
        $('#nextRestartIn').textContent = s.next_restart_seconds!=null ? (Math.floor(s.next_restart_seconds/60)+' min') : '—';
        $('#statusBox').innerHTML = `<div class="row"><div><span class="tag">Panel OK</span></div><div><span class="tag">Auth: Basic</span></div></div><div class="small muted" style="margin-top:8px">Live log tracking enabled.</div>`;
      }catch(e){
        $('#statusChip').innerHTML = 'Status: <span class="tag">error</span>';
        $('#statusBox').innerHTML = '<div class="empty">Could not load /api/status</div>';
      }
    }
    async function runList(){
      $('#cmdOut').textContent = 'Running…';
      try{
        const out = await jpost('/api/command',{command: $('#cmdInput').value.trim() || 'list'});
        $('#cmdOut').textContent = out.out || JSON.stringify(out,null,2);
      }catch(e){ $('#cmdOut').textContent = e.message || 'Error'; }
    }
    $('#sendCmd').addEventListener('click', runList);

    // Online
    async function loadOnline(copyToStatus=false){
      try{
        const data = await jget('/api/online');
        $('#onlineCount').textContent = data.count ?? 0;
        const target1 = $('#onlineList'), target2 = $('#onlineList2');
        const empty1 = $('#onlineEmpty'), empty2 = $('#onlineEmpty2');
        const makeChip = (p)=>`<button class="btn" onclick="openPlayerByName('${p.username}')">${p.username}${p.uuid?` <span class='tag'>${p.uuid.slice(0,8)}</span>`:''}</button>`;
        target1.innerHTML = data.players.map(makeChip).join('');
        target2.innerHTML = data.players.map(makeChip).join('');
        empty1.style.display = data.players.length? 'none':'block';
        empty2.style.display = data.players.length? 'none':'block';
        if(copyToStatus){ $('#onlineList').innerHTML = target1.innerHTML; $('#onlineEmpty').style.display = empty1.style.display; }
      }catch{ $('#onlineCount').textContent = '—'; }
    }

    // Players
    let playersCache = [];
    async function loadPlayers(){
      const tbody = $('#playersTable tbody'); tbody.innerHTML = '<tr><td colspan="6" class="small">Loading…</td></tr>';
      try{
        const data = await jget('/api/players'); playersCache = data; redrawPlayers();
      }catch{ tbody.innerHTML = '<tr><td colspan="6" class="small">Failed to load players</td></tr>'; }
    }
    function redrawPlayers(){
      const q = ($('#playerSearch').value||'').toLowerCase();
      const rows = playersCache.filter(p=>p.username.toLowerCase().includes(q)).map(p=>`<tr onclick="openPlayer(${p.id})" style="cursor:pointer">
          <td>${p.username}</td><td class="small">${p.uuid??'—'}</td><td class="small">${p.last_ip??'—'}</td>
          <td class="small">${fmtDate(p.first_seen)}</td><td class="small">${fmtDate(p.last_seen)}</td><td>${fmtDur(p.total_playtime)}</td>
        </tr>`);
      $('#playersTable tbody').innerHTML = rows.join('') || `<tr><td colspan="6" class="small">No players</td></tr>`;
      $('#playerCountChip').textContent = `${playersCache.length} players`;
    }
    $('#playerSearch').addEventListener('input', redrawPlayers);

    // Player modal
    function closePlayerModal(){ $('#playerModal').classList.remove('open'); }
    async function openPlayer(id){
      try{
        const d = await jget('/api/player/'+id);
        $('#pmTitle').textContent = d.player.username;
        $('#pmUuid').textContent = d.player.uuid || '—';
        $('#pmLastIp').textContent = d.player.last_ip || '—';
        $('#pmFirst').textContent = fmtDate(d.player.first_seen);
        $('#pmLast').textContent = fmtDate(d.player.last_seen);
        $('#pmPlaytime').textContent = fmtDur(d.player.total_playtime);

        const sBody = d.sessions.map(s=>`<tr><td class="small">${fmtDate(s.login_time)}</td><td class="small">${fmtDate(s.logout_time)}</td><td>${fmtDur(s.duration)}</td></tr>`).join('');
        $('#pmSessions tbody').innerHTML = sBody || '<tr><td colspan="3" class="small">No sessions</td></tr>';

        const cBody = d.commands.map(c=>`<tr><td class="small">${fmtDate(c.executed_at)}</td><td class="small"><code>${escapeHtml(c.command)}</code></td></tr>`).join('');
        $('#pmCommands tbody').innerHTML = cBody || '<tr><td colspan="2" class="small">No commands</td></tr>';

        const iBody = d.ips.map(i=>`<tr><td>${i.ip}</td><td class="small">${fmtDate(i.seen_at)}</td></tr>`).join('');
        $('#pmIps tbody').innerHTML = iBody || '<tr><td colspan="2" class="small">No IPs</td></tr>';

        $('#playerModal').classList.add('open');
      }catch{ toast('Failed to load player'); }
    }
    function openPlayerByName(name){
      const p = playersCache.find(x=>x.username===name);
      if(p) return openPlayer(p.id);
      loadPlayers().then(()=>{ const p2 = playersCache.find(x=>x.username===name); if(p2) openPlayer(p2.id); });
    }
    $('#playerModal').addEventListener('click', (e)=>{ if(e.target.id==='playerModal') closePlayerModal(); });

    // Bans
    async function loadBans(){
      $('#banPlayers').innerHTML = '<div class="small muted">Loading…</div>';
      $('#banIps').innerHTML = '<div class="small muted">Loading…</div>';
      try{
        const data = await jget('/api/bans');
        if(data.players?.length){ $('#banPlayersEmpty').style.display = 'none';
          $('#banPlayers').innerHTML = data.players.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill player">Player</span><b>${x.username||x.target}</b></div>${x.uuid?`<span class="tag">${x.uuid.slice(0,8)}</span>`:''}</div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'—'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span>${x.last_ip?`<span class="pill">Last IP: ${x.last_ip}</span>`:''}${x.last_seen?`<span class="pill">Last Seen: ${fmtDate(x.last_seen)}</span>`:''}${x.playtime_seconds!=null?`<span class="pill">Playtime: ${fmtDur(x.playtime_seconds)}</span>`:''}</div></div>`).join('');
        }else{ $('#banPlayers').innerHTML = ''; $('#banPlayersEmpty').style.display = 'block'; }

        if(data.ips?.length){ $('#banIpsEmpty').style.display = 'none';
          $('#banIps').innerHTML = data.ips.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill ip">IP</span><b>${x.target}</b></div></div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'—'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span></div></div>`).join('');
        }else{ $('#banIps').innerHTML = ''; $('#banIpsEmpty').style.display = 'block'; }
      }catch{
        $('#banPlayers').innerHTML = '<div class="empty">Failed to load bans</div>'; $('#banIps').innerHTML = '';
      }
    }

    // Schedules
    async function loadSchedules(){
      const tbody = $('#schedTable tbody'); tbody.innerHTML = '<tr><td colspan="5" class="small">Loading…</td></tr>';
      try{
        const rows = await jget('/api/schedules');
        tbody.innerHTML = rows.map(r=>`<tr><td>${r.id}</td><td>${r.label|

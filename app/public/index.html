<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minecraft WebGUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    [hidden]{display:none !important;}
    :root{
      --bg:#0f1115; --panel:#151823; --muted:#8b90a3; --text:#e6e9ef;
      --brand:#7c5cff; --brand-2:#44d3a8; --warn:#ffb020; --danger:#ff5d5d;
      --border:#212535; --chip:#1b2030;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0f1115,#0d0f14); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Inter,Arial,sans-serif;}
    a{color:inherit; text-decoration:none}
    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .side{position:sticky; top:0; height:100vh; padding:18px; border-right:1px solid var(--border); background:rgba(13,16,22,.65); backdrop-filter: blur(8px); display:flex; flex-direction:column; gap:14px;}
    .brand{display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background:linear-gradient(90deg,rgba(124,92,255,.15),rgba(68,211,168,.08)); border:1px solid var(--border);}
    .brand svg{width:22px; height:22px}
    .brand h1{font-size:16px; margin:0}
    .nav{display:flex; flex-direction:column; gap:6px; margin-top:8px}
    .nav button{display:flex; align-items:center; gap:10px; width:100%; background:transparent; color:var(--text); border:1px solid transparent; padding:10px 12px; border-radius:10px; cursor:pointer; text-align:left; transition:.15s;}
    .nav button:hover{background:var(--chip); border-color:var(--border)}
    .nav button.active{background:linear-gradient(90deg,rgba(124,92,255,.18),rgba(68,211,168,.12)); border-color:#2a2f44}
    .nav svg{width:16px;height:16px; opacity:.9}
    .side .foot{margin-top:auto; color:var(--muted); font-size:12px; opacity:.8}
    .main{padding:22px;}
    .toolbar{display:flex; align-items:center; gap:10px; margin-bottom:16px}
    .toolbar .chip{padding:6px 10px; background:var(--chip); border:1px solid var(--border); border-radius:999px; color:#cdd3e1}
    .cards{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:14px; grid-column: span 12;}
    @media (min-width: 900px){ .card.half{grid-column: span 6} .card.third{grid-column: span 4} .card.two{grid-column: span 8}}
    .card h3{margin:0 0 10px 0; font-size:15px}
    .muted{color:var(--muted)}
    .split{display:flex; gap:8px; flex-wrap:wrap}
    input[type=text], textarea, select{background:#0d111a; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; width:100%;}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .btn{background:#1a1f2e; color:#dfe6f3; border:1px solid var(--border); border-radius:10px; padding:10px 12px; cursor:pointer; transition:.15s;}
    .btn:hover{filter:brightness(1.1)}
    .btn.brand{background:linear-gradient(90deg,rgba(124,92,255,.25),rgba(68,211,168,.18)); border-color:#2a2f44}
    .btn.warn{background:rgba(255,176,32,.12); border-color:#4b3b1a}
    .btn.danger{background:rgba(255,93,93,.12); border-color:#4b1a1a}
    .btn.ghost{background:transparent}
    .tag{background:#0e1220; border:1px solid var(--border); color:#cdd3e1; padding:4px 8px; border-radius:999px; font-size:12px}
    .grid{display:grid; gap:10px}
    .grid.cols-2{grid-template-columns: repeat(2, 1fr)}
    .grid.cols-3{grid-template-columns: repeat(3, 1fr)}
    .grid.cols-4{grid-template-columns: repeat(4, 1fr)}
    @media (max-width: 900px){ 
      .grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}
      .app{grid-template-columns:1fr; grid-template-rows:auto 1fr}
      .side{height:auto; position:static; flex-direction:row; overflow-x:auto; gap:8px; padding:12px}
      .nav{flex-direction:row; gap:8px; white-space:nowrap}
      .nav button{min-width:120px; justify-content:center}
      .main{padding:16px}
      .card.half,.card.third,.card.two{grid-column:span 12}
    }
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border-bottom:1px dashed #23283a; text-align:left}
    th{color:#aab3c7; font-weight:600; background:#121624; position:sticky; top:0}
    tr:hover td{background:#111522}
    .ban-card{display:flex; flex-direction:column; gap:8px; padding:12px; border:1px solid var(--border); border-radius:14px; background:#121627;}
    .ban-card .head{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .ban-card .who{display:flex; align-items:center; gap:8px}
    .pill{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .pill.player{background:rgba(124,92,255,.15)}
    .pill.ip{background:rgba(68,211,168,.15)}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50; padding:20px;}
    .modal.open{display:flex}
    .modal .sheet{width:min(980px,100%); max-height:90vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 10px 40px rgba(0,0,0,.5);}
    .toast{position:fixed; right:16px; bottom:16px; background:#121827; border:1px solid var(--border); color:#e8eefc; padding:10px 12px; border-radius:10px; z-index:60; display:none;}
    .toast.show{display:block; animation:fade 2.2s ease}
    @keyframes fade{0%{opacity:0; transform:translateY(8px)} 10%{opacity:1; transform:none} 80%{opacity:1} 100%{opacity:0}}
    .small{font-size:12px; color:#aab3c7}
    .right{margin-left:auto}
    .center{display:flex; justify-content:center; align-items:center}
    .empty{padding:18px; border:1px dashed #2b3147; border-radius:12px; color:#aab3c7; background:#0f1320}
    
    /* Chart containers */
    .chart-container{position:relative; height:200px; margin:10px 0}
    .chart-container canvas{background:rgba(15,17,21,0.5); border-radius:12px}
    .metric-box{background:linear-gradient(135deg,#151823,#1a1f2e); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center}
    .metric-value{font-size:24px; font-weight:bold; color:var(--brand)}
    .metric-label{font-size:12px; color:var(--muted); margin-top:4px}
    .status-indicator{display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px}
    
    /* Light theme support */
    body.light-theme {
      --bg: #f8f9fa; --panel: #ffffff; --muted: #6c757d; --text: #212529;
      --border: #dee2e6; --chip: #e9ecef;
      background: linear-gradient(180deg, #f8f9fa, #ffffff);
    }
    body.light-theme .side { background: rgba(255, 255, 255, 0.95); }
    body.light-theme .metric-box { background: linear-gradient(135deg, #ffffff, #f8f9fa); }
    body.light-theme .chart-container canvas { background: rgba(248, 249, 250, 0.5); }
    body.light-theme th { background: #f8f9fa; }
    body.light-theme .empty { background: #f8f9fa; border-color: #dee2e6; }
    
    /* Improved visual hierarchy */
    .section-header { margin: 20px 0 10px 0; font-size: 18px; font-weight: 600; color: var(--brand); }
    .action-group { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .action-group .btn { flex: 1; min-width: 120px; }
    
    /* Status indicators */
    .status-online { background: #22c55e; }
    .status-offline { background: #ef4444; }
    .status-unknown { background: #6b7280; }
    .status-indicator.good{background:#44d3a8}
    .status-indicator.warning{background:#ffb020}
    .status-indicator.critical{background:#ff5d5d}
  </style>
  <script>
    // Enhanced Chart.js fallback with better visual charts
    console.log('[panel] Setting up Chart.js fallback...');
    
    // Create enhanced mock Chart object
    window.Chart = function(ctx, config) {
      if (!ctx || !ctx.canvas || !config) {
        return { destroy: function() {}, update: function() {}, resize: function() {} };
      }
      
      const canvas = ctx.canvas;
      const context = canvas.getContext('2d');
      const data = config.data;
      const type = config.type;
      
      // Clear canvas
      context.clearRect(0, 0, canvas.width, canvas.height);
      
      // Set styling
      context.fillStyle = '#aab3c7';
      context.strokeStyle = '#7c5cff';
      context.font = '12px system-ui';
      context.textAlign = 'center';
      
      if (!data || !data.datasets || data.datasets.length === 0) {
        // Show "no data" message
        context.fillText('No chart data available', canvas.width / 2, canvas.height / 2);
        return { destroy: function() {}, update: function() {}, resize: function() {} };
      }
      
      const dataset = data.datasets[0];
      const values = dataset.data || [];
      const labels = data.labels || [];
      
      if (values.length === 0) {
        context.fillText('No data to display', canvas.width / 2, canvas.height / 2);
        return { destroy: function() {}, update: function() {}, resize: function() {} };
      }
      
      // Simple chart rendering based on type
      if (type === 'line') {
        drawLineChart(context, canvas, values, labels);
      } else if (type === 'bar') {
        drawBarChart(context, canvas, values, labels);
      } else if (type === 'doughnut') {
        drawDoughnutChart(context, canvas, values, labels);
      } else {
        context.fillText(`${type} chart (simplified)`, canvas.width / 2, canvas.height / 2);
        context.fillText(`${values.length} data points`, canvas.width / 2, canvas.height / 2 + 20);
      }
      
      return { destroy: function() {}, update: function() {}, resize: function() {} };
    };
    
    function drawLineChart(ctx, canvas, values, labels) {
      const padding = 40;
      const chartWidth = canvas.width - padding * 2;
      const chartHeight = canvas.height - padding * 2;
      const maxValue = Math.max(...values, 1);
      
      ctx.strokeStyle = '#7c5cff';
      ctx.fillStyle = 'rgba(124, 92, 255, 0.1)';
      ctx.lineWidth = 2;
      
      // Draw line
      ctx.beginPath();
      values.forEach((value, index) => {
        const x = padding + (index / (values.length - 1)) * chartWidth;
        const y = padding + chartHeight - (value / maxValue) * chartHeight;
        if (index === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Draw area under line
      ctx.lineTo(padding + chartWidth, padding + chartHeight);
      ctx.lineTo(padding, padding + chartHeight);
      ctx.closePath();
      ctx.fill();
      
      // Draw max value indicator
      ctx.fillStyle = '#aab3c7';
      ctx.textAlign = 'left';
      ctx.fillText(`Max: ${maxValue}`, padding, padding - 5);
    }
    
    function drawBarChart(ctx, canvas, values, labels) {
      const padding = 40;
      const chartWidth = canvas.width - padding * 2;
      const chartHeight = canvas.height - padding * 2;
      const maxValue = Math.max(...values, 1);
      const barWidth = chartWidth / values.length * 0.8;
      
      ctx.fillStyle = 'rgba(124, 92, 255, 0.6)';
      
      values.forEach((value, index) => {
        const x = padding + (index / values.length) * chartWidth + (chartWidth / values.length - barWidth) / 2;
        const height = (value / maxValue) * chartHeight;
        const y = padding + chartHeight - height;
        ctx.fillRect(x, y, barWidth, height);
      });
      
      // Draw max value indicator
      ctx.fillStyle = '#aab3c7';
      ctx.textAlign = 'left';
      ctx.fillText(`Max: ${maxValue}`, padding, padding - 5);
    }
    
    function drawDoughnutChart(ctx, canvas, values, labels) {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 20;
      const total = values.reduce((a, b) => a + b, 0);
      
      const colors = ['#7c5cff', '#44d3a8', '#ffb020', '#ff5d5d', '#9ca3af', '#6366f1'];
      
      let currentAngle = -Math.PI / 2;
      
      values.forEach((value, index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        
        ctx.fillStyle = colors[index % colors.length];
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, radius * 0.6, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();
        ctx.fill();
        
        currentAngle += sliceAngle;
      });
      
      // Draw center text
      ctx.fillStyle = '#aab3c7';
      ctx.textAlign = 'center';
      ctx.fillText(`${values.length} items`, centerX, centerY);
    }
    
    // Chart.js defaults
    window.Chart.defaults = {
      color: '#aab3c7',
      backgroundColor: 'rgba(124, 92, 255, 0.1)',
      borderColor: '#7c5cff',
      plugins: { legend: { labels: { color: '#aab3c7' } } },
      scales: {
        linear: { grid: { color: 'rgba(171, 179, 199, 0.1)' }, ticks: { color: '#aab3c7' } },
        category: { grid: { color: 'rgba(171, 179, 199, 0.1)' }, ticks: { color: '#aab3c7' } }
      }
    };
    
    console.log('[panel] Chart.js fallback ready');
  </script>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12l7-9 7 9-7 9-7-9z" stroke-width="1.5"/><path d="M3 12h18" stroke-width="1.5"/></svg>
        <h1>MC Panel</h1>
        <span class="right chip">Forge 1.20.1</span>
      </div>
      <div class="nav">
        <button data-tab="status" class="active"><svg viewBox="0 0 24 24"><path d="M3 12h6v9H3zM9 3h6v18H9zM15 8h6v13h-6z" fill="currentColor"/></svg>Dashboard</button>
        <button data-tab="mc-data"><svg viewBox="0 0 24 24"><path d="M12 3L3 8v8c0 4.97 3.84 8.74 9 10 5.16-1.26 9-5.03 9-10V8l-9-5z" stroke="currentColor" fill="none" stroke-width="1.5"/><circle cx="12" cy="12" r="3" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>MC Data</button>
        <button data-tab="server-controls"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>Server Controls</button>

        <button data-tab="players"><svg viewBox="0 0 24 24"><path d="M16 13a4 4 0 10-8 0 7 7 0 00-7 7h22a7 7 0 00-7-7z" fill="currentColor"/></svg>Players</button>

        <button data-tab="moderation"><svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>Moderation</button>
        <button data-tab="schedules"><svg viewBox="0 0 24 24"><path d="M7 2v3M17 2v3M3 9h18M5 5h14a2 2 0 012 2v13H3V7a2 2 0 012-2z" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Scheduled Restarts</button>
        <button data-tab="settings"><svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" fill="none"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>Settings</button>
        <button data-tab="audit"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4zM8 8h8M8 12h8M8 16h5" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Audit / Commands</button>
      </div>
      <div class="foot small">
        <div id="statusChip">Status: <span class="tag">loading…</span></div>
        <div style="margin-top:6px">Next restart: <span id="nextRestart" class="tag">—</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <div class="chip">Session authenticated</div>
        <div id="tip" class="chip">Tip: click a player to open details</div>
        <button class="btn ghost" id="logoutBtn">Logout</button>
        <button class="btn ghost right" id="refreshBtn">↻ Refresh</button>
      </div>

      <!-- STATUS -->
      <div id="tab-status" class="cards">
        <section class="card third">
          <h3>Server Status</h3>
          <div id="statusBox" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="serverStatusText">—</div>
              <div class="metric-label">Server Status</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="serverRconStatus">—</div>
              <div class="metric-label">RCON Status</div>
            </div>
          </div>
          <div style="margin-top:10px; font-size:12px; color:var(--muted)" id="serverStatusDetail">Live log tracking enabled.</div>
        </section>

        <section class="card third">
          <h3>Next Restart</h3>
          <div id="restartBox" class="empty">
            <div>Next Restart</div>
            <div class="row" style="margin-top:8px">
              <div><span class="tag" id="nextRestart2">—</span></div>
              <div><span class="tag" id="nextRestartIn">—</span></div>
            </div>
            <div class="small" style="margin-top:8px">Configured in <b>Scheduled Restarts</b>.</div>
          </div>
        </section>

        <section class="card third">
          <h3>Quick Stats</h3>
          <div id="quickStats" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="totalPlayers">—</div>
              <div class="metric-label">Total Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="onlineNow">—</div>
              <div class="metric-label">Online Now</div>
            </div>
          </div>
        </section>

        <section class="card half">
          <h3>Live Server Data</h3>
          <div id="onlineList" class="grid cols-2"></div>
          <div id="onlineEmpty" class="empty" style="display:none">No live data available.</div>
          <div class="small muted" style="margin-top:8px">
            Data from MC Data Collector. For detailed player info, visit the <button class="btn ghost" style="font-size:12px; padding:2px 6px;" onclick="document.querySelector('[data-tab=mc-data]').click()">MC Data tab</button>
          </div>
        </section>

        <section class="card half">
          <h3>Player Activity (7 days)</h3>
          <div class="chart-container">
            <canvas id="playerTrendChart"></canvas>
          </div>
        </section>

        <section class="card">
          <h3>Quick Command</h3>
          <div class="row">
            <input id="cmdInput" type="text" value="list" />
            <button class="btn brand" id="sendCmd">Run</button>
          </div>
          <pre id="cmdOut" class="small" style="margin-top:10px; white-space:pre-wrap; background:#0e1220; border:1px solid var(--border); padding:10px; border-radius:10px; min-height:40px"></pre>
          <div class="small muted" id="rconNote" style="margin-top:8px"></div>
        </section>

        <section class="card">
          <h3>Recent Activity</h3>
          <div id="recentActivity" style="max-height:200px; overflow-y:auto"></div>
        </section>
      </div>

      <!-- ONLINE -->


      <!-- MC DATA -->
      <div id="tab-mc-data" class="cards" hidden>
        <section class="card">
          <h3>MC Data Collector Status</h3>
          <div id="mcDataStatus">Loading...</div>
        </section>

        <section class="card half">
          <h3>Server Overview</h3>
          <div id="mcServerOverview" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="mcOnlinePlayers">—</div>
              <div class="metric-label">Online Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcTPS">—</div>
              <div class="metric-label">TPS</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcMemoryUsage">—</div>
              <div class="metric-label">Memory Usage %</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcWorldTime">—</div>
              <div class="metric-label">World Time</div>
            </div>
          </div>
        </section>

        <section class="card half">
          <h3>World Status</h3>
          <div id="mcWorldStatus">
            <div class="metric-box">
              <div class="metric-value" id="mcWeather">—</div>
              <div class="metric-label">Weather</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcIsDay">—</div>
              <div class="metric-label">Time of Day</div>
            </div>
          </div>
        </section>

        <section class="card">
          <h3>Online Players</h3>
          <div id="mcPlayersList">Loading...</div>
        </section>

        <section class="card half">
          <h3>Performance Metrics</h3>
          <div id="mcPerformanceMetrics">Loading...</div>
        </section>

        <section class="card half">
          <h3>Loaded Mods</h3>
          <div id="mcModsList">Loading...</div>
        </section>

        <section class="card">
          <h3>World Data</h3>
          <div class="grid cols-3">
            <div class="metric-box">
              <div class="metric-value" id="mcLoadedChunks">—</div>
              <div class="metric-label">Loaded Chunks</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcTotalEntities">—</div>
              <div class="metric-label">Total Entities</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcGameRules">—</div>
              <div class="metric-label">Game Rules Active</div>
            </div>
          </div>
        </section>

        <section class="card">
          <h3>Security & Administration</h3>
          <div id="mcSecurityInfo" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="mcOperators">—</div>
              <div class="metric-label">Operators</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcWhitelistEnabled">—</div>
              <div class="metric-label">Whitelist</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcBannedPlayers">—</div>
              <div class="metric-label">Banned Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="mcBannedIPs">—</div>
              <div class="metric-label">Banned IPs</div>
            </div>
          </div>
        </section>
      </div>


      <!-- SERVER CONTROLS -->
      <div id="tab-server-controls" class="cards" hidden>
        <section class="card">
          <h3>Server Control Actions</h3>
          <div class="row">
            <button class="btn brand" id="startServerBtn">
              <svg viewBox="0 0 24 24" style="width:16px;height:16px;margin-right:6px"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
              Start Server
            </button>
            <button class="btn warn" id="restartServerBtn">
              <svg viewBox="0 0 24 24" style="width:16px;height:16px;margin-right:6px"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke="currentColor" fill="none" stroke-width="2"/></svg>
              Restart Server
            </button>
            <button class="btn danger" id="stopServerBtn">
              <svg viewBox="0 0 24 24" style="width:16px;height:16px;margin-right:6px"><path d="M6 6h12v12H6z" fill="currentColor"/></svg>
              Stop Server
            </button>
          </div>
          
          <div style="margin-top:15px">
            <label for="serverBroadcastMsg">Broadcast message before action (optional):</label>
            <textarea id="serverBroadcastMsg" placeholder="Server will restart in 5 minutes for maintenance..." rows="2"></textarea>
          </div>
          
          <div class="row" style="margin-top:10px">
            <select id="serverBroadcastPreset">
              <option value="">Or select preset message...</option>
            </select>
            <button class="btn ghost" id="usePresetMsg">Use Preset</button>
          </div>
          
          <div class="small muted" style="margin-top:8px">
            Server status and details are available on the <button class="btn ghost" style="font-size:12px; padding:2px 6px;" onclick="document.querySelector('[data-tab=status]').click()">Dashboard</button>
          </div>
        </section>

        <section class="card">
          <h3>Recent Server Actions</h3>
          <div id="serverActionHistory" style="max-height:300px; overflow-y:auto">
            <div class="empty">Loading...</div>
          </div>
        </section>
      </div>

      <!-- PLAYERS -->
      <div id="tab-players" class="cards" hidden>
        <section class="card">
          <h3>All Players</h3>
          <div class="row" style="margin-bottom:8px">
            <input id="playerSearch" type="text" placeholder="Search username…" />
            <div class="chip" id="playerCountChip">0 players</div>
          </div>
          <div style="overflow:auto; max-height:70vh">
            <table id="playersTable">
              <thead><tr><th>User</th><th>UUID</th><th>Last IP</th><th>First Seen</th><th>Last Seen</th><th>Playtime</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- BANS -->


      <!-- MODERATION -->
      <div id="tab-moderation" class="cards" hidden>
        <section class="card half">
          <h3>Ban Player</h3>
          <div class="row" style="margin-bottom:10px">
            <input id="modBanUser" type="text" placeholder="Username to ban" />
            <select id="modBanSelect"><option value="">Select ban reason…</option></select>
            <button class="btn danger" id="modBanSend">Ban Player</button>
          </div>
          <div class="small muted">Requires RCON. Command: <code>ban &lt;user&gt; &lt;reason&gt;</code></div>
        </section>
        <section class="card half">
          <h3>Kick Player</h3>
          <div class="row" style="margin-bottom:10px">
            <input id="modKickUser" type="text" placeholder="Username to kick" />
            <select id="modKickSelect"><option value="">Select kick reason…</option></select>
            <button class="btn warn" id="modKickSend">Kick Player</button>
          </div>
          <div class="small muted">Requires RCON. Command: <code>kick &lt;user&gt; &lt;reason&gt;</code></div>
        </section>
        <section class="card two">
          <h3>Banned Players</h3>
          <div id="banPlayers" class="grid cols-2"></div>
          <div id="banPlayersEmpty" class="empty" style="display:none">No player bans found.</div>
        </section>
        <section class="card third">
          <h3>Banned IPs</h3>
          <div id="banIps" class="grid"></div>
          <div id="banIpsEmpty" class="empty" style="display:none">No IP bans found.</div>
        </section>
      </div>

      <!-- SCHEDULES -->
      <div id="tab-schedules" class="cards" hidden>
        <section class="card">
          <h3>Add Schedule</h3>
          <div class="row">
            <input id="cronExpr" type="text" placeholder="Cron (e.g. 0 */6 * * *)" />
            <input id="cronLabel" type="text" placeholder="Optional label" />
            <button class="btn brand" id="addSchedule">Add</button>
          </div>
          <div class="small" style="margin-top:6px">
            Tips:
            <span class="tag">0 3 * * *</span> daily 03:00 ·
            <span class="tag">0 */6 * * *</span> every 6h ·
            <span class="tag">*/30 * * * *</span> every 30m
          </div>
        </section>
        <section class="card">
          <h3>Schedules</h3>
          <div style="overflow:auto; max-height:60vh">
            <table id="schedTable">
              <thead><tr><th>ID</th><th>Label</th><th>Cron</th><th>Enabled</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- PRESETS -->
      <!-- SETTINGS -->
      <div id="tab-settings" class="cards" hidden>
        <section class="card">
          <h3>Broadcast Presets</h3>
          <div class="row">
            <input id="bcLabel" type="text" placeholder="Label (optional)" />
            <input id="bcMessage" type="text" placeholder="Message" />
            <button class="btn brand" id="bcAdd">Save Preset</button>
          </div>
          <div style="overflow:auto; max-height:40vh; margin-top:10px">
            <table id="bcTable"><thead><tr><th>ID</th><th>Label</th><th>Message</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <section class="card half">
          <h3>Ban Presets</h3>
          <div class="row">
            <input id="banLabel" type="text" placeholder="Label (optional)" />
            <input id="banReason" type="text" placeholder="Reason" />
            <button class="btn brand" id="banAdd">Save Preset</button>
          </div>
          <div style="overflow:auto; max-height:40vh; margin-top:10px">
            <table id="banTable"><thead><tr><th>ID</th><th>Label</th><th>Reason</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <section class="card half">
          <h3>Kick Presets</h3>
          <div class="row">
            <input id="kickLabel" type="text" placeholder="Label (optional)" />
            <input id="kickReason" type="text" placeholder="Reason" />
            <button class="btn brand" id="kickAdd">Save Preset</button>
          </div>
          <div style="overflow:auto; max-height:40vh; margin-top:10px">
            <table id="kickTable"><thead><tr><th>ID</th><th>Label</th><th>Reason</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <section class="card">
          <h3>Panel Configuration</h3>
          <div class="grid cols-2">
            <div>
              <label>Theme</label>
              <select id="themeSelect">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
            </div>
            <div>
              <label>Auto-refresh interval</label>
              <select id="refreshInterval">
                <option value="5000">5 seconds</option>
                <option value="10000" selected>10 seconds</option>
                <option value="30000">30 seconds</option>
                <option value="60000">1 minute</option>
              </select>
            </div>
          </div>
        </section>
      </div>

      <!-- AUDIT -->
      <div id="tab-audit" class="cards" hidden>
        <section class="card">
          <h3>Recent Audit Events</h3>
          <div style="overflow:auto; max-height:70vh">
            <table id="auditTable">
              <thead><tr><th>When</th><th>Action</th><th>Payload</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Player Modal -->
  <div class="modal" id="playerModal">
    <div class="sheet">
      <div class="row" style="align-items:center">
        <h3 id="pmTitle" style="margin:0">Player</h3>
        <button class="btn right" onclick="closePlayerModal()">Close</button>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="card">
          <h3>Profile</h3>
          <div class="small"><b>UUID:</b> <span id="pmUuid">—</span></div>
          <div class="small"><b>Last IP:</b> <span id="pmLastIp">—</span></div>
          <div class="small"><b>First Seen:</b> <span id="pmFirst">—</span></div>
          <div class="small"><b>Last Seen:</b> <span id="pmLast">—</span></div>
          <div class="small"><b>Total Playtime:</b> <span id="pmPlaytime">—</span></div>
        </div>
        <div class="card two">
          <h3>Sessions</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmSessions"><thead><tr><th>Login</th><th>Logout</th><th>Duration</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card two">
          <h3>Commands</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmCommands"><thead><tr><th>When</th><th>Command</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>IPs Seen</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmIps"><thead><tr><th>IP</th><th>When</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved.</div>

  <script>
    // Chart info popup function
    function showChartInfo(chartType) {
      const infoTexts = {
        'cpu-memory': 'Shows CPU and Memory usage over time. CPU percentage indicates processor load, Memory percentage shows RAM utilization. High sustained values may indicate performance issues.',
        'network-tps': 'Displays online player count over time. This helps track server activity patterns and peak usage times.',
        'player-trend': 'Shows unique player count and total sessions over the selected period. Useful for understanding server growth and player engagement trends.',
        'session-dist': 'Breakdown of player session lengths into categories (short, medium, long sessions). Helps understand how long players typically stay connected.',
        'daily-players': 'Daily unique player counts for the last 7 days. Shows both unique players and total sessions to track server activity patterns.',
        'hourly-heatmap': 'Shows when players are most active during different hours. Darker colors indicate higher activity. Useful for planning events or maintenance.',
        'command-usage': 'Most frequently used commands by players. Helps server administrators understand player behavior and popular features.'
      };
      
      const text = infoTexts[chartType] || 'Chart information not available.';
      alert(text); // Simple alert for now, could be improved with a modal
    }

    // Defensive: ensure only Dashboard is visible at boot, in case of cachey CSS
    ['players','moderation','schedules','settings','audit','analytics','performance','server-controls','mc-data']
      .forEach(t => { const el = document.getElementById('tab-'+t); if (el) el.hidden = true; });
    document.getElementById('tab-status').hidden = false;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function toast(msg='Saved.') { const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }
    function fmtDate(s){ if(!s) return '—'; const d = new Date(s); if (isNaN(d)) return s; return d.toLocaleString(); }
    function fmtDur(sec){ if(sec==null) return '—'; sec = Math.max(0, +sec|0); const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60; const parts = []; if(h) parts.push(h+'h'); if(m||h) parts.push((h?String(m).padStart(2,'0'):m)+'m'); parts.push(String(s).padStart(2,'0')+'s'); return parts.join(' '); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Chart.js defaults for dark theme (using our fallback implementation)
    function initializeChartJS() {
      if (typeof Chart !== 'undefined' && Chart.defaults) {
        Chart.defaults.color = '#aab3c7';
        Chart.defaults.backgroundColor = 'rgba(124, 92, 255, 0.1)';
        Chart.defaults.borderColor = '#7c5cff';
        if (Chart.defaults.plugins && Chart.defaults.plugins.legend) {
          Chart.defaults.plugins.legend.labels.color = '#aab3c7';
        }
        if (Chart.defaults.scales) {
          if (Chart.defaults.scales.linear) {
            Chart.defaults.scales.linear.grid.color = 'rgba(171, 179, 199, 0.1)';
            Chart.defaults.scales.linear.ticks.color = '#aab3c7';
          }
          if (Chart.defaults.scales.category) {
            Chart.defaults.scales.category.grid.color = 'rgba(171, 179, 199, 0.1)';
            Chart.defaults.scales.category.ticks.color = '#aab3c7';
          }
        }
        console.log('[panel] Chart.js defaults configured');
      } else {
        console.log('[panel] Using Chart.js fallback implementation');
      }
    }
    
    // Initialize Chart.js immediately since we provide our own implementation
    initializeChartJS();

    // Chart instances
    let playerTrendChart = null;
    let analyticsPlayerChart = null;
    let sessionDistChart = null;
    let hourlyActivityChart = null;
    let systemChart = null;
    let commandChart = null;
    let dailyPlayerChart = null;

    // Authentication handling - session-based (no more hardcoded auth headers)
    
    // Simple fetch functions with session-based authentication
    async function jget(url){ 
      const r = await fetch(url, { credentials: 'same-origin' }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }
    async function jpost(url,data){ 
      const r = await fetch(url,{
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body:JSON.stringify(data||{}),
        credentials: 'same-origin'
      }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }
    async function jdel(url){ 
      const r = await fetch(url,{
        method:'DELETE',
        credentials: 'same-origin'
      }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }

    // Tabs - with defensive initialization to handle timing issues
    function initializeTabs() {
      const tabBtns = $$('.nav button');
      
      // Check if tab buttons are available
      if (tabBtns.length === 0) {
        console.warn('[panel] Tab buttons not found, retrying in 100ms...');
        setTimeout(initializeTabs, 100);
        return;
      }
      
      console.log(`[panel] Initializing ${tabBtns.length} tab buttons`);
      
      tabBtns.forEach(btn => {
        // Remove any existing listeners to prevent duplicates
        btn.removeEventListener('click', btn._tabClickHandler);
        
        // Create and store the click handler
        btn._tabClickHandler = () => {
          tabBtns.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const t = btn.dataset.tab;
          $$('#tab-status,#tab-players,#tab-moderation,#tab-schedules,#tab-settings,#tab-audit,#tab-analytics,#tab-performance,#tab-server-controls,#tab-mc-data').forEach(x=>x.hidden = true);
          const targetTab = $('#tab-'+t);
          if (targetTab) {
            targetTab.hidden = false;
          } else {
            console.warn(`[panel] Tab content not found: tab-${t}`);
          }
          
          // Load tab-specific data

          if (t==='players'){ loadPlayers(); }
          if (t==='moderation'){ loadModeration(); loadBans(); }
          if (t==='schedules'){ loadSchedules(); }
          if (t==='settings'){ loadSettings(); }
          if (t==='audit'){ loadAudit(); }
          if (t==='server-controls'){ loadServerControls(); }
          if (t==='mc-data'){ loadMcData(); }
        };
        
        btn.addEventListener('click', btn._tabClickHandler);
      });
    }
    
    // Initialize tabs immediately and also retry if needed
    initializeTabs();

    // Status with enhanced dashboard data
    async function loadStatus(){
      try{
        const [status, dashboardData, serverStatus, mcSummary] = await Promise.all([
          jget('/api/status'),
          jget('/api/analytics/dashboard').catch(() => null),
          jget('/api/server/status').catch(() => null),
          jget('/api/mc-data/summary').catch(() => null)
        ]);
        
        // Prioritize MC data for player counts if available
        let onlineCount = 0;
        let totalPlayers = 0;
        
        if (mcSummary && mcSummary.available) {
          onlineCount = mcSummary.players?.online || 0;
          totalPlayers = mcSummary.players?.max || 0;
          
          // Update dashboard with MC data
          $('#totalPlayers').textContent = totalPlayers;
          $('#onlineNow').textContent = onlineCount;
          
          // Load and display MC players in the dashboard
          try {
            const mcPlayerData = await jget('/api/mc-data/players');
            if (mcPlayerData.players && mcPlayerData.players.length > 0) {
              const makeChip = (p) => `<button class="btn" onclick="openMcPlayerDetails('${p.name}')">${p.name}<span class='tag'>${p.status?.game_mode || 'unknown'}</span></button>`;
              $('#onlineList').innerHTML = mcPlayerData.players.map(makeChip).join('');
              $('#onlineEmpty').style.display = 'none';
            } else {
              $('#onlineList').innerHTML = '';
              $('#onlineEmpty').style.display = 'block';
            }
          } catch (e) {
            console.warn('Could not load MC player data for dashboard:', e.message);
          }
        } else if (dashboardData && dashboardData.current_stats) {
          // Fallback to dashboard data if MC data not available
          const stats = dashboardData.current_stats;
          onlineCount = stats.online_players || 0;
          totalPlayers = stats.total_players || 0;
          
          $('#totalPlayers').textContent = totalPlayers;
          $('#onlineNow').textContent = onlineCount;
        }
        
        $('#statusChip').innerHTML = 'Status: <span class="tag">online</span>' + (status.rcon? ' <span class="tag">RCON</span>' : ' <span class="tag">no RCON</span>') + 
          (mcSummary && mcSummary.available ? ' <span class="tag">MC Data</span>' : '');
        $('#rconNote').textContent = status.rcon ? 'RCON enabled.' : 'RCON disabled; only "list" is emulated.';
        $('#nextRestart').textContent = status.next_restart_iso ? fmtDate(status.next_restart_iso) : '—';
        $('#nextRestart2').textContent = $('#nextRestart').textContent;
        $('#nextRestartIn').textContent = status.next_restart_seconds!=null ? (Math.floor(status.next_restart_seconds/60)+' min') : '—';
        
        // Update enhanced server status card - prioritize MC data
        if (mcSummary && mcSummary.available) {
          const systemStatus = 'active'; // If we have MC data, server is active
          const statusClass = 'status-online';
          $('#serverStatusText').innerHTML = `<span class="status-indicator ${statusClass}"></span>${systemStatus}`;
          
          const rconStatus = status.rcon ? 'Available' : 'Unavailable';
          const rconClass = status.rcon ? 'status-online' : 'status-offline';
          $('#serverRconStatus').innerHTML = `<span class="status-indicator ${rconClass}"></span>${rconStatus}`;
          
          $('#serverStatusDetail').textContent = `${onlineCount} players online • MC Data Collector active`;
        } else if (serverStatus) {
          const systemStatus = serverStatus.system_status || 'unknown';
          const statusClass = systemStatus === 'active' ? 'status-online' : 
                             systemStatus === 'inactive' ? 'status-offline' : 'status-unknown';
          $('#serverStatusText').innerHTML = `<span class="status-indicator ${statusClass}"></span>${systemStatus}`;
          
          const rconStatus = serverStatus.rcon_available ? 'Available' : 'Unavailable';
          const rconClass = serverStatus.rcon_available ? 'status-online' : 'status-offline';
          $('#serverRconStatus').innerHTML = `<span class="status-indicator ${rconClass}"></span>${rconStatus}`;
          
          $('#serverStatusDetail').textContent = `${serverStatus.online_players || 0} players online • Live monitoring active`;
        } else {
          $('#serverStatusText').innerHTML = '<span class="status-indicator status-unknown"></span>Unknown';
          $('#serverRconStatus').innerHTML = '<span class="status-indicator status-offline"></span>' + (status.rcon ? 'Available' : 'Unavailable');
          $('#serverStatusDetail').textContent = 'Live log tracking enabled.';
        }
        
        // Update recent activity with priority to MC data
        if (dashboardData && dashboardData.recent_activity) {
          const activities = dashboardData.recent_activity.slice(0, 5).map(act => {
            const icon = act.type === 'join' ? '🟢' : '🔴';
            const time = new Date(act.timestamp).toLocaleTimeString();
            return `<div class="small" style="margin-bottom:4px">${icon} ${act.username} ${act.type === 'join' ? 'joined' : 'left'} at ${time}</div>`;
          }).join('');
          $('#recentActivity').innerHTML = activities || '<div class="empty">No recent activity</div>';
        }
        
        // Update player trend chart on dashboard
        if (dashboardData && dashboardData.player_trend && dashboardData.player_trend.length > 0) {
          updatePlayerTrendChart(dashboardData.player_trend);
        }
      }catch(e){
        $('#statusChip').innerHTML = 'Status: <span class="tag">error</span>';
        $('#serverStatusText').innerHTML = '<span class="status-indicator status-unknown"></span>Error';
        $('#serverRconStatus').innerHTML = '<span class="status-indicator status-offline"></span>Error';
        $('#serverStatusDetail').textContent = 'Could not load server status.';
      }
    }

    // Update player trend chart (small version for dashboard)
    function updatePlayerTrendChart(data) {
      const ctx = $('#playerTrendChart').getContext('2d');
      
      if (playerTrendChart) {
        playerTrendChart.destroy();
      }
      
      // Prepare data for our fallback chart implementation
      const chartData = {
        labels: data.map(d => new Date(d.date).toLocaleDateString()),
        datasets: [{
          label: 'Unique Players',
          data: data.map(d => d.unique_players || 0),
          borderColor: '#7c5cff',
          backgroundColor: 'rgba(124, 92, 255, 0.1)',
          tension: 0.4,
          fill: true
        }]
      };
      
      playerTrendChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: { color: 'rgba(171, 179, 199, 0.1)' }
            },
            x: { 
              grid: { color: 'rgba(171, 179, 199, 0.1)' }
            }
          }
        }
      });
    }
    async function runList(){
      $('#cmdOut').textContent = 'Running…';
      try{
        const out = await jpost('/api/command',{command: $('#cmdInput').value.trim() || 'list'});
        $('#cmdOut').textContent = out.out || JSON.stringify(out,null,2);
      }catch(e){ $('#cmdOut').textContent = e.message || 'Error'; }
    }
    $('#sendCmd').addEventListener('click', runList);

    // Online players - prioritize MC data, fallback to log-based detection
    async function loadOnline(copyToStatus=false){
      try{
        // Try MC data first
        const mcPlayerData = await jget('/api/mc-data/players').catch(() => null);
        
        if (mcPlayerData && mcPlayerData.players && mcPlayerData.players.length > 0) {
          // Use MC data
          const onlineCountEl = $('#onlineCount');
          if (onlineCountEl) onlineCountEl.textContent = mcPlayerData.online_count ?? mcPlayerData.players.length;
          
          const target1 = $('#onlineList'), target2 = $('#onlineList2');
          const empty1 = $('#onlineEmpty'), empty2 = $('#onlineEmpty2');
          const makeChip = (p)=>`<button class="btn" onclick="openMcPlayerDetails('${p.name}')">${p.name}<span class='tag'>${p.status?.game_mode || 'unknown'}</span></button>`;
          
          if (target1) {
            target1.innerHTML = mcPlayerData.players.map(makeChip).join('');
          }
          if (target2) {
            target2.innerHTML = mcPlayerData.players.map(makeChip).join('');
          }
          if (empty1) {
            empty1.style.display = 'none';
          }
          if (empty2) {
            empty2.style.display = 'none';
          }
          
          if(copyToStatus && target1 && empty1){ 
            const onlineListEl = $('#onlineList');
            const onlineEmptyEl = $('#onlineEmpty');
            if (onlineListEl) onlineListEl.innerHTML = target1.innerHTML; 
            if (onlineEmptyEl) onlineEmptyEl.style.display = empty1.style.display; 
          }
          return;
        }
        
        // Fallback to log-based data
        const data = await jget('/api/online');
        const onlineCountEl = $('#onlineCount');
        if (onlineCountEl) onlineCountEl.textContent = data.count ?? 0;
        
        const target1 = $('#onlineList'), target2 = $('#onlineList2');
        const empty1 = $('#onlineEmpty'), empty2 = $('#onlineEmpty2');
        const makeChip = (p)=>`<button class="btn" onclick="openPlayerByName('${p.username}')">${p.username}${p.uuid?` <span class='tag'>${p.uuid.slice(0,8)}</span>`:''}</button>`;
        
        if (target1) {
          target1.innerHTML = data.players.map(makeChip).join('');
        }
        if (target2) {
          target2.innerHTML = data.players.map(makeChip).join('');
        }
        if (empty1) {
          empty1.style.display = data.players.length? 'none':'block';
        }
        if (empty2) {
          empty2.style.display = data.players.length? 'none':'block';
        }
        
        if(copyToStatus && target1 && empty1){ 
          const onlineListEl = $('#onlineList');
          const onlineEmptyEl = $('#onlineEmpty');
          if (onlineListEl) onlineListEl.innerHTML = target1.innerHTML; 
          if (onlineEmptyEl) onlineEmptyEl.style.display = empty1.style.display; 
        }
      }catch{ 
        const onlineCountEl = $('#onlineCount');
        if (onlineCountEl) onlineCountEl.textContent = '—'; 
      }
    }

    // Players
    let playersCache = [];
    async function loadPlayers(){
      const tbody = $('#playersTable tbody'); tbody.innerHTML = '<tr><td colspan="6" class="small">Loading…</td></tr>';
      try{
        const data = await jget('/api/players'); playersCache = data; redrawPlayers();
      }catch{ tbody.innerHTML = '<tr><td colspan="6" class="small">Failed to load players</td></tr>'; }
    }
    function redrawPlayers(){
      const q = ($('#playerSearch').value||'').toLowerCase();
      const rows = playersCache.filter(p=>p.username.toLowerCase().includes(q)).map(p=>`<tr onclick="openPlayer(${p.id})" style="cursor:pointer">
          <td>${p.username}</td><td class="small">${p.uuid??'—'}</td><td class="small">${p.last_ip??'—'}</td>
          <td class="small">${fmtDate(p.first_seen)}</td><td class="small">${fmtDate(p.last_seen)}</td><td>${fmtDur(p.total_playtime)}</td>
        </tr>`);
      $('#playersTable tbody').innerHTML = rows.join('') || `<tr><td colspan="6" class="small">No players</td></tr>`;
      $('#playerCountChip').textContent = `${playersCache.length} players`;
    }
    $('#playerSearch').addEventListener('input', redrawPlayers);

    // Player modal
    function closePlayerModal(){ $('#playerModal').classList.remove('open'); }
    async function openPlayer(id){
      try{
        const d = await jget('/api/player/'+id);
        $('#pmTitle').textContent = d.player.username;
        $('#pmUuid').textContent = d.player.uuid || '—';
        $('#pmLastIp').textContent = d.player.last_ip || '—';
        $('#pmFirst').textContent = fmtDate(d.player.first_seen);
        $('#pmLast').textContent = fmtDate(d.player.last_seen);
        $('#pmPlaytime').textContent = fmtDur(d.player.total_playtime);

        const sBody = d.sessions.map(s=>`<tr><td class="small">${fmtDate(s.login_time)}</td><td class="small">${fmtDate(s.logout_time)}</td><td>${fmtDur(s.duration)}</td></tr>`).join('');
        $('#pmSessions tbody').innerHTML = sBody || '<tr><td colspan="3" class="small">No sessions</td></tr>';

        const cBody = d.commands.map(c=>`<tr><td class="small">${fmtDate(c.executed_at)}</td><td class="small"><code>${escapeHtml(c.command)}</code></td></tr>`).join('');
        $('#pmCommands tbody').innerHTML = cBody || '<tr><td colspan="2" class="small">No commands</td></tr>';

        const iBody = d.ips.map(i=>`<tr><td>${i.ip}</td><td class="small">${fmtDate(i.seen_at)}</td></tr>`).join('');
        $('#pmIps tbody').innerHTML = iBody || '<tr><td colspan="2" class="small">No IPs</td></tr>';

        $('#playerModal').classList.add('open');
      }catch{ toast('Failed to load player'); }
    }
    function openPlayerByName(name){
      const p = playersCache.find(x=>x.username===name);
      if(p) return openPlayer(p.id);
      loadPlayers().then(()=>{ const p2 = playersCache.find(x=>x.username===name); if(p2) openPlayer(p2.id); });
    }
    
    // Open MC player details (simpler version for MC data)
    function openMcPlayerDetails(name) {
      // For now, just show an alert with basic info - could be enhanced to show a modal
      alert(`Player: ${name}\nSource: MC Data Collector\nClick on Players tab for detailed information.`);
    }
    $('#playerModal').addEventListener('click', (e)=>{ if(e.target.id==='playerModal') closePlayerModal(); });

    // MC Data Collector
    async function loadMcData(){
      try {
        // Update status
        $('#mcDataStatus').innerHTML = '<div class="small">Checking MC Data Collector...</div>';
        
        const status = await jget('/api/mc-data/status');
        $('#mcDataStatus').innerHTML = `
          <div class="tag">Connected</div>
          <span class="small muted">Last update: ${new Date(status.last_update).toLocaleTimeString()}</span>
        `;
        
        // Load summary data with error handling
        try {
          const summary = await jget('/api/mc-data/summary');
          if (summary && summary.available) {
            // Update server overview
            $('#mcOnlinePlayers').textContent = `${summary.players?.online || 0}/${summary.players?.max || 0}`;
            $('#mcTPS').textContent = (summary.performance?.tps || 0).toFixed(1);
            $('#mcMemoryUsage').textContent = (summary.performance?.memory_usage || 0).toFixed(1) + '%';
            $('#mcWorldTime').textContent = summary.world?.time || '—';
            
            // Update world status  
            const weather = summary.world?.weather || {};
            $('#mcWeather').textContent = weather.thundering ? 'Thundering' : 
                                         weather.raining ? 'Raining' : 'Clear';
            $('#mcIsDay').textContent = summary.world?.is_day ? 'Day' : 'Night';
          } else {
            // Handle case where summary is not available
            $('#mcOnlinePlayers').textContent = '—';
            $('#mcTPS').textContent = '—';
            $('#mcMemoryUsage').textContent = '—';
            $('#mcWorldTime').textContent = '—';
            $('#mcWeather').textContent = '—';
            $('#mcIsDay').textContent = '—';
          }
        } catch (e) {
          console.warn('Failed to load MC summary data:', e);
          $('#mcOnlinePlayers').textContent = '—';
          $('#mcTPS').textContent = '—';
          $('#mcMemoryUsage').textContent = '—';
          $('#mcWorldTime').textContent = '—';
          $('#mcWeather').textContent = '—';
          $('#mcIsDay').textContent = '—';
        }
        
        // Load detailed player data with error handling
        try {
          const playerData = await jget('/api/mc-data/players');
          let playersHtml = '<div class="grid cols-1">';
          if (playerData?.players && playerData.players.length > 0) {
            playerData.players.forEach(player => {
              const location = player.location || {};
              const status = player.status || {};
              playersHtml += `
                <div class="card" style="margin-bottom: 10px; padding: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <strong>${player.name || '—'}</strong>
                      <div class="small muted">${location.dimension || '—'} (${location.x || 0}, ${location.y || 0}, ${location.z || 0})</div>
                    </div>
                    <div style="text-align: right;">
                      <div class="tag">${(status.health || 0).toFixed(1)}♥</div>
                      <div class="small muted">Ping: ${status.ping || 0}ms</div>
                    </div>
                  </div>
                  <div class="small" style="margin-top: 8px;">
                    Level ${status.experience_level || 0} • ${status.game_mode || 'unknown'}
                    ${status.afk ? ' • <span class="tag warn">AFK</span>' : ''}
                  </div>
                </div>
              `;
            });
          } else {
            playersHtml += '<div class="small muted">No players online</div>';
          }
          playersHtml += '</div>';
          $('#mcPlayersList').innerHTML = playersHtml;
        } catch (e) {
          console.warn('Failed to load MC player data:', e);
          $('#mcPlayersList').innerHTML = '<div class="small muted">Failed to load player data</div>';
        }
        
        // Load performance data with error handling
        try {
          const perfData = await jget('/api/mc-data/performance');
          if (perfData) {
            const memory = perfData.memory || {};
            const threads = perfData.threads || {};
            const ticks = perfData.ticks || {};
            const cpu = perfData.cpu || {};
            
            $('#mcPerformanceMetrics').innerHTML = `
              <div class="grid cols-2">
                <div class="metric-box">
                  <div class="metric-value">${(memory.heap_usage_percent || 0).toFixed(1)}%</div>
                  <div class="metric-label">Heap Memory</div>
                </div>
                <div class="metric-box">
                  <div class="metric-value">${threads.thread_count || '—'}</div>
                  <div class="metric-label">Threads</div>
                </div>
                <div class="metric-box">
                  <div class="metric-value">${(ticks.average_tick_time_ms || 0).toFixed(1)}ms</div>
                  <div class="metric-label">Avg Tick Time</div>
                </div>
                <div class="metric-box">
                  <div class="metric-value">${cpu.available_processors || '—'}</div>
                  <div class="metric-label">CPU Cores</div>
                </div>
              </div>
            `;
          }
        } catch (e) {
          console.warn('Failed to load MC performance data:', e);
          $('#mcPerformanceMetrics').innerHTML = '<div class="small muted">Failed to load performance data</div>';
        }
        
        // Load mod data with error handling
        try {
          const modData = await jget('/api/mc-data/mods');
          let modsHtml = `<div class="small muted">Total mods: ${modData?.total_mods || 0}</div>`;
          if (modData?.mods && modData.mods.length > 0) {
            modsHtml += '<div style="margin-top: 10px;">';
            modData.mods.slice(0, 5).forEach(mod => {
              modsHtml += `<div class="tag" style="margin: 2px;">${mod.name || mod.mod_id || 'Unknown'} ${mod.version || ''}</div>`;
            });
            if (modData.mods.length > 5) {
              modsHtml += `<div class="small muted" style="margin-top: 5px;">...and ${modData.mods.length - 5} more</div>`;
            }
            modsHtml += '</div>';
          }
          $('#mcModsList').innerHTML = modsHtml;
        } catch (e) {
          console.warn('Failed to load MC mod data:', e);
          $('#mcModsList').innerHTML = '<div class="small muted">Failed to load mod data</div>';
        }
        
        // Load world data with error handling
        try {
          const worldData = await jget('/api/mc-data/world');
          if (worldData?.worlds && worldData.worlds.length > 0) {
            const world = worldData.worlds[0];
            // Fix: API returns loaded_chunks and entities directly, not nested objects
            $('#mcLoadedChunks').textContent = world.loaded_chunks || '—';
            $('#mcTotalEntities').textContent = world.entities || '—';
            $('#mcGameRules').textContent = Object.keys(worldData.game_rules || {}).length;
          } else {
            $('#mcLoadedChunks').textContent = '—';
            $('#mcTotalEntities').textContent = '—';
            $('#mcGameRules').textContent = '—';
          }
        } catch (e) {
          console.warn('Failed to load MC world data:', e);
          $('#mcLoadedChunks').textContent = '—';
          $('#mcTotalEntities').textContent = '—';
          $('#mcGameRules').textContent = '—';
        }
        
        // Load security data with error handling
        try {
          const securityData = await jget('/api/mc-data/security');
          if (securityData) {
            $('#mcOperators').textContent = securityData.operators?.count || '—';
            $('#mcWhitelistEnabled').textContent = securityData.whitelist?.enabled ? 'Enabled' : 'Disabled';
            $('#mcBannedPlayers').textContent = securityData.banned_players?.count || '—';
            $('#mcBannedIPs').textContent = securityData.banned_ips?.count || '—';
          }
        } catch (e) {
          console.warn('Failed to load MC security data:', e);
          $('#mcOperators').textContent = '—';
          $('#mcWhitelistEnabled').textContent = '—';
          $('#mcBannedPlayers').textContent = '—';
          $('#mcBannedIPs').textContent = '—';
        }
        
      } catch (error) {
        console.error('Failed to load MC data:', error);
        $('#mcDataStatus').innerHTML = `
          <div class="tag danger">Disconnected</div>
          <div class="small muted">MC Data Collector is not available</div>
        `;
        
        // Reset all fields to fallback values
        $('#mcOnlinePlayers').textContent = '—';
        $('#mcTPS').textContent = '—';
        $('#mcMemoryUsage').textContent = '—';
        $('#mcWorldTime').textContent = '—';
        $('#mcWeather').textContent = '—';
        $('#mcIsDay').textContent = '—';
        $('#mcPlayersList').innerHTML = '<div class="small muted">Data not available</div>';
        $('#mcPerformanceMetrics').innerHTML = '<div class="small muted">Data not available</div>';
        $('#mcModsList').innerHTML = '<div class="small muted">Data not available</div>';
        $('#mcLoadedChunks').textContent = '—';
        $('#mcTotalEntities').textContent = '—';
        $('#mcGameRules').textContent = '—';
        $('#mcOperators').textContent = '—';
        $('#mcWhitelistEnabled').textContent = '—';
        $('#mcBannedPlayers').textContent = '—';
        $('#mcBannedIPs').textContent = '—';
      }
    }

    // Bans
    async function loadBans(){
      $('#banPlayers').innerHTML = '<div class="small muted">Loading…</div>';
      $('#banIps').innerHTML = '<div class="small muted">Loading…</div>';
      try{
        const data = await jget('/api/bans');
        if(data.players?.length){ $('#banPlayersEmpty').style.display = 'none';
          $('#banPlayers').innerHTML = data.players.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill player">Player</span><b>${x.username||x.target}</b></div>${x.uuid?`<span class="tag">${x.uuid.slice(0,8)}</span>`:''}</div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'—'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span>${x.last_ip?`<span class="pill">Last IP: ${x.last_ip}</span>`:''}${x.last_seen?`<span class="pill">Last Seen: ${fmtDate(x.last_seen)}</span>`:''}${x.playtime_seconds!=null?`<span class="pill">Playtime: ${fmtDur(x.playtime_seconds)}</span>`:''}</div></div>`).join('');
        }else{ $('#banPlayers').innerHTML = ''; $('#banPlayersEmpty').style.display = 'block'; }

        if(data.ips?.length){ $('#banIpsEmpty').style.display = 'none';
          $('#banIps').innerHTML = data.ips.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill ip">IP</span><b>${x.target}</b></div></div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'—'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span></div></div>`).join('');
        }else{ $('#banIps').innerHTML = ''; $('#banIpsEmpty').style.display = 'block'; }
      }catch{
        $('#banPlayers').innerHTML = '<div class="empty">Failed to load bans</div>'; $('#banIps').innerHTML = '';
      }
    }

    // Schedules
    async function loadSchedules(){
      const tbody = $('#schedTable tbody'); tbody.innerHTML = '<tr><td colspan="5" class="small">Loading…</td></tr>';
      try{
        const rows = await jget('/api/schedules');
        tbody.innerHTML = rows.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small"><code>${r.cron}</code></td><td><button class="btn ghost" onclick="toggleSchedule(${r.id})">${r.enabled?'✓ Enabled':'Disabled'}</button></td><td><button class="btn danger ghost" onclick="deleteSchedule(${r.id})">Delete</button></td></tr>`).join('') || '<tr><td colspan="5" class="small">No schedules</td></tr>';
      }catch{ tbody.innerHTML = '<tr><td colspan="5" class="small">Failed to load schedules</td></tr>'; }
    }
    async function toggleSchedule(id){
      try{ await jpost('/api/schedules/'+id+'/toggle'); loadSchedules(); toast('Schedule toggled'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteSchedule(id){
      if(!confirm('Delete this schedule?')) return;
      try{ await jdel('/api/schedules/'+id); loadSchedules(); toast('Schedule deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    $('#addSchedule').addEventListener('click', async ()=>{
      const cron = $('#cronExpr').value.trim(), label = $('#cronLabel').value.trim();
      if(!cron) return toast('Cron expression required');
      try{ await jpost('/api/schedules', {cron, label:label||null}); $('#cronExpr').value = ''; $('#cronLabel').value = ''; loadSchedules(); toast('Schedule added'); }catch(e){ toast('Failed: '+e.message); }
    });

    // Moderation
    async function loadModeration(){
      try{
        const [banPresets, kickPresets] = await Promise.all([
          jget('/api/ban-presets'),
          jget('/api/kick-presets')
        ]);
        
        // Populate ban presets dropdown
        $('#modBanSelect').innerHTML = '<option value="">Select ban reason…</option>' + 
          banPresets.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
        
        // Populate kick presets dropdown
        $('#modKickSelect').innerHTML = '<option value="">Select kick reason…</option>' + 
          kickPresets.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
      }catch(e){ 
        console.error('Failed to load moderation presets:', e); 
        $('#modBanSelect').innerHTML = '<option value="">Select ban reason…</option>';
        $('#modKickSelect').innerHTML = '<option value="">Select kick reason…</option>';
      }
    }

    // Presets
    async function loadSettings(){
      try{
        const [bc, ban, kick] = await Promise.all([
          jget('/api/broadcast-presets'), 
          jget('/api/ban-presets'),
          jget('/api/kick-presets')
        ]);
        
        // Broadcast presets table
        const bcRows = bc.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small">${escapeHtml(r.message||'')}</td><td><button class="btn danger ghost" onclick="deleteBcPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#bcTable tbody').innerHTML = bcRows || '<tr><td colspan="4" class="small">No presets</td></tr>';
        
        // Ban presets table
        const banRows = ban.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small">${escapeHtml(r.reason||'')}</td><td><button class="btn danger ghost" onclick="deleteBanPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#banTable tbody').innerHTML = banRows || '<tr><td colspan="4" class="small">No presets</td></tr>';
        
        // Kick presets table
        const kickRows = kick.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small">${escapeHtml(r.reason||'')}</td><td><button class="btn danger ghost" onclick="deleteKickPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#kickTable tbody').innerHTML = kickRows || '<tr><td colspan="4" class="small">No presets</td></tr>';

        // Update server controls broadcast preset dropdown
        const serverBcSelect = $('#serverBroadcastPreset');
        if (serverBcSelect) {
          serverBcSelect.innerHTML = '<option value="">Or select preset message...</option>' + bc.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
        }
      }catch(e){ console.error('Failed to load settings:', e); }
    }
    
    async function deleteBcPreset(id){
      if(!confirm('Delete this broadcast preset?')) return;
      try{ await jdel('/api/broadcast-presets/'+id); loadSettings(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteBanPreset(id){
      if(!confirm('Delete this ban preset?')) return;
      try{ await jdel('/api/ban-presets/'+id); loadSettings(); loadModeration(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteKickPreset(id){
      if(!confirm('Delete this kick preset?')) return;
      try{ await jdel('/api/kick-presets/'+id); loadSettings(); loadModeration(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    
    $('#bcAdd').addEventListener('click', async ()=>{
      const label = $('#bcLabel').value.trim(), message = $('#bcMessage').value.trim();
      if(!message) return toast('Message required');
      try{ await jpost('/api/broadcast-presets', {label:label||null, message}); $('#bcLabel').value = ''; $('#bcMessage').value = ''; loadSettings(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#banAdd').addEventListener('click', async ()=>{
      const label = $('#banLabel').value.trim(), reason = $('#banReason').value.trim();
      if(!reason) return toast('Reason required');
      try{ await jpost('/api/ban-presets', {label:label||null, reason}); $('#banLabel').value = ''; $('#banReason').value = ''; loadSettings(); loadModeration(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#kickAdd').addEventListener('click', async ()=>{
      const label = $('#kickLabel').value.trim(), reason = $('#kickReason').value.trim();
      if(!reason) return toast('Reason required');
      try{ await jpost('/api/kick-presets', {label:label||null, reason}); $('#kickLabel').value = ''; $('#kickReason').value = ''; loadSettings(); loadModeration(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    // System Monitoring
    async function loadSystemMonitoring() {
      try {
        const [fileStats, mcSecurityData] = await Promise.all([
          jget('/api/files/stats').catch(() => null),
          jget('/api/mc-data/security').catch(() => null)
        ]);
        
        // Prioritize MC data for security stats, fallback to file stats
        let statsHtml = '<div class="grid cols-2">';
        
        if (mcSecurityData) {
          statsHtml += `
            <div class="small">Banned Players: <b>${mcSecurityData.banned_players?.count || 0}</b></div>
            <div class="small">Banned IPs: <b>${mcSecurityData.banned_ips?.count || 0}</b></div>
            <div class="small">Whitelist: <b>${mcSecurityData.whitelist?.enabled ? 'Enabled' : 'Disabled'}</b></div>
            <div class="small">Operators: <b>${mcSecurityData.operators?.count || 0}</b></div>
            <div class="small">Data Source: <b>MC Data Collector</b></div>
            <div class="small">Active Watchers: <b>${fileStats?.active_watchers || 0}</b></div>
          `;
        } else if (fileStats) {
          statsHtml += `
            <div class="small">Banned Players: <b>${fileStats.banned_players || 0}</b></div>
            <div class="small">Banned IPs: <b>${fileStats.banned_ips || 0}</b></div>
            <div class="small">Whitelist: <b>${fileStats.whitelist || 0}</b></div>
            <div class="small">Operators: <b>${fileStats.operators || 0}</b></div>
            <div class="small">Server Settings: <b>${fileStats.server_settings || 0}</b></div>
            <div class="small">Active Watchers: <b>${fileStats.active_watchers || 0}</b></div>
          `;
        } else {
          statsHtml += '<div class="small">No file monitoring data available</div>';
        }
        
        statsHtml += '</div>';
        $('#fileMonitorStats').innerHTML = statsHtml;
        
        // Load system history chart
        loadSystemHistoryChart();
        
      } catch (e) {
        console.error('Failed to load system monitoring:', e);
        toast('Failed to load system monitoring data');
      }
    }

    async function loadSystemHistoryChart() {
      try {
        const history = await jget('/api/system/history?hours=24');
        
        const ctx = $('#systemChart').getContext('2d');
        
        if (systemChart) {
          systemChart.destroy();
        }
        
        systemChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: history.map(h => new Date(h.recorded_at).toLocaleTimeString()),
            datasets: [
              {
                label: 'CPU %',
                data: history.map(h => h.cpu_usage || 0),
                borderColor: '#7c5cff',
                backgroundColor: 'rgba(124, 92, 255, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Memory %',
                data: history.map(h => h.memory_usage || 0),
                borderColor: '#44d3a8',
                backgroundColor: 'rgba(68, 211, 168, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Disk %',
                data: history.map(h => h.disk_usage || 0),
                borderColor: '#ffb020',
                backgroundColor: 'rgba(255, 176, 32, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: 'Usage %' }
              }
            }
          }
        });
        
      } catch (e) {
        console.warn('Failed to load system history chart:', e);
        // Show fallback message in the chart container
        const ctx = $('#systemChart').getContext('2d');
        ctx.fillStyle = '#aab3c7';
        ctx.font = '14px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('System history unavailable', ctx.canvas.width / 2, ctx.canvas.height / 2);
      }
    }

    // Logout function
    async function logout() {
      try {
        await jpost('/logout');
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout failed:', error);
        // Even if logout fails, redirect to login
        window.location.href = '/login';
      }
    }

    // Audit
    async function loadAudit(){
      const tbody = $('#auditTable tbody'); tbody.innerHTML = '<tr><td colspan="3" class="small">Loading…</td></tr>';
      try{
        const rows = await jget('/api/audit');
        tbody.innerHTML = rows.map(r=>`<tr><td class="small">${fmtDate(r.created_at)}</td><td class="small"><code>${r.action}</code></td><td class="small">${escapeHtml(JSON.stringify(r.payload||{}))}</td></tr>`).join('') || '<tr><td colspan="3" class="small">No audit events</td></tr>';
      }catch{ tbody.innerHTML = '<tr><td colspan="3" class="small">Failed to load audit</td></tr>'; }
    }

    // Global refresh
    $('#refreshBtn').addEventListener('click', ()=>{
      loadStatus(); loadOnline();
      const active = $('.nav button.active').dataset.tab;
      if(active==='players') loadPlayers();
      if(active==='moderation') { loadModeration(); loadBans(); }
      if(active==='schedules') loadSchedules();
      if(active==='settings') loadSettings();
      if(active==='audit') loadAudit();
      if(active==='server-controls') loadServerControls();
    });

    // Logout button
    $('#logoutBtn').addEventListener('click', logout);

    // Server controls event listeners
    $('#startServerBtn').addEventListener('click', async () => {
      const message = $('#serverBroadcastMsg').value.trim();
      if (!confirm('Start the server?')) return;
      try {
        const result = await jpost('/api/server/start', { broadcastMessage: message || null });
        toast('Server start command sent');
        $('#serverBroadcastMsg').value = '';
        setTimeout(updateServerStatus, 3000); // Refresh status after delay
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    });

    $('#stopServerBtn').addEventListener('click', async () => {
      const message = $('#serverBroadcastMsg').value.trim();
      if (!confirm('Stop the server? This will disconnect all players.')) return;
      try {
        const result = await jpost('/api/server/stop', { broadcastMessage: message || null });
        toast('Server stop command sent');
        $('#serverBroadcastMsg').value = '';
        setTimeout(updateServerStatus, 3000); // Refresh status after delay
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    });

    $('#restartServerBtn').addEventListener('click', async () => {
      const message = $('#serverBroadcastMsg').value.trim();
      if (!confirm('Restart the server? This will temporarily disconnect all players.')) return;
      try {
        const result = await jpost('/api/server/restart', { broadcastMessage: message || null });
        toast('Server restart command sent');
        $('#serverBroadcastMsg').value = '';
        setTimeout(updateServerStatus, 5000); // Refresh status after delay
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    });

    $('#usePresetMsg').addEventListener('click', () => {
      const presetId = $('#serverBroadcastPreset').value;
      if (!presetId) return toast('Please select a preset first');
      
      // Find the preset message and populate the textarea
      jget('/api/broadcast-presets').then(presets => {
        const preset = presets.find(p => p.id == presetId);
        if (preset) {
          $('#serverBroadcastMsg').value = preset.message || '';
        }
      }).catch(e => toast('Failed to load preset'));
    });

    // Theme switcher
    $('#themeSelect').addEventListener('change', (e) => {
      const theme = e.target.value;
      if (theme === 'light') {
        document.body.classList.add('light-theme');
        localStorage.setItem('panel-theme', 'light');
      } else {
        document.body.classList.remove('light-theme');
        localStorage.setItem('panel-theme', 'dark');
      }
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('panel-theme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-theme');
      $('#themeSelect').value = 'light';
    }

    // Enhanced initialization with proper DOM ready handling
    function initializeApp() {
      // Ensure DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
        return;
      }
      
      console.log('[panel] Initializing application...');
      
      // Initialize tabs with retry mechanism
      initializeTabs();
      
      // Start data loading
      setTimeout(() => {
        loadStatus(); loadOnline(true);
        setInterval(()=>{ loadStatus(); loadOnline(true); }, 30000); // Refresh every 30s
      }, 1000);
      
      console.log('[panel] Application initialized successfully');
    }
    
    // Start initialization
    initializeApp();
  </script>
</body>
</html>

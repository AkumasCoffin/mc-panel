<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minecraft WebGUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    [hidden]{display:none !important;}
    :root{
      --bg:#0f1115; --panel:#151823; --muted:#8b90a3; --text:#e6e9ef;
      --brand:#7c5cff; --brand-2:#44d3a8; --warn:#ffb020; --danger:#ff5d5d;
      --border:#212535; --chip:#1b2030;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0f1115,#0d0f14); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Inter,Arial,sans-serif;}
    a{color:inherit; text-decoration:none}
    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .side{position:sticky; top:0; height:100vh; padding:18px; border-right:1px solid var(--border); background:rgba(13,16,22,.65); backdrop-filter: blur(8px); display:flex; flex-direction:column; gap:14px;}
    .brand{display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background:linear-gradient(90deg,rgba(124,92,255,.15),rgba(68,211,168,.08)); border:1px solid var(--border);}
    .brand svg{width:22px; height:22px}
    .brand h1{font-size:16px; margin:0}
    .nav{display:flex; flex-direction:column; gap:6px; margin-top:8px}
    .nav button{display:flex; align-items:center; gap:10px; width:100%; background:transparent; color:var(--text); border:1px solid transparent; padding:10px 12px; border-radius:10px; cursor:pointer; text-align:left; transition:.15s;}
    .nav button:hover{background:var(--chip); border-color:var(--border)}
    .nav button.active{background:linear-gradient(90deg,rgba(124,92,255,.18),rgba(68,211,168,.12)); border-color:#2a2f44}
    .nav svg{width:16px;height:16px; opacity:.9}
    .side .foot{margin-top:auto; color:var(--muted); font-size:12px; opacity:.8}
    .main{padding:22px;}
    .toolbar{display:flex; align-items:center; gap:10px; margin-bottom:16px}
    .toolbar .chip{padding:6px 10px; background:var(--chip); border:1px solid var(--border); border-radius:999px; color:#cdd3e1}
    .cards{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:14px; grid-column: span 12;}
    @media (min-width: 900px){ .card.half{grid-column: span 6} .card.third{grid-column: span 4} .card.two{grid-column: span 8}}
    .card h3{margin:0 0 10px 0; font-size:15px}
    .muted{color:var(--muted)}
    .split{display:flex; gap:8px; flex-wrap:wrap}
    input[type=text], textarea, select{background:#0d111a; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; width:100%;}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .btn{background:#1a1f2e; color:#dfe6f3; border:1px solid var(--border); border-radius:10px; padding:10px 12px; cursor:pointer; transition:.15s;}
    .btn:hover{filter:brightness(1.1)}
    .btn.brand{background:linear-gradient(90deg,rgba(124,92,255,.25),rgba(68,211,168,.18)); border-color:#2a2f44}
    .btn.warn{background:rgba(255,176,32,.12); border-color:#4b3b1a}
    .btn.danger{background:rgba(255,93,93,.12); border-color:#4b1a1a}
    .btn.ghost{background:transparent}
    .tag{background:#0e1220; border:1px solid var(--border); color:#cdd3e1; padding:4px 8px; border-radius:999px; font-size:12px}
    .grid{display:grid; gap:10px}
    .grid.cols-2{grid-template-columns: repeat(2, 1fr)}
    .grid.cols-3{grid-template-columns: repeat(3, 1fr)}
    .grid.cols-4{grid-template-columns: repeat(4, 1fr)}
    @media (max-width: 900px){ .grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border-bottom:1px dashed #23283a; text-align:left}
    th{color:#aab3c7; font-weight:600; background:#121624; position:sticky; top:0}
    tr:hover td{background:#111522}
    .ban-card{display:flex; flex-direction:column; gap:8px; padding:12px; border:1px solid var(--border); border-radius:14px; background:#121627;}
    .ban-card .head{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .ban-card .who{display:flex; align-items:center; gap:8px}
    .pill{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .pill.player{background:rgba(124,92,255,.15)}
    .pill.ip{background:rgba(68,211,168,.15)}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50; padding:20px;}
    .modal.open{display:flex}
    .modal .sheet{width:min(980px,100%); max-height:90vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 10px 40px rgba(0,0,0,.5);}
    .toast{position:fixed; right:16px; bottom:16px; background:#121827; border:1px solid var(--border); color:#e8eefc; padding:10px 12px; border-radius:10px; z-index:60; display:none;}
    .toast.show{display:block; animation:fade 2.2s ease}
    @keyframes fade{0%{opacity:0; transform:translateY(8px)} 10%{opacity:1; transform:none} 80%{opacity:1} 100%{opacity:0}}
    .small{font-size:12px; color:#aab3c7}
    .right{margin-left:auto}
    .center{display:flex; justify-content:center; align-items:center}
    .empty{padding:18px; border:1px dashed #2b3147; border-radius:12px; color:#aab3c7; background:#0f1320}
    
    /* Chart containers */
    .chart-container{position:relative; height:200px; margin:10px 0}
    .chart-container canvas{background:rgba(15,17,21,0.5); border-radius:12px}
    .metric-box{background:linear-gradient(135deg,#151823,#1a1f2e); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center}
    .metric-value{font-size:24px; font-weight:bold; color:var(--brand)}
    .metric-label{font-size:12px; color:var(--muted); margin-top:4px}
    .status-indicator{display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px}
    .status-indicator.good{background:#44d3a8}
    .status-indicator.warning{background:#ffb020}
    .status-indicator.critical{background:#ff5d5d}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // Simple fallback for Chart.js - create a mock Chart object to prevent errors
    if (typeof Chart === 'undefined') {
      window.Chart = function(ctx, config) {
        // Mock Chart constructor
        this.destroy = function() {};
        this.update = function() {};
        this.resize = function() {};
        return this;
      };
      
      // Chart.js defaults
      window.Chart.defaults = {
        color: '#aab3c7',
        backgroundColor: 'rgba(124, 92, 255, 0.1)',
        borderColor: '#7c5cff',
        plugins: { legend: { labels: { color: '#aab3c7' } } },
        scales: {
          linear: { grid: { color: 'rgba(171, 179, 199, 0.1)' }, ticks: { color: '#aab3c7' } },
          category: { grid: { color: 'rgba(171, 179, 199, 0.1)' }, ticks: { color: '#aab3c7' } }
        }
      };
      
      console.warn('Chart.js not available - using fallback (charts disabled)');
    }
  </script>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12l7-9 7 9-7 9-7-9z" stroke-width="1.5"/><path d="M3 12h18" stroke-width="1.5"/></svg>
        <h1>MC Panel</h1>
        <span class="right chip">Forge 1.20.1</span>
      </div>
      <div class="nav">
        <button data-tab="status" class="active"><svg viewBox="0 0 24 24"><path d="M3 12h6v9H3zM9 3h6v18H9zM15 8h6v13h-6z" fill="currentColor"/></svg>Dashboard</button>
        <button data-tab="analytics"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm5 10a5 5 0 01-8.536 3.536L15.536 8.464A4.982 4.982 0 0117 12zm-10 0a5 5 0 018.536-3.536L8.464 15.536A4.982 4.982 0 017 12z" fill="currentColor"/></svg>Analytics</button>
        <button data-tab="monitoring"><svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m0 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>System Monitor</button>
        <button data-tab="online"><svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-9 9a9 9 0 1118 0H3z" fill="currentColor"/></svg>Online <span class="right tag" id="onlineCount">0</span></button>
        <button data-tab="players"><svg viewBox="0 0 24 24"><path d="M16 13a4 4 0 10-8 0 7 7 0 00-7 7h22a7 7 0 00-7-7z" fill="currentColor"/></svg>Players</button>
        <button data-tab="bans"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm5 10a5 5 0 01-8.536 3.536L15.536 8.464A4.982 4.982 0 0117 12zm-10 0a5 5 0 018.536-3.536L8.464 15.536A4.982 4.982 0 017 12z" fill="currentColor"/></svg>Bans</button>
        <button data-tab="moderation"><svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>Moderation</button>
        <button data-tab="schedules"><svg viewBox="0 0 24 24"><path d="M7 2v3M17 2v3M3 9h18M5 5h14a2 2 0 012 2v13H3V7a2 2 0 012-2z" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Scheduled Restarts</button>
        <button data-tab="presets"><svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h10M4 17h7" stroke="currentColor" fill="none" stroke-width="1.4"/></svg>Presets</button>
        <button data-tab="audit"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4zM8 8h8M8 12h8M8 16h5" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Audit / Commands</button>
      </div>
      <div class="foot small">
        <div id="statusChip">Status: <span class="tag">loadingâ€¦</span></div>
        <div style="margin-top:6px">Next restart: <span id="nextRestart" class="tag">â€”</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <div class="chip">Session authenticated</div>
        <div id="tip" class="chip">Tip: click a player to open details</div>
        <button class="btn ghost" id="logoutBtn">Logout</button>
        <button class="btn ghost right" id="refreshBtn">â†» Refresh</button>
      </div>

      <!-- STATUS -->
      <div id="tab-status" class="cards">
        <section class="card third">
          <h3>Server Status</h3>
          <div id="statusBox" class="empty">Checkingâ€¦</div>
        </section>

        <section class="card third">
          <h3>Next Restart</h3>
          <div id="restartBox" class="empty">
            <div>Next Restart</div>
            <div class="row" style="margin-top:8px">
              <div><span class="tag" id="nextRestart2">â€”</span></div>
              <div><span class="tag" id="nextRestartIn">â€”</span></div>
            </div>
            <div class="small" style="margin-top:8px">Configured in <b>Scheduled Restarts</b>.</div>
          </div>
        </section>

        <section class="card third">
          <h3>Quick Stats</h3>
          <div id="quickStats" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="totalPlayers">â€”</div>
              <div class="metric-label">Total Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="onlineNow">â€”</div>
              <div class="metric-label">Online Now</div>
            </div>
          </div>
        </section>

        <section class="card half">
          <h3>Online Players</h3>
          <div id="onlineList" class="grid cols-2"></div>
          <div id="onlineEmpty" class="empty" style="display:none">No one online.</div>
        </section>

        <section class="card half">
          <h3>Player Activity (7 days)</h3>
          <div class="chart-container">
            <canvas id="playerTrendChart"></canvas>
          </div>
        </section>

        <section class="card">
          <h3>Quick Command</h3>
          <div class="row">
            <input id="cmdInput" type="text" value="list" />
            <button class="btn brand" id="sendCmd">Run</button>
          </div>
          <pre id="cmdOut" class="small" style="margin-top:10px; white-space:pre-wrap; background:#0e1220; border:1px solid var(--border); padding:10px; border-radius:10px; min-height:40px"></pre>
          <div class="small muted" id="rconNote" style="margin-top:8px"></div>
        </section>

        <section class="card">
          <h3>Recent Activity</h3>
          <div id="recentActivity" style="max-height:200px; overflow-y:auto"></div>
        </section>
      </div>

      <!-- ONLINE -->
      <div id="tab-online" class="cards" hidden>
        <section class="card">
          <h3>Online Players</h3>
          <div id="onlineList2" class="grid cols-3"></div>
          <div id="onlineEmpty2" class="empty" style="display:none">No one online.</div>
        </section>
      </div>

      <!-- ANALYTICS -->
      <div id="tab-analytics" class="cards" hidden>
        <section class="card third">
          <h3>Today's Stats</h3>
          <div id="todayStats" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="todayPlayers">â€”</div>
              <div class="metric-label">Unique Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="todaySessions">â€”</div>
              <div class="metric-label">Sessions</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="todayPeak">â€”</div>
              <div class="metric-label">Peak Online</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="avgSession">â€”</div>
              <div class="metric-label">Avg Session (min)</div>
            </div>
          </div>
        </section>

        <section class="card two">
          <h3>Player Activity Trend</h3>
          <div class="chart-container" style="height:250px">
            <canvas id="analyticsPlayerChart"></canvas>
          </div>
        </section>

        <section class="card half">
          <h3>Top Players by Playtime</h3>
          <div id="topPlayersList" style="max-height:300px; overflow-y:auto"></div>
        </section>

        <section class="card half">
          <h3>Session Length Distribution</h3>
          <div class="chart-container">
            <canvas id="sessionDistChart"></canvas>
          </div>
        </section>

        <section class="card">
          <h3>Hourly Activity Pattern</h3>
          <div class="chart-container" style="height:250px">
            <canvas id="hourlyActivityChart"></canvas>
          </div>
        </section>

        <section class="card">
          <h3>Command Usage</h3>
          <div id="commandStats" style="max-height:300px; overflow-y:auto"></div>
        </section>
      </div>

      <!-- SYSTEM MONITORING -->
      <div id="tab-monitoring" class="cards" hidden>
        <section class="card third">
          <h3>System Overview</h3>
          <div id="systemStatus" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="cpuUsage">â€”</div>
              <div class="metric-label">CPU Usage</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="memoryUsage">â€”</div>
              <div class="metric-label">Memory Usage</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="diskUsage">â€”</div>
              <div class="metric-label">Disk Usage</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="systemUptime">â€”</div>
              <div class="metric-label">Uptime (hours)</div>
            </div>
          </div>
        </section>

        <section class="card two">
          <h3>System Performance (24h)</h3>
          <div class="chart-container" style="height:250px">
            <canvas id="systemChart"></canvas>
          </div>
        </section>

        <section class="card third">
          <h3>Network Activity</h3>
          <div id="networkStats" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="networkRx">â€”</div>
              <div class="metric-label">RX Rate (KB/s)</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="networkTx">â€”</div>
              <div class="metric-label">TX Rate (KB/s)</div>
            </div>
          </div>
        </section>

        <section class="card third">
          <h3>Load Average</h3>
          <div id="loadStats" class="grid cols-3">
            <div class="metric-box">
              <div class="metric-value" id="load1">â€”</div>
              <div class="metric-label">1 min</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="load5">â€”</div>
              <div class="metric-label">5 min</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="load15">â€”</div>
              <div class="metric-label">15 min</div>
            </div>
          </div>
        </section>

        <section class="card two">
          <h3>File Monitoring</h3>
          <div id="fileMonitorStats"></div>
        </section>
      </div>

      <!-- PLAYERS -->
      <div id="tab-players" class="cards" hidden>
        <section class="card">
          <h3>All Players</h3>
          <div class="row" style="margin-bottom:8px">
            <input id="playerSearch" type="text" placeholder="Search usernameâ€¦" />
            <div class="chip" id="playerCountChip">0 players</div>
          </div>
          <div style="overflow:auto; max-height:70vh">
            <table id="playersTable">
              <thead><tr><th>User</th><th>UUID</th><th>Last IP</th><th>First Seen</th><th>Last Seen</th><th>Playtime</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- BANS -->
      <div id="tab-bans" class="cards" hidden>
        <section class="card two">
          <h3>Banned Players</h3>
          <div id="banPlayers" class="grid cols-2"></div>
          <div id="banPlayersEmpty" class="empty" style="display:none">No player bans found.</div>
        </section>
        <section class="card third">
          <h3>Banned IPs</h3>
          <div id="banIps" class="grid"></div>
          <div id="banIpsEmpty" class="empty" style="display:none">No IP bans found.</div>
        </section>
      </div>

      <!-- MODERATION -->
      <div id="tab-moderation" class="cards" hidden>
        <section class="card half">
          <h3>Ban Player</h3>
          <div class="row" style="margin-bottom:10px">
            <input id="modBanUser" type="text" placeholder="Username to ban" />
            <select id="modBanSelect"><option value="">Select ban reasonâ€¦</option></select>
            <button class="btn danger" id="modBanSend">Ban Player</button>
          </div>
          <div class="small muted">Requires RCON. Command: <code>ban &lt;user&gt; &lt;reason&gt;</code></div>
        </section>
        <section class="card half">
          <h3>Kick Player</h3>
          <div class="row" style="margin-bottom:10px">
            <input id="modKickUser" type="text" placeholder="Username to kick" />
            <select id="modKickSelect"><option value="">Select kick reasonâ€¦</option></select>
            <button class="btn warn" id="modKickSend">Kick Player</button>
          </div>
          <div class="small muted">Requires RCON. Command: <code>kick &lt;user&gt; &lt;reason&gt;</code></div>
        </section>
      </div>

      <!-- SCHEDULES -->
      <div id="tab-schedules" class="cards" hidden>
        <section class="card">
          <h3>Add Schedule</h3>
          <div class="row">
            <input id="cronExpr" type="text" placeholder="Cron (e.g. 0 */6 * * *)" />
            <input id="cronLabel" type="text" placeholder="Optional label" />
            <button class="btn brand" id="addSchedule">Add</button>
          </div>
          <div class="small" style="margin-top:6px">
            Tips:
            <span class="tag">0 3 * * *</span> daily 03:00 Â·
            <span class="tag">0 */6 * * *</span> every 6h Â·
            <span class="tag">*/30 * * * *</span> every 30m
          </div>
        </section>
        <section class="card">
          <h3>Schedules</h3>
          <div style="overflow:auto; max-height:60vh">
            <table id="schedTable">
              <thead><tr><th>ID</th><th>Label</th><th>Cron</th><th>Enabled</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- PRESETS -->
      <div id="tab-presets" class="cards" hidden>
        <section class="card third">
          <h3>Broadcast Presets</h3>
          <div class="row">
            <input id="bcLabel" type="text" placeholder="Label (optional)" />
            <input id="bcMessage" type="text" placeholder="Message" />
            <button class="btn brand" id="bcAdd">Save</button>
          </div>
          <div style="overflow:auto; max-height:50vh">
            <table id="bcTable"><thead><tr><th>ID</th><th>Label</th><th>Message</th><th></th></tr></thead><tbody></tbody></table>
          </div>
          <div class="row" style="margin-top:10px">
            <select id="bcSelect"><option value="">Select presetâ€¦</option></select>
            <button class="btn" id="bcSend">Send Broadcast</button>
          </div>
        </section>
        <section class="card third">
          <h3>Ban Presets</h3>
          <div class="row">
            <input id="banLabel" type="text" placeholder="Label (optional)" />
            <input id="banReason" type="text" placeholder="Reason" />
            <button class="btn brand" id="banAdd">Save</button>
          </div>
          <div style="overflow:auto; max-height:50vh">
            <table id="banTable"><thead><tr><th>ID</th><th>Label</th><th>Reason</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </section>
        <section class="card third">
          <h3>Kick Presets</h3>
          <div class="row">
            <input id="kickLabel" type="text" placeholder="Label (optional)" />
            <input id="kickReason" type="text" placeholder="Reason" />
            <button class="btn brand" id="kickAdd">Save</button>
          </div>
          <div style="overflow:auto; max-height:50vh">
            <table id="kickTable"><thead><tr><th>ID</th><th>Label</th><th>Reason</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </section>
      </div>

      <!-- AUDIT -->
      <div id="tab-audit" class="cards" hidden>
        <section class="card">
          <h3>Recent Audit Events</h3>
          <div style="overflow:auto; max-height:70vh">
            <table id="auditTable">
              <thead><tr><th>When</th><th>Action</th><th>Payload</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Player Modal -->
  <div class="modal" id="playerModal">
    <div class="sheet">
      <div class="row" style="align-items:center">
        <h3 id="pmTitle" style="margin:0">Player</h3>
        <button class="btn right" onclick="closePlayerModal()">Close</button>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="card">
          <h3>Profile</h3>
          <div class="small"><b>UUID:</b> <span id="pmUuid">â€”</span></div>
          <div class="small"><b>Last IP:</b> <span id="pmLastIp">â€”</span></div>
          <div class="small"><b>First Seen:</b> <span id="pmFirst">â€”</span></div>
          <div class="small"><b>Last Seen:</b> <span id="pmLast">â€”</span></div>
          <div class="small"><b>Total Playtime:</b> <span id="pmPlaytime">â€”</span></div>
        </div>
        <div class="card two">
          <h3>Sessions</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmSessions"><thead><tr><th>Login</th><th>Logout</th><th>Duration</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card two">
          <h3>Commands</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmCommands"><thead><tr><th>When</th><th>Command</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>IPs Seen</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmIps"><thead><tr><th>IP</th><th>When</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved.</div>

  <script>
    // Defensive: ensure only Dashboard is visible at boot, in case of cachey CSS
    ['online','players','bans','moderation','schedules','presets','audit','analytics','monitoring']
      .forEach(t => { const el = document.getElementById('tab-'+t); if (el) el.hidden = true; });
    document.getElementById('tab-status').hidden = false;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function toast(msg='Saved.') { const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }
    function fmtDate(s){ if(!s) return 'â€”'; const d = new Date(s); if (isNaN(d)) return s; return d.toLocaleString(); }
    function fmtDur(sec){ if(sec==null) return 'â€”'; sec = Math.max(0, +sec|0); const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60; const parts = []; if(h) parts.push(h+'h'); if(m||h) parts.push((h?String(m).padStart(2,'0'):m)+'m'); parts.push(String(s).padStart(2,'0')+'s'); return parts.join(' '); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Chart.js defaults for dark theme (only if Chart.js loaded)
    if (typeof Chart !== 'undefined') {
      Chart.defaults.color = '#aab3c7';
      Chart.defaults.backgroundColor = 'rgba(124, 92, 255, 0.1)';
      Chart.defaults.borderColor = '#7c5cff';
      Chart.defaults.plugins.legend.labels.color = '#aab3c7';
      Chart.defaults.scales.linear.grid.color = 'rgba(171, 179, 199, 0.1)';
      Chart.defaults.scales.linear.ticks.color = '#aab3c7';
      Chart.defaults.scales.category.grid.color = 'rgba(171, 179, 199, 0.1)';
      Chart.defaults.scales.category.ticks.color = '#aab3c7';
    } else {
      console.warn('Chart.js not available - chart functionality will be disabled');
    }

    // Chart instances
    let playerTrendChart = null;
    let analyticsPlayerChart = null;
    let sessionDistChart = null;
    let hourlyActivityChart = null;
    let systemChart = null;

    // Authentication handling - session-based (no more hardcoded auth headers)
    
    // Simple fetch functions with session-based authentication
    async function jget(url){ 
      const r = await fetch(url, { credentials: 'same-origin' }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }
    async function jpost(url,data){ 
      const r = await fetch(url,{
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body:JSON.stringify(data||{}),
        credentials: 'same-origin'
      }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }
    async function jdel(url){ 
      const r = await fetch(url,{
        method:'DELETE',
        credentials: 'same-origin'
      }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }

    // Tabs - with defensive initialization to handle timing issues
    function initializeTabs() {
      const tabBtns = $$('.nav button');
      
      // Check if tab buttons are available
      if (tabBtns.length === 0) {
        console.warn('[panel] Tab buttons not found, retrying in 100ms...');
        setTimeout(initializeTabs, 100);
        return;
      }
      
      console.log(`[panel] Initializing ${tabBtns.length} tab buttons`);
      
      tabBtns.forEach(btn => {
        // Remove any existing listeners to prevent duplicates
        btn.removeEventListener('click', btn._tabClickHandler);
        
        // Create and store the click handler
        btn._tabClickHandler = () => {
          tabBtns.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const t = btn.dataset.tab;
          $$('#tab-status,#tab-online,#tab-players,#tab-bans,#tab-moderation,#tab-schedules,#tab-presets,#tab-audit,#tab-analytics,#tab-monitoring').forEach(x=>x.hidden = true);
          const targetTab = $('#tab-'+t);
          if (targetTab) {
            targetTab.hidden = false;
          } else {
            console.warn(`[panel] Tab content not found: tab-${t}`);
          }
          
          // Load tab-specific data
          if (t==='online'){ loadOnline(true); }
          if (t==='players'){ loadPlayers(); }
          if (t==='bans'){ loadBans(); }
          if (t==='moderation'){ loadModeration(); }
          if (t==='schedules'){ loadSchedules(); }
          if (t==='presets'){ loadPresets(); }
          if (t==='audit'){ loadAudit(); }
          if (t==='analytics'){ loadAnalytics(); }
          if (t==='monitoring'){ loadSystemMonitoring(); }
        };
        
        btn.addEventListener('click', btn._tabClickHandler);
      });
    }
    
    // Initialize tabs immediately and also retry if needed
    initializeTabs();

    // Status with enhanced dashboard data
    async function loadStatus(){
      try{
        const [status, dashboardData] = await Promise.all([
          jget('/api/status'),
          jget('/api/analytics/dashboard').catch(() => null)
        ]);
        
        $('#statusChip').innerHTML = 'Status: <span class="tag">online</span>' + (status.rcon? ' <span class="tag">RCON</span>' : ' <span class="tag">no RCON</span>');
        $('#rconNote').textContent = status.rcon ? 'RCON enabled.' : 'RCON disabled; only "list" is emulated.';
        $('#nextRestart').textContent = status.next_restart_iso ? fmtDate(status.next_restart_iso) : 'â€”';
        $('#nextRestart2').textContent = $('#nextRestart').textContent;
        $('#nextRestartIn').textContent = status.next_restart_seconds!=null ? (Math.floor(status.next_restart_seconds/60)+' min') : 'â€”';
        $('#statusBox').innerHTML = `<div class="row"><div><span class="tag">Panel OK</span></div><div><span class="tag">Auth: Session</span></div></div><div class="small muted" style="margin-top:8px">Live log tracking enabled.</div>`;
        
        // Update quick stats if available
        if (dashboardData && dashboardData.current_stats) {
          const stats = dashboardData.current_stats;
          $('#totalPlayers').textContent = stats.total_players || '0';
          $('#onlineNow').textContent = stats.online_players || '0';
          
          // Update recent activity
          if (dashboardData.recent_activity) {
            const activities = dashboardData.recent_activity.slice(0, 5).map(act => {
              const icon = act.type === 'join' ? 'ðŸŸ¢' : 'ðŸ”´';
              const time = new Date(act.timestamp).toLocaleTimeString();
              return `<div class="small" style="margin-bottom:4px">${icon} ${act.username} ${act.type === 'join' ? 'joined' : 'left'} at ${time}</div>`;
            }).join('');
            $('#recentActivity').innerHTML = activities || '<div class="empty">No recent activity</div>';
          }
          
          // Update player trend chart on dashboard
          if (dashboardData.player_trend && dashboardData.player_trend.length > 0) {
            updatePlayerTrendChart(dashboardData.player_trend);
          }
        }
      }catch(e){
        $('#statusChip').innerHTML = 'Status: <span class="tag">error</span>';
        $('#statusBox').innerHTML = '<div class="empty">Could not load /api/status</div>';
      }
    }

    // Update player trend chart (small version for dashboard)
    function updatePlayerTrendChart(data) {
      if (typeof Chart === 'undefined') {
        $('#playerTrendChart').parentElement.innerHTML = '<div class="empty">Chart.js not available - charts disabled</div>';
        return;
      }
      
      const ctx = $('#playerTrendChart').getContext('2d');
      
      if (playerTrendChart) {
        playerTrendChart.destroy();
      }
      
      playerTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [{
            label: 'Unique Players',
            data: data.map(d => d.unique_players),
            borderColor: '#7c5cff',
            backgroundColor: 'rgba(124, 92, 255, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: { color: 'rgba(171, 179, 199, 0.1)' }
            },
            x: { 
              grid: { color: 'rgba(171, 179, 199, 0.1)' }
            }
          }
        }
      });
    }
    async function runList(){
      $('#cmdOut').textContent = 'Runningâ€¦';
      try{
        const out = await jpost('/api/command',{command: $('#cmdInput').value.trim() || 'list'});
        $('#cmdOut').textContent = out.out || JSON.stringify(out,null,2);
      }catch(e){ $('#cmdOut').textContent = e.message || 'Error'; }
    }
    $('#sendCmd').addEventListener('click', runList);

    // Online
    async function loadOnline(copyToStatus=false){
      try{
        const data = await jget('/api/online');
        $('#onlineCount').textContent = data.count ?? 0;
        const target1 = $('#onlineList'), target2 = $('#onlineList2');
        const empty1 = $('#onlineEmpty'), empty2 = $('#onlineEmpty2');
        const makeChip = (p)=>`<button class="btn" onclick="openPlayerByName('${p.username}')">${p.username}${p.uuid?` <span class='tag'>${p.uuid.slice(0,8)}</span>`:''}</button>`;
        target1.innerHTML = data.players.map(makeChip).join('');
        target2.innerHTML = data.players.map(makeChip).join('');
        empty1.style.display = data.players.length? 'none':'block';
        empty2.style.display = data.players.length? 'none':'block';
        if(copyToStatus){ $('#onlineList').innerHTML = target1.innerHTML; $('#onlineEmpty').style.display = empty1.style.display; }
      }catch{ $('#onlineCount').textContent = 'â€”'; }
    }

    // Players
    let playersCache = [];
    async function loadPlayers(){
      const tbody = $('#playersTable tbody'); tbody.innerHTML = '<tr><td colspan="6" class="small">Loadingâ€¦</td></tr>';
      try{
        const data = await jget('/api/players'); playersCache = data; redrawPlayers();
      }catch{ tbody.innerHTML = '<tr><td colspan="6" class="small">Failed to load players</td></tr>'; }
    }
    function redrawPlayers(){
      const q = ($('#playerSearch').value||'').toLowerCase();
      const rows = playersCache.filter(p=>p.username.toLowerCase().includes(q)).map(p=>`<tr onclick="openPlayer(${p.id})" style="cursor:pointer">
          <td>${p.username}</td><td class="small">${p.uuid??'â€”'}</td><td class="small">${p.last_ip??'â€”'}</td>
          <td class="small">${fmtDate(p.first_seen)}</td><td class="small">${fmtDate(p.last_seen)}</td><td>${fmtDur(p.total_playtime)}</td>
        </tr>`);
      $('#playersTable tbody').innerHTML = rows.join('') || `<tr><td colspan="6" class="small">No players</td></tr>`;
      $('#playerCountChip').textContent = `${playersCache.length} players`;
    }
    $('#playerSearch').addEventListener('input', redrawPlayers);

    // Player modal
    function closePlayerModal(){ $('#playerModal').classList.remove('open'); }
    async function openPlayer(id){
      try{
        const d = await jget('/api/player/'+id);
        $('#pmTitle').textContent = d.player.username;
        $('#pmUuid').textContent = d.player.uuid || 'â€”';
        $('#pmLastIp').textContent = d.player.last_ip || 'â€”';
        $('#pmFirst').textContent = fmtDate(d.player.first_seen);
        $('#pmLast').textContent = fmtDate(d.player.last_seen);
        $('#pmPlaytime').textContent = fmtDur(d.player.total_playtime);

        const sBody = d.sessions.map(s=>`<tr><td class="small">${fmtDate(s.login_time)}</td><td class="small">${fmtDate(s.logout_time)}</td><td>${fmtDur(s.duration)}</td></tr>`).join('');
        $('#pmSessions tbody').innerHTML = sBody || '<tr><td colspan="3" class="small">No sessions</td></tr>';

        const cBody = d.commands.map(c=>`<tr><td class="small">${fmtDate(c.executed_at)}</td><td class="small"><code>${escapeHtml(c.command)}</code></td></tr>`).join('');
        $('#pmCommands tbody').innerHTML = cBody || '<tr><td colspan="2" class="small">No commands</td></tr>';

        const iBody = d.ips.map(i=>`<tr><td>${i.ip}</td><td class="small">${fmtDate(i.seen_at)}</td></tr>`).join('');
        $('#pmIps tbody').innerHTML = iBody || '<tr><td colspan="2" class="small">No IPs</td></tr>';

        $('#playerModal').classList.add('open');
      }catch{ toast('Failed to load player'); }
    }
    function openPlayerByName(name){
      const p = playersCache.find(x=>x.username===name);
      if(p) return openPlayer(p.id);
      loadPlayers().then(()=>{ const p2 = playersCache.find(x=>x.username===name); if(p2) openPlayer(p2.id); });
    }
    $('#playerModal').addEventListener('click', (e)=>{ if(e.target.id==='playerModal') closePlayerModal(); });

    // Bans
    async function loadBans(){
      $('#banPlayers').innerHTML = '<div class="small muted">Loadingâ€¦</div>';
      $('#banIps').innerHTML = '<div class="small muted">Loadingâ€¦</div>';
      try{
        const data = await jget('/api/bans');
        if(data.players?.length){ $('#banPlayersEmpty').style.display = 'none';
          $('#banPlayers').innerHTML = data.players.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill player">Player</span><b>${x.username||x.target}</b></div>${x.uuid?`<span class="tag">${x.uuid.slice(0,8)}</span>`:''}</div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'â€”'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span>${x.last_ip?`<span class="pill">Last IP: ${x.last_ip}</span>`:''}${x.last_seen?`<span class="pill">Last Seen: ${fmtDate(x.last_seen)}</span>`:''}${x.playtime_seconds!=null?`<span class="pill">Playtime: ${fmtDur(x.playtime_seconds)}</span>`:''}</div></div>`).join('');
        }else{ $('#banPlayers').innerHTML = ''; $('#banPlayersEmpty').style.display = 'block'; }

        if(data.ips?.length){ $('#banIpsEmpty').style.display = 'none';
          $('#banIps').innerHTML = data.ips.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill ip">IP</span><b>${x.target}</b></div></div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'â€”'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span></div></div>`).join('');
        }else{ $('#banIps').innerHTML = ''; $('#banIpsEmpty').style.display = 'block'; }
      }catch{
        $('#banPlayers').innerHTML = '<div class="empty">Failed to load bans</div>'; $('#banIps').innerHTML = '';
      }
    }

    // Schedules
    async function loadSchedules(){
      const tbody = $('#schedTable tbody'); tbody.innerHTML = '<tr><td colspan="5" class="small">Loadingâ€¦</td></tr>';
      try{
        const rows = await jget('/api/schedules');
        tbody.innerHTML = rows.map(r=>`<tr><td>${r.id}</td><td>${r.label||'â€”'}</td><td class="small"><code>${r.cron}</code></td><td><button class="btn ghost" onclick="toggleSchedule(${r.id})">${r.enabled?'âœ“ Enabled':'Disabled'}</button></td><td><button class="btn danger ghost" onclick="deleteSchedule(${r.id})">Delete</button></td></tr>`).join('') || '<tr><td colspan="5" class="small">No schedules</td></tr>';
      }catch{ tbody.innerHTML = '<tr><td colspan="5" class="small">Failed to load schedules</td></tr>'; }
    }
    async function toggleSchedule(id){
      try{ await jpost('/api/schedules/'+id+'/toggle'); loadSchedules(); toast('Schedule toggled'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteSchedule(id){
      if(!confirm('Delete this schedule?')) return;
      try{ await jdel('/api/schedules/'+id); loadSchedules(); toast('Schedule deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    $('#addSchedule').addEventListener('click', async ()=>{
      const cron = $('#cronExpr').value.trim(), label = $('#cronLabel').value.trim();
      if(!cron) return toast('Cron expression required');
      try{ await jpost('/api/schedules', {cron, label:label||null}); $('#cronExpr').value = ''; $('#cronLabel').value = ''; loadSchedules(); toast('Schedule added'); }catch(e){ toast('Failed: '+e.message); }
    });

    // Moderation
    async function loadModeration(){
      try{
        const [banPresets, kickPresets] = await Promise.all([
          jget('/api/ban-presets'),
          jget('/api/kick-presets')
        ]);
        
        // Populate ban presets dropdown
        $('#modBanSelect').innerHTML = '<option value="">Select ban reasonâ€¦</option>' + 
          banPresets.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
        
        // Populate kick presets dropdown
        $('#modKickSelect').innerHTML = '<option value="">Select kick reasonâ€¦</option>' + 
          kickPresets.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
      }catch(e){ 
        console.error('Failed to load moderation presets:', e); 
        $('#modBanSelect').innerHTML = '<option value="">Select ban reasonâ€¦</option>';
        $('#modKickSelect').innerHTML = '<option value="">Select kick reasonâ€¦</option>';
      }
    }

    // Presets
    async function loadPresets(){
      try{
        const [bc, ban, kick] = await Promise.all([
          jget('/api/broadcast-presets'), 
          jget('/api/ban-presets'),
          jget('/api/kick-presets')
        ]);
        
        // Broadcast presets table
        const bcRows = bc.map(r=>`<tr><td>${r.id}</td><td>${r.label||'â€”'}</td><td class="small">${escapeHtml(r.message||'')}</td><td><button class="btn danger ghost" onclick="deleteBcPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#bcTable tbody').innerHTML = bcRows || '<tr><td colspan="4" class="small">No presets</td></tr>';
        
        // Broadcast presets dropdown
        $('#bcSelect').innerHTML = '<option value="">Select presetâ€¦</option>' + bc.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
        
        // Ban presets table
        const banRows = ban.map(r=>`<tr><td>${r.id}</td><td>${r.label||'â€”'}</td><td class="small">${escapeHtml(r.reason||'')}</td><td><button class="btn danger ghost" onclick="deleteBanPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#banTable tbody').innerHTML = banRows || '<tr><td colspan="4" class="small">No presets</td></tr>';
        
        // Kick presets table
        const kickRows = kick.map(r=>`<tr><td>${r.id}</td><td>${r.label||'â€”'}</td><td class="small">${escapeHtml(r.reason||'')}</td><td><button class="btn danger ghost" onclick="deleteKickPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#kickTable tbody').innerHTML = kickRows || '<tr><td colspan="4" class="small">No presets</td></tr>';
      }catch(e){ console.error('Failed to load presets:', e); }
    }
    
    async function deleteBcPreset(id){
      if(!confirm('Delete this broadcast preset?')) return;
      try{ await jdel('/api/broadcast-presets/'+id); loadPresets(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteBanPreset(id){
      if(!confirm('Delete this ban preset?')) return;
      try{ await jdel('/api/ban-presets/'+id); loadPresets(); loadModeration(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteKickPreset(id){
      if(!confirm('Delete this kick preset?')) return;
      try{ await jdel('/api/kick-presets/'+id); loadPresets(); loadModeration(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    
    $('#bcAdd').addEventListener('click', async ()=>{
      const label = $('#bcLabel').value.trim(), message = $('#bcMessage').value.trim();
      if(!message) return toast('Message required');
      try{ await jpost('/api/broadcast-presets', {label:label||null, message}); $('#bcLabel').value = ''; $('#bcMessage').value = ''; loadPresets(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#banAdd').addEventListener('click', async ()=>{
      const label = $('#banLabel').value.trim(), reason = $('#banReason').value.trim();
      if(!reason) return toast('Reason required');
      try{ await jpost('/api/ban-presets', {label:label||null, reason}); $('#banLabel').value = ''; $('#banReason').value = ''; loadPresets(); loadModeration(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#kickAdd').addEventListener('click', async ()=>{
      const label = $('#kickLabel').value.trim(), reason = $('#kickReason').value.trim();
      if(!reason) return toast('Reason required');
      try{ await jpost('/api/kick-presets', {label:label||null, reason}); $('#kickLabel').value = ''; $('#kickReason').value = ''; loadPresets(); loadModeration(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#bcSend').addEventListener('click', async ()=>{
      const presetId = $('#bcSelect').value;
      if(!presetId) return toast('Please select a preset');
      try{ const result = await jpost('/api/broadcast', {presetId: Number(presetId)}); toast('Broadcast sent'); $('#cmdOut').textContent = result.out || 'Sent successfully'; }catch(e){ toast('Failed: '+e.message); }
    });
    
    // Moderation functionality
    $('#modBanSend').addEventListener('click', async ()=>{
      const username = $('#modBanUser').value.trim(), presetId = $('#modBanSelect').value;
      if(!username) return toast('Username required');
      if(!presetId) return toast('Please select a ban reason');
      if(!confirm(`Ban user "${username}"?`)) return;
      try{ const result = await jpost('/api/ban', {username, presetId: Number(presetId)}); toast('Ban executed'); $('#cmdOut').textContent = result.out || 'Ban executed successfully'; $('#modBanUser').value = ''; }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#modKickSend').addEventListener('click', async ()=>{
      const username = $('#modKickUser').value.trim(), presetId = $('#modKickSelect').value;
      if(!username) return toast('Username required');
      if(!presetId) return toast('Please select a kick reason');
      if(!confirm(`Kick user "${username}"?`)) return;
      try{ const result = await jpost('/api/kick', {username, presetId: Number(presetId)}); toast('Kick executed'); $('#cmdOut').textContent = result.out || 'Kick executed successfully'; $('#modKickUser').value = ''; }catch(e){ toast('Failed: '+e.message); }
    });

    // Analytics
    async function loadAnalytics() {
      try {
        const data = await jget('/api/analytics/dashboard');
        
        // Update today's stats
        if (data.current_stats && data.current_stats.today) {
          const today = data.current_stats.today;
          $('#todayPlayers').textContent = today.unique_players || '0';
          $('#todaySessions').textContent = today.total_sessions || '0';
          $('#todayPeak').textContent = today.peak_online || '0';
          $('#avgSession').textContent = Math.round((today.avg_session_duration || 0) / 60);
        }
        
        // Update player trend chart
        if (data.player_trend) {
          updateAnalyticsPlayerChart(data.player_trend);
        }
        
        // Update top players
        if (data.top_players) {
          const playersHtml = data.top_players.map((player, index) => 
            `<div class="small" style="display:flex; justify-content:space-between; margin-bottom:8px; padding:8px; background:rgba(15,17,21,0.5); border-radius:8px">
              <span><b>${index + 1}.</b> ${player.username}</span>
              <span>${player.playtime_hours}h</span>
            </div>`
          ).join('');
          $('#topPlayersList').innerHTML = playersHtml || '<div class="empty">No player data</div>';
        }
        
        // Update session distribution
        if (data.session_distribution) {
          updateSessionDistChart(data.session_distribution);
        }
        
        // Update hourly activity
        if (data.hourly_activity) {
          updateHourlyActivityChart(data.hourly_activity);
        }
        
        // Update command stats
        if (data.command_stats) {
          const commandsHtml = data.command_stats.slice(0, 10).map(cmd => 
            `<div class="small" style="display:flex; justify-content:space-between; margin-bottom:4px">
              <span><code>${escapeHtml(cmd.command)}</code></span>
              <span>${cmd.usage_count} uses</span>
            </div>`
          ).join('');
          $('#commandStats').innerHTML = commandsHtml || '<div class="empty">No command data</div>';
        }
        
      } catch (e) {
        console.error('Failed to load analytics:', e);
        toast('Failed to load analytics data');
      }
    }

    function updateAnalyticsPlayerChart(data) {
      if (typeof Chart === 'undefined') {
        $('#analyticsPlayerChart').parentElement.innerHTML = '<div class="empty">Chart.js not available - charts disabled</div>';
        return;
      }
      
      const ctx = $('#analyticsPlayerChart').getContext('2d');
      
      if (analyticsPlayerChart) {
        analyticsPlayerChart.destroy();
      }
      
      analyticsPlayerChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [
            {
              label: 'Unique Players',
              data: data.map(d => d.unique_players),
              borderColor: '#7c5cff',
              backgroundColor: 'rgba(124, 92, 255, 0.1)',
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Sessions',
              data: data.map(d => d.total_sessions),
              borderColor: '#44d3a8',
              backgroundColor: 'rgba(68, 211, 168, 0.1)',
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Players' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Sessions' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    function updateSessionDistChart(data) {
      if (typeof Chart === 'undefined') {
        $('#sessionDistChart').parentElement.innerHTML = '<div class="empty">Chart.js not available - charts disabled</div>';
        return;
      }
      
      const ctx = $('#sessionDistChart').getContext('2d');
      
      if (sessionDistChart) {
        sessionDistChart.destroy();
      }
      
      sessionDistChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.map(d => d.duration_bucket),
          datasets: [{
            data: data.map(d => d.count),
            backgroundColor: [
              'rgba(124, 92, 255, 0.8)',
              'rgba(68, 211, 168, 0.8)',
              'rgba(255, 176, 32, 0.8)',
              'rgba(255, 93, 93, 0.8)',
              'rgba(156, 163, 175, 0.8)',
              'rgba(99, 102, 241, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateHourlyActivityChart(data) {
      if (typeof Chart === 'undefined') {
        $('#hourlyActivityChart').parentElement.innerHTML = '<div class="empty">Chart.js not available - charts disabled</div>';
        return;
      }
      
      const ctx = $('#hourlyActivityChart').getContext('2d');
      
      if (hourlyActivityChart) {
        hourlyActivityChart.destroy();
      }
      
      hourlyActivityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.hour + ':00'),
          datasets: [{
            label: 'Sessions',
            data: data.map(d => d.sessions),
            backgroundColor: 'rgba(124, 92, 255, 0.6)',
            borderColor: '#7c5cff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // System Monitoring
    async function loadSystemMonitoring() {
      try {
        const [currentMetrics, fileStats] = await Promise.all([
          jget('/api/system/metrics'),
          jget('/api/files/stats').catch(() => null)
        ]);
        
        // Update current system metrics
        if (currentMetrics) {
          $('#cpuUsage').textContent = `${currentMetrics.cpu.usage}%`;
          $('#memoryUsage').textContent = `${currentMetrics.memory.usage}%`;
          $('#diskUsage').textContent = `${currentMetrics.disk.usage}%`;
          $('#systemUptime').textContent = Math.round(currentMetrics.uptime / 3600);
          
          $('#networkRx').textContent = currentMetrics.network.rxRate || '0';
          $('#networkTx').textContent = currentMetrics.network.txRate || '0';
          
          $('#load1').textContent = currentMetrics.load[1] || '0';
          $('#load5').textContent = currentMetrics.load[5] || '0';
          $('#load15').textContent = currentMetrics.load[15] || '0';
        }
        
        // Update file monitoring stats
        if (fileStats) {
          const fileStatsHtml = `
            <div class="grid cols-2">
              <div class="small">Banned Players: <b>${fileStats.banned_players || 0}</b></div>
              <div class="small">Banned IPs: <b>${fileStats.banned_ips || 0}</b></div>
              <div class="small">Whitelist: <b>${fileStats.whitelist || 0}</b></div>
              <div class="small">Operators: <b>${fileStats.operators || 0}</b></div>
              <div class="small">Server Settings: <b>${fileStats.server_settings || 0}</b></div>
              <div class="small">Active Watchers: <b>${fileStats.active_watchers || 0}</b></div>
            </div>
          `;
          $('#fileMonitorStats').innerHTML = fileStatsHtml;
        }
        
        // Load system history chart
        loadSystemHistoryChart();
        
      } catch (e) {
        console.error('Failed to load system monitoring:', e);
        toast('Failed to load system monitoring data');
      }
    }

    async function loadSystemHistoryChart() {
      if (typeof Chart === 'undefined') {
        $('#systemChart').parentElement.innerHTML = '<div class="empty">Chart.js not available - charts disabled</div>';
        return;
      }
      
      try {
        const history = await jget('/api/system/history?hours=24');
        
        const ctx = $('#systemChart').getContext('2d');
        
        if (systemChart) {
          systemChart.destroy();
        }
        
        systemChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: history.map(h => new Date(h.recorded_at).toLocaleTimeString()),
            datasets: [
              {
                label: 'CPU %',
                data: history.map(h => h.cpu_usage),
                borderColor: '#7c5cff',
                backgroundColor: 'rgba(124, 92, 255, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Memory %',
                data: history.map(h => h.memory_usage),
                borderColor: '#44d3a8',
                backgroundColor: 'rgba(68, 211, 168, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Disk %',
                data: history.map(h => h.disk_usage),
                borderColor: '#ffb020',
                backgroundColor: 'rgba(255, 176, 32, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: 'Usage %' }
              }
            }
          }
        });
        
      } catch (e) {
        console.warn('Failed to load system history chart:', e);
      }
    }

    // Logout function
    async function logout() {
      try {
        await jpost('/logout');
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout failed:', error);
        // Even if logout fails, redirect to login
        window.location.href = '/login';
      }
    }

    // Audit
    async function loadAudit(){
      const tbody = $('#auditTable tbody'); tbody.innerHTML = '<tr><td colspan="3" class="small">Loadingâ€¦</td></tr>';
      try{
        const rows = await jget('/api/audit');
        tbody.innerHTML = rows.map(r=>`<tr><td class="small">${fmtDate(r.created_at)}</td><td class="small"><code>${r.action}</code></td><td class="small">${escapeHtml(JSON.stringify(r.payload||{}))}</td></tr>`).join('') || '<tr><td colspan="3" class="small">No audit events</td></tr>';
      }catch{ tbody.innerHTML = '<tr><td colspan="3" class="small">Failed to load audit</td></tr>'; }
    }

    // Global refresh
    $('#refreshBtn').addEventListener('click', ()=>{
      loadStatus(); loadOnline();
      const active = $('.nav button.active').dataset.tab;
      if(active==='players') loadPlayers();
      if(active==='bans') loadBans();
      if(active==='moderation') loadModeration();
      if(active==='schedules') loadSchedules();
      if(active==='presets') loadPresets();
      if(active==='audit') loadAudit();
      if(active==='analytics') loadAnalytics();
      if(active==='monitoring') loadSystemMonitoring();
    });

    // Logout button
    $('#logoutBtn').addEventListener('click', logout);

    // Enhanced initialization with proper DOM ready handling
    function initializeApp() {
      // Ensure DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
        return;
      }
      
      console.log('[panel] Initializing application...');
      
      // Initialize tabs with retry mechanism
      initializeTabs();
      
      // Start data loading
      setTimeout(() => {
        loadStatus(); loadOnline(true);
        setInterval(()=>{ loadStatus(); loadOnline(true); }, 30000); // Refresh every 30s
      }, 1000);
      
      console.log('[panel] Application initialized successfully');
    }
    
    // Start initialization
    initializeApp();
  </script>
</body>
</html>

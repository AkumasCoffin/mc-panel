<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minecraft WebGUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    [hidden]{display:none !important;}
    :root{
      --bg:#0f1115; --panel:#151823; --muted:#8b90a3; --text:#e6e9ef;
      --brand:#7c5cff; --brand-2:#44d3a8; --warn:#ffb020; --danger:#ff5d5d;
      --border:#212535; --chip:#1b2030;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0f1115,#0d0f14); color:var(--text); font:14px/1.4 system-ui,Segoe UI,Inter,Arial,sans-serif;}
    a{color:inherit; text-decoration:none}
    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .side{position:sticky; top:0; height:100vh; padding:18px; border-right:1px solid var(--border); background:rgba(13,16,22,.65); backdrop-filter: blur(8px); display:flex; flex-direction:column; gap:14px;}
    .brand{display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:12px; background:linear-gradient(90deg,rgba(124,92,255,.15),rgba(68,211,168,.08)); border:1px solid var(--border);}
    .brand svg{width:22px; height:22px}
    .brand h1{font-size:16px; margin:0}
    .nav{display:flex; flex-direction:column; gap:6px; margin-top:8px}
    .nav button{display:flex; align-items:center; gap:10px; width:100%; background:transparent; color:var(--text); border:1px solid transparent; padding:10px 12px; border-radius:10px; cursor:pointer; text-align:left; transition:.15s;}
    .nav button:hover{background:var(--chip); border-color:var(--border)}
    .nav button.active{background:linear-gradient(90deg,rgba(124,92,255,.18),rgba(68,211,168,.12)); border-color:#2a2f44}
    .nav svg{width:16px;height:16px; opacity:.9}
    .side .foot{margin-top:auto; color:var(--muted); font-size:12px; opacity:.8}
    .main{padding:22px;}
    .toolbar{display:flex; align-items:center; gap:10px; margin-bottom:16px}
    .toolbar .chip{padding:6px 10px; background:var(--chip); border:1px solid var(--border); border-radius:999px; color:#cdd3e1}
    .cards{display:grid; grid-template-columns: repeat(12, 1fr); gap:14px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:14px; grid-column: span 12;}
    @media (min-width: 900px){ .card.half{grid-column: span 6} .card.third{grid-column: span 4} .card.two{grid-column: span 8}}
    .card h3{margin:0 0 10px 0; font-size:15px}
    .muted{color:var(--muted)}
    .split{display:flex; gap:8px; flex-wrap:wrap}
    input[type=text], textarea, select{background:#0d111a; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; width:100%;}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    .btn{background:#1a1f2e; color:#dfe6f3; border:1px solid var(--border); border-radius:10px; padding:10px 12px; cursor:pointer; transition:.15s;}
    .btn:hover{filter:brightness(1.1)}
    .btn.brand{background:linear-gradient(90deg,rgba(124,92,255,.25),rgba(68,211,168,.18)); border-color:#2a2f44}
    .btn.warn{background:rgba(255,176,32,.12); border-color:#4b3b1a}
    .btn.danger{background:rgba(255,93,93,.12); border-color:#4b1a1a}
    .btn.ghost{background:transparent}
    .tag{background:#0e1220; border:1px solid var(--border); color:#cdd3e1; padding:4px 8px; border-radius:999px; font-size:12px}
    .grid{display:grid; gap:10px}
    .grid.cols-2{grid-template-columns: repeat(2, 1fr)}
    .grid.cols-3{grid-template-columns: repeat(3, 1fr)}
    .grid.cols-4{grid-template-columns: repeat(4, 1fr)}
    @media (max-width: 900px){ 
      .grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}
      .app{grid-template-columns:1fr; grid-template-rows:auto 1fr}
      .side{height:auto; position:static; flex-direction:row; overflow-x:auto; gap:8px; padding:12px}
      .nav{flex-direction:row; gap:8px; white-space:nowrap}
      .nav button{min-width:120px; justify-content:center}
      .main{padding:16px}
      .card.half,.card.third,.card.two{grid-column:span 12}
    }
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border-bottom:1px dashed #23283a; text-align:left}
    th{color:#aab3c7; font-weight:600; background:#121624; position:sticky; top:0}
    tr:hover td{background:#111522}
    .ban-card{display:flex; flex-direction:column; gap:8px; padding:12px; border:1px solid var(--border); border-radius:14px; background:#121627;}
    .ban-card .head{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .ban-card .who{display:flex; align-items:center; gap:8px}
    .pill{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border)}
    .pill.player{background:rgba(124,92,255,.15)}
    .pill.ip{background:rgba(68,211,168,.15)}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:50; padding:20px;}
    .modal.open{display:flex}
    .modal .sheet{width:min(980px,100%); max-height:90vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 10px 40px rgba(0,0,0,.5);}
    .toast{position:fixed; right:16px; bottom:16px; background:#121827; border:1px solid var(--border); color:#e8eefc; padding:10px 12px; border-radius:10px; z-index:60; display:none;}
    .toast.show{display:block; animation:fade 2.2s ease}
    @keyframes fade{0%{opacity:0; transform:translateY(8px)} 10%{opacity:1; transform:none} 80%{opacity:1} 100%{opacity:0}}
    .small{font-size:12px; color:#aab3c7}
    .right{margin-left:auto}
    .center{display:flex; justify-content:center; align-items:center}
    .empty{padding:18px; border:1px dashed #2b3147; border-radius:12px; color:#aab3c7; background:#0f1320}
    
    /* Chart containers */
    .chart-container{position:relative; height:200px; margin:10px 0}
    .chart-container canvas{background:rgba(15,17,21,0.5); border-radius:12px}
    .metric-box{background:linear-gradient(135deg,#151823,#1a1f2e); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center}
    .metric-value{font-size:24px; font-weight:bold; color:var(--brand)}
    .metric-label{font-size:12px; color:var(--muted); margin-top:4px}
    .status-indicator{display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px}
    
    /* Light theme support */
    body.light-theme {
      --bg: #f8f9fa; --panel: #ffffff; --muted: #6c757d; --text: #212529;
      --border: #dee2e6; --chip: #e9ecef;
      background: linear-gradient(180deg, #f8f9fa, #ffffff);
    }
    body.light-theme .side { background: rgba(255, 255, 255, 0.95); }
    body.light-theme .metric-box { background: linear-gradient(135deg, #ffffff, #f8f9fa); }
    body.light-theme .chart-container canvas { background: rgba(248, 249, 250, 0.5); }
    body.light-theme th { background: #f8f9fa; }
    body.light-theme .empty { background: #f8f9fa; border-color: #dee2e6; }
    
    /* Improved visual hierarchy */
    .section-header { margin: 20px 0 10px 0; font-size: 18px; font-weight: 600; color: var(--brand); }
    .action-group { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .action-group .btn { flex: 1; min-width: 120px; }
    
    /* Status indicators */
    .status-online { background: #22c55e; }
    .status-offline { background: #ef4444; }
    .status-unknown { background: #6b7280; }
    .status-indicator.good{background:#44d3a8}
    .status-indicator.warning{background:#ffb020}
    .status-indicator.critical{background:#ff5d5d}
  </style>
  <script>
    // Enhanced Chart.js fallback with better visual charts
    console.log('[panel] Setting up Chart.js fallback...');
    
    // Create enhanced mock Chart object
    window.Chart = function(ctx, config) {
      if (!ctx || !ctx.canvas || !config) {
        return { destroy: function() {}, update: function() {}, resize: function() {} };
      }
      
      const canvas = ctx.canvas;
      const context = canvas.getContext('2d');
      const data = config.data;
      const type = config.type;
      
      // Clear canvas
      context.clearRect(0, 0, canvas.width, canvas.height);
      
      // Set styling
      context.fillStyle = '#aab3c7';
      context.strokeStyle = '#7c5cff';
      context.font = '12px system-ui';
      context.textAlign = 'center';
      
      if (!data || !data.datasets || data.datasets.length === 0) {
        // Show "no data" message
        context.fillText('No chart data available', canvas.width / 2, canvas.height / 2);
        return { destroy: function() {}, update: function() {}, resize: function() {} };
      }
      
      const dataset = data.datasets[0];
      const values = dataset.data || [];
      const labels = data.labels || [];
      
      if (values.length === 0) {
        context.fillText('No data to display', canvas.width / 2, canvas.height / 2);
        return { destroy: function() {}, update: function() {}, resize: function() {} };
      }
      
      // Simple chart rendering based on type
      if (type === 'line') {
        drawLineChart(context, canvas, values, labels);
      } else if (type === 'bar') {
        drawBarChart(context, canvas, values, labels);
      } else if (type === 'doughnut') {
        drawDoughnutChart(context, canvas, values, labels);
      } else {
        context.fillText(`${type} chart (simplified)`, canvas.width / 2, canvas.height / 2);
        context.fillText(`${values.length} data points`, canvas.width / 2, canvas.height / 2 + 20);
      }
      
      return { destroy: function() {}, update: function() {}, resize: function() {} };
    };
    
    function drawLineChart(ctx, canvas, values, labels) {
      const padding = 40;
      const chartWidth = canvas.width - padding * 2;
      const chartHeight = canvas.height - padding * 2;
      const maxValue = Math.max(...values, 1);
      
      ctx.strokeStyle = '#7c5cff';
      ctx.fillStyle = 'rgba(124, 92, 255, 0.1)';
      ctx.lineWidth = 2;
      
      // Draw line
      ctx.beginPath();
      values.forEach((value, index) => {
        const x = padding + (index / (values.length - 1)) * chartWidth;
        const y = padding + chartHeight - (value / maxValue) * chartHeight;
        if (index === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Draw area under line
      ctx.lineTo(padding + chartWidth, padding + chartHeight);
      ctx.lineTo(padding, padding + chartHeight);
      ctx.closePath();
      ctx.fill();
      
      // Draw max value indicator
      ctx.fillStyle = '#aab3c7';
      ctx.textAlign = 'left';
      ctx.fillText(`Max: ${maxValue}`, padding, padding - 5);
    }
    
    function drawBarChart(ctx, canvas, values, labels) {
      const padding = 40;
      const chartWidth = canvas.width - padding * 2;
      const chartHeight = canvas.height - padding * 2;
      const maxValue = Math.max(...values, 1);
      const barWidth = chartWidth / values.length * 0.8;
      
      ctx.fillStyle = 'rgba(124, 92, 255, 0.6)';
      
      values.forEach((value, index) => {
        const x = padding + (index / values.length) * chartWidth + (chartWidth / values.length - barWidth) / 2;
        const height = (value / maxValue) * chartHeight;
        const y = padding + chartHeight - height;
        ctx.fillRect(x, y, barWidth, height);
      });
      
      // Draw max value indicator
      ctx.fillStyle = '#aab3c7';
      ctx.textAlign = 'left';
      ctx.fillText(`Max: ${maxValue}`, padding, padding - 5);
    }
    
    function drawDoughnutChart(ctx, canvas, values, labels) {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 20;
      const total = values.reduce((a, b) => a + b, 0);
      
      const colors = ['#7c5cff', '#44d3a8', '#ffb020', '#ff5d5d', '#9ca3af', '#6366f1'];
      
      let currentAngle = -Math.PI / 2;
      
      values.forEach((value, index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        
        ctx.fillStyle = colors[index % colors.length];
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, radius * 0.6, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();
        ctx.fill();
        
        currentAngle += sliceAngle;
      });
      
      // Draw center text
      ctx.fillStyle = '#aab3c7';
      ctx.textAlign = 'center';
      ctx.fillText(`${values.length} items`, centerX, centerY);
    }
    
    // Chart.js defaults
    window.Chart.defaults = {
      color: '#aab3c7',
      backgroundColor: 'rgba(124, 92, 255, 0.1)',
      borderColor: '#7c5cff',
      plugins: { legend: { labels: { color: '#aab3c7' } } },
      scales: {
        linear: { grid: { color: 'rgba(171, 179, 199, 0.1)' }, ticks: { color: '#aab3c7' } },
        category: { grid: { color: 'rgba(171, 179, 199, 0.1)' }, ticks: { color: '#aab3c7' } }
      }
    };
    
    console.log('[panel] Chart.js fallback ready');
  </script>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12l7-9 7 9-7 9-7-9z" stroke-width="1.5"/><path d="M3 12h18" stroke-width="1.5"/></svg>
        <h1>MC Panel</h1>
        <span class="right chip">Forge 1.20.1</span>
      </div>
      <div class="nav">
        <button data-tab="status" class="active"><svg viewBox="0 0 24 24"><path d="M3 12h6v9H3zM9 3h6v18H9zM15 8h6v13h-6z" fill="currentColor"/></svg>Dashboard</button>
        <button data-tab="performance"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>Performance</button>
        <button data-tab="analytics"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm5 10a5 5 0 01-8.536 3.536L15.536 8.464A4.982 4.982 0 0117 12zm-10 0a5 5 0 018.536-3.536L8.464 15.536A4.982 4.982 0 017 12z" fill="currentColor"/></svg>Analytics</button>
        <button data-tab="server-controls"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>Server Controls</button>

        <button data-tab="players"><svg viewBox="0 0 24 24"><path d="M16 13a4 4 0 10-8 0 7 7 0 00-7 7h22a7 7 0 00-7-7z" fill="currentColor"/></svg>Players</button>

        <button data-tab="moderation"><svg viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>Moderation</button>
        <button data-tab="schedules"><svg viewBox="0 0 24 24"><path d="M7 2v3M17 2v3M3 9h18M5 5h14a2 2 0 012 2v13H3V7a2 2 0 012-2z" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Scheduled Restarts</button>
        <button data-tab="settings"><svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" fill="none"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" stroke="currentColor" fill="none" stroke-width="1.5"/></svg>Settings</button>
        <button data-tab="audit"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4zM8 8h8M8 12h8M8 16h5" stroke="currentColor" fill="none" stroke-width="1.3"/></svg>Audit / Commands</button>
      </div>
      <div class="foot small">
        <div id="statusChip">Status: <span class="tag">loading…</span></div>
        <div style="margin-top:6px">Next restart: <span id="nextRestart" class="tag">—</span></div>
      </div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <div class="chip">Session authenticated</div>
        <div id="tip" class="chip">Tip: click a player to open details</div>
        <button class="btn ghost" id="logoutBtn">Logout</button>
        <button class="btn ghost right" id="refreshBtn">↻ Refresh</button>
      </div>

      <!-- STATUS -->
      <div id="tab-status" class="cards">
        <section class="card third">
          <h3>Server Status</h3>
          <div id="statusBox" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="serverStatusText">—</div>
              <div class="metric-label">Server Status</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="serverRconStatus">—</div>
              <div class="metric-label">RCON Status</div>
            </div>
          </div>
          <div style="margin-top:10px; font-size:12px; color:var(--muted)" id="serverStatusDetail">Live log tracking enabled.</div>
        </section>

        <section class="card third">
          <h3>Next Restart</h3>
          <div id="restartBox" class="empty">
            <div>Next Restart</div>
            <div class="row" style="margin-top:8px">
              <div><span class="tag" id="nextRestart2">—</span></div>
              <div><span class="tag" id="nextRestartIn">—</span></div>
            </div>
            <div class="small" style="margin-top:8px">Configured in <b>Scheduled Restarts</b>.</div>
          </div>
        </section>

        <section class="card third">
          <h3>Quick Stats</h3>
          <div id="quickStats" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="totalPlayers">—</div>
              <div class="metric-label">Total Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="onlineNow">—</div>
              <div class="metric-label">Online Now</div>
            </div>
          </div>
        </section>

        <section class="card half">
          <h3>Online Players</h3>
          <div id="onlineList" class="grid cols-2"></div>
          <div id="onlineEmpty" class="empty" style="display:none">No one online.</div>
        </section>

        <section class="card half">
          <h3>Player Activity (7 days)</h3>
          <div class="chart-container">
            <canvas id="playerTrendChart"></canvas>
          </div>
        </section>

        <section class="card">
          <h3>Quick Command</h3>
          <div class="row">
            <input id="cmdInput" type="text" value="list" />
            <button class="btn brand" id="sendCmd">Run</button>
          </div>
          <pre id="cmdOut" class="small" style="margin-top:10px; white-space:pre-wrap; background:#0e1220; border:1px solid var(--border); padding:10px; border-radius:10px; min-height:40px"></pre>
          <div class="small muted" id="rconNote" style="margin-top:8px"></div>
        </section>

        <section class="card">
          <h3>Recent Activity</h3>
          <div id="recentActivity" style="max-height:200px; overflow-y:auto"></div>
        </section>
      </div>

      <!-- ONLINE -->


      <!-- ANALYTICS -->
      <div id="tab-analytics" class="cards" hidden>
        <section class="card third">
          <h3>Today's Stats</h3>
          <div id="todayStats" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="todayPlayers">—</div>
              <div class="metric-label">Unique Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="todaySessions">—</div>
              <div class="metric-label">Sessions</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="todayPeak">—</div>
              <div class="metric-label">Peak Online</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="avgSession">—</div>
              <div class="metric-label">Avg Session (min)</div>
            </div>
          </div>
        </section>

        <section class="card two">
          <h3>Player Activity Trend 
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('player-trend')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:250px">
            <canvas id="analyticsPlayerChart"></canvas>
          </div>
        </section>

        <section class="card half">
          <h3>Top Players by Playtime</h3>
          <div id="topPlayersList" style="max-height:300px; overflow-y:auto"></div>
        </section>

        <section class="card half">
          <h3>Session Length Distribution 
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('session-dist')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:200px">
            <canvas id="sessionDistChart"></canvas>
          </div>
        </section>

        <section class="card half">
          <h3>Daily Player Counts (Last 7 Days) 
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('daily-players')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:200px">
            <canvas id="dailyPlayerChart"></canvas>
          </div>
        </section>

        <section class="card">
          <h3>Hourly Activity Heatmap (Last 7 Days) 
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('hourly-heatmap')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:250px">
            <canvas id="hourlyActivityChart"></canvas>
          </div>
        </section>

        <section class="card half">
          <h3>Top Commands Usage 
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('command-usage')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:250px">
            <canvas id="commandChart"></canvas>
          </div>
        </section>

        <section class="card half">
          <h3>Command Usage Stats</h3>
          <div id="commandStats" style="max-height:250px; overflow-y:auto"></div>
        </section>
      </div>

      <!-- PERFORMANCE -->
      <div id="tab-performance" class="cards" hidden>
        <section class="card third">
          <h3>Real-time System Metrics</h3>
          <div id="liveMetrics" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="liveCPU">—</div>
              <div class="metric-label">CPU Usage %</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="liveRAM">—</div>
              <div class="metric-label">RAM Usage %</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="liveDisk">—</div>
              <div class="metric-label">Disk Usage %</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="serverUptime">—</div>
              <div class="metric-label">System Uptime</div>
            </div>
          </div>
        </section>

        <section class="card third">
          <h3>Server Performance</h3>
          <div id="serverMetrics" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="liveTPS">—</div>
              <div class="metric-label">Server TPS</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="avgTPS">—</div>
              <div class="metric-label">Avg TPS (5min)</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="networkRx">—</div>
              <div class="metric-label">Network RX Rate</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="networkTx">—</div>
              <div class="metric-label">Network TX Rate</div>
            </div>
          </div>
        </section>

        <section class="card third">
          <h3>System Load Average</h3>
          <div id="loadStats" class="grid cols-3">
            <div class="metric-box">
              <div class="metric-value" id="load1">—</div>
              <div class="metric-label">1 min</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="load5">—</div>
              <div class="metric-label">5 min</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="load15">—</div>
              <div class="metric-label">15 min</div>
            </div>
          </div>
        </section>

        <section class="card third">
          <h3>Historical Data Controls</h3>
          <div class="row">
            <select id="perfPeriod">
              <option value="1h">Last Hour</option>
              <option value="1d" selected>Last Day</option>
              <option value="7d">Last Week</option>
            </select>
            <button class="btn" id="perfRefresh">Refresh</button>
          </div>
        </section>

        <section class="card two">
          <h3>Server File Monitoring</h3>
          <div id="fileMonitorStats"></div>
        </section>

        <section class="card half">
          <h3>CPU & Memory History 
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('cpu-memory')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:300px">
            <canvas id="performanceCPUChart"></canvas>
          </div>
        </section>

        <section class="card half">
          <h3>Network & TPS History 
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('network-tps')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:300px">
            <canvas id="performanceNetworkChart"></canvas>
          </div>
        </section>

        <section class="card">
          <h3>System Performance (24h)
            <button class="btn ghost" style="font-size:12px; padding:2px 6px; margin-left:8px;" onclick="showChartInfo('system-24h')">ℹ️</button>
          </h3>
          <div class="chart-container" style="height:350px">
            <canvas id="systemChart"></canvas>
          </div>
        </section>
      </div>


      <!-- SERVER CONTROLS -->
      <div id="tab-server-controls" class="cards" hidden>
        <section class="card half">
          <h3>Server Status</h3>
          <div id="serverStatusInfo" class="grid cols-2">
            <div class="metric-box">
              <div class="metric-value" id="serverSystemStatus">—</div>
              <div class="metric-label">System Status</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="serverOnlinePlayers">—</div>
              <div class="metric-label">Online Players</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="serverRconStatus">—</div>
              <div class="metric-label">RCON Status</div>
            </div>
            <div class="metric-box">
              <div class="metric-value" id="serverLastAction">—</div>
              <div class="metric-label">Last Action</div>
            </div>
          </div>
        </section>

        <section class="card half">
          <h3>Server Controls</h3>
          <div class="row">
            <button class="btn brand" id="startServerBtn">
              <svg viewBox="0 0 24 24" style="width:16px;height:16px;margin-right:6px"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>
              Start Server
            </button>
            <button class="btn warn" id="restartServerBtn">
              <svg viewBox="0 0 24 24" style="width:16px;height:16px;margin-right:6px"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke="currentColor" fill="none" stroke-width="2"/></svg>
              Restart Server
            </button>
            <button class="btn danger" id="stopServerBtn">
              <svg viewBox="0 0 24 24" style="width:16px;height:16px;margin-right:6px"><path d="M6 6h12v12H6z" fill="currentColor"/></svg>
              Stop Server
            </button>
          </div>
          
          <div style="margin-top:15px">
            <label for="serverBroadcastMsg">Broadcast message before action (optional):</label>
            <textarea id="serverBroadcastMsg" placeholder="Server will restart in 5 minutes for maintenance..." rows="2"></textarea>
          </div>
          
          <div class="row" style="margin-top:10px">
            <select id="serverBroadcastPreset">
              <option value="">Or select preset message...</option>
            </select>
            <button class="btn ghost" id="usePresetMsg">Use Preset</button>
          </div>
        </section>

        <section class="card">
          <h3>Recent Server Actions</h3>
          <div id="serverActionHistory" style="max-height:300px; overflow-y:auto">
            <div class="empty">Loading...</div>
          </div>
        </section>
      </div>

      <!-- PLAYERS -->
      <div id="tab-players" class="cards" hidden>
        <section class="card">
          <h3>All Players</h3>
          <div class="row" style="margin-bottom:8px">
            <input id="playerSearch" type="text" placeholder="Search username…" />
            <div class="chip" id="playerCountChip">0 players</div>
          </div>
          <div style="overflow:auto; max-height:70vh">
            <table id="playersTable">
              <thead><tr><th>User</th><th>UUID</th><th>Last IP</th><th>First Seen</th><th>Last Seen</th><th>Playtime</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- BANS -->


      <!-- MODERATION -->
      <div id="tab-moderation" class="cards" hidden>
        <section class="card half">
          <h3>Ban Player</h3>
          <div class="row" style="margin-bottom:10px">
            <input id="modBanUser" type="text" placeholder="Username to ban" />
            <select id="modBanSelect"><option value="">Select ban reason…</option></select>
            <button class="btn danger" id="modBanSend">Ban Player</button>
          </div>
          <div class="small muted">Requires RCON. Command: <code>ban &lt;user&gt; &lt;reason&gt;</code></div>
        </section>
        <section class="card half">
          <h3>Kick Player</h3>
          <div class="row" style="margin-bottom:10px">
            <input id="modKickUser" type="text" placeholder="Username to kick" />
            <select id="modKickSelect"><option value="">Select kick reason…</option></select>
            <button class="btn warn" id="modKickSend">Kick Player</button>
          </div>
          <div class="small muted">Requires RCON. Command: <code>kick &lt;user&gt; &lt;reason&gt;</code></div>
        </section>
        <section class="card two">
          <h3>Banned Players</h3>
          <div id="banPlayers" class="grid cols-2"></div>
          <div id="banPlayersEmpty" class="empty" style="display:none">No player bans found.</div>
        </section>
        <section class="card third">
          <h3>Banned IPs</h3>
          <div id="banIps" class="grid"></div>
          <div id="banIpsEmpty" class="empty" style="display:none">No IP bans found.</div>
        </section>
      </div>

      <!-- SCHEDULES -->
      <div id="tab-schedules" class="cards" hidden>
        <section class="card">
          <h3>Add Schedule</h3>
          <div class="row">
            <input id="cronExpr" type="text" placeholder="Cron (e.g. 0 */6 * * *)" />
            <input id="cronLabel" type="text" placeholder="Optional label" />
            <button class="btn brand" id="addSchedule">Add</button>
          </div>
          <div class="small" style="margin-top:6px">
            Tips:
            <span class="tag">0 3 * * *</span> daily 03:00 ·
            <span class="tag">0 */6 * * *</span> every 6h ·
            <span class="tag">*/30 * * * *</span> every 30m
          </div>
        </section>
        <section class="card">
          <h3>Schedules</h3>
          <div style="overflow:auto; max-height:60vh">
            <table id="schedTable">
              <thead><tr><th>ID</th><th>Label</th><th>Cron</th><th>Enabled</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- PRESETS -->
      <!-- SETTINGS -->
      <div id="tab-settings" class="cards" hidden>
        <section class="card">
          <h3>Broadcast Presets</h3>
          <div class="row">
            <input id="bcLabel" type="text" placeholder="Label (optional)" />
            <input id="bcMessage" type="text" placeholder="Message" />
            <button class="btn brand" id="bcAdd">Save Preset</button>
          </div>
          <div style="overflow:auto; max-height:40vh; margin-top:10px">
            <table id="bcTable"><thead><tr><th>ID</th><th>Label</th><th>Message</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <section class="card half">
          <h3>Ban Presets</h3>
          <div class="row">
            <input id="banLabel" type="text" placeholder="Label (optional)" />
            <input id="banReason" type="text" placeholder="Reason" />
            <button class="btn brand" id="banAdd">Save Preset</button>
          </div>
          <div style="overflow:auto; max-height:40vh; margin-top:10px">
            <table id="banTable"><thead><tr><th>ID</th><th>Label</th><th>Reason</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <section class="card half">
          <h3>Kick Presets</h3>
          <div class="row">
            <input id="kickLabel" type="text" placeholder="Label (optional)" />
            <input id="kickReason" type="text" placeholder="Reason" />
            <button class="btn brand" id="kickAdd">Save Preset</button>
          </div>
          <div style="overflow:auto; max-height:40vh; margin-top:10px">
            <table id="kickTable"><thead><tr><th>ID</th><th>Label</th><th>Reason</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </section>

        <section class="card">
          <h3>Panel Configuration</h3>
          <div class="grid cols-2">
            <div>
              <label>Theme</label>
              <select id="themeSelect">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
            </div>
            <div>
              <label>Auto-refresh interval</label>
              <select id="refreshInterval">
                <option value="5000">5 seconds</option>
                <option value="10000" selected>10 seconds</option>
                <option value="30000">30 seconds</option>
                <option value="60000">1 minute</option>
              </select>
            </div>
          </div>
        </section>
      </div>

      <!-- AUDIT -->
      <div id="tab-audit" class="cards" hidden>
        <section class="card">
          <h3>Recent Audit Events</h3>
          <div style="overflow:auto; max-height:70vh">
            <table id="auditTable">
              <thead><tr><th>When</th><th>Action</th><th>Payload</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Player Modal -->
  <div class="modal" id="playerModal">
    <div class="sheet">
      <div class="row" style="align-items:center">
        <h3 id="pmTitle" style="margin:0">Player</h3>
        <button class="btn right" onclick="closePlayerModal()">Close</button>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div class="card">
          <h3>Profile</h3>
          <div class="small"><b>UUID:</b> <span id="pmUuid">—</span></div>
          <div class="small"><b>Last IP:</b> <span id="pmLastIp">—</span></div>
          <div class="small"><b>First Seen:</b> <span id="pmFirst">—</span></div>
          <div class="small"><b>Last Seen:</b> <span id="pmLast">—</span></div>
          <div class="small"><b>Total Playtime:</b> <span id="pmPlaytime">—</span></div>
        </div>
        <div class="card two">
          <h3>Sessions</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmSessions"><thead><tr><th>Login</th><th>Logout</th><th>Duration</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card two">
          <h3>Commands</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmCommands"><thead><tr><th>When</th><th>Command</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
        <div class="card">
          <h3>IPs Seen</h3>
          <div style="overflow:auto; max-height:36vh">
            <table id="pmIps"><thead><tr><th>IP</th><th>When</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved.</div>

  <script>
    // Chart info popup function
    function showChartInfo(chartType) {
      const infoTexts = {
        'cpu-memory': 'Shows CPU and Memory usage over time. CPU percentage indicates processor load, Memory percentage shows RAM utilization. High sustained values may indicate performance issues.',
        'network-tps': 'Displays online player count over time. This helps track server activity patterns and peak usage times.',
        'player-trend': 'Shows unique player count and total sessions over the selected period. Useful for understanding server growth and player engagement trends.',
        'session-dist': 'Breakdown of player session lengths into categories (short, medium, long sessions). Helps understand how long players typically stay connected.',
        'daily-players': 'Daily unique player counts for the last 7 days. Shows both unique players and total sessions to track server activity patterns.',
        'hourly-heatmap': 'Shows when players are most active during different hours. Darker colors indicate higher activity. Useful for planning events or maintenance.',
        'command-usage': 'Most frequently used commands by players. Helps server administrators understand player behavior and popular features.'
      };
      
      const text = infoTexts[chartType] || 'Chart information not available.';
      alert(text); // Simple alert for now, could be improved with a modal
    }

    // Defensive: ensure only Dashboard is visible at boot, in case of cachey CSS
    ['players','moderation','schedules','settings','audit','analytics','performance','server-controls']
      .forEach(t => { const el = document.getElementById('tab-'+t); if (el) el.hidden = true; });
    document.getElementById('tab-status').hidden = false;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function toast(msg='Saved.') { const el = $('#toast'); el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }
    function fmtDate(s){ if(!s) return '—'; const d = new Date(s); if (isNaN(d)) return s; return d.toLocaleString(); }
    function fmtDur(sec){ if(sec==null) return '—'; sec = Math.max(0, +sec|0); const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60; const parts = []; if(h) parts.push(h+'h'); if(m||h) parts.push((h?String(m).padStart(2,'0'):m)+'m'); parts.push(String(s).padStart(2,'0')+'s'); return parts.join(' '); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Chart.js defaults for dark theme (using our fallback implementation)
    function initializeChartJS() {
      if (typeof Chart !== 'undefined' && Chart.defaults) {
        Chart.defaults.color = '#aab3c7';
        Chart.defaults.backgroundColor = 'rgba(124, 92, 255, 0.1)';
        Chart.defaults.borderColor = '#7c5cff';
        if (Chart.defaults.plugins && Chart.defaults.plugins.legend) {
          Chart.defaults.plugins.legend.labels.color = '#aab3c7';
        }
        if (Chart.defaults.scales) {
          if (Chart.defaults.scales.linear) {
            Chart.defaults.scales.linear.grid.color = 'rgba(171, 179, 199, 0.1)';
            Chart.defaults.scales.linear.ticks.color = '#aab3c7';
          }
          if (Chart.defaults.scales.category) {
            Chart.defaults.scales.category.grid.color = 'rgba(171, 179, 199, 0.1)';
            Chart.defaults.scales.category.ticks.color = '#aab3c7';
          }
        }
        console.log('[panel] Chart.js defaults configured');
      } else {
        console.log('[panel] Using Chart.js fallback implementation');
      }
    }
    
    // Initialize Chart.js immediately since we provide our own implementation
    initializeChartJS();

    // Chart instances
    let playerTrendChart = null;
    let analyticsPlayerChart = null;
    let sessionDistChart = null;
    let hourlyActivityChart = null;
    let systemChart = null;
    let commandChart = null;
    let dailyPlayerChart = null;

    // Authentication handling - session-based (no more hardcoded auth headers)
    
    // Simple fetch functions with session-based authentication
    async function jget(url){ 
      const r = await fetch(url, { credentials: 'same-origin' }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }
    async function jpost(url,data){ 
      const r = await fetch(url,{
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body:JSON.stringify(data||{}),
        credentials: 'same-origin'
      }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }
    async function jdel(url){ 
      const r = await fetch(url,{
        method:'DELETE',
        credentials: 'same-origin'
      }); 
      if(!r.ok) {
        if (r.status === 401) {
          // Redirect to login on unauthorized
          window.location.href = '/login';
          return;
        }
        throw new Error(await r.text()); 
      }
      return r.json(); 
    }

    // Tabs - with defensive initialization to handle timing issues
    function initializeTabs() {
      const tabBtns = $$('.nav button');
      
      // Check if tab buttons are available
      if (tabBtns.length === 0) {
        console.warn('[panel] Tab buttons not found, retrying in 100ms...');
        setTimeout(initializeTabs, 100);
        return;
      }
      
      console.log(`[panel] Initializing ${tabBtns.length} tab buttons`);
      
      tabBtns.forEach(btn => {
        // Remove any existing listeners to prevent duplicates
        btn.removeEventListener('click', btn._tabClickHandler);
        
        // Create and store the click handler
        btn._tabClickHandler = () => {
          tabBtns.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const t = btn.dataset.tab;
          $$('#tab-status,#tab-players,#tab-moderation,#tab-schedules,#tab-settings,#tab-audit,#tab-analytics,#tab-performance,#tab-server-controls').forEach(x=>x.hidden = true);
          const targetTab = $('#tab-'+t);
          if (targetTab) {
            targetTab.hidden = false;
          } else {
            console.warn(`[panel] Tab content not found: tab-${t}`);
          }
          
          // Load tab-specific data

          if (t==='players'){ loadPlayers(); }
          if (t==='moderation'){ loadModeration(); loadBans(); }
          if (t==='schedules'){ loadSchedules(); }
          if (t==='settings'){ loadSettings(); }
          if (t==='audit'){ loadAudit(); }
          if (t==='analytics'){ loadAnalytics(); }
          if (t==='performance'){ loadPerformance(); loadSystemMonitoring(); }
          if (t==='server-controls'){ loadServerControls(); }
        };
        
        btn.addEventListener('click', btn._tabClickHandler);
      });
    }
    
    // Initialize tabs immediately and also retry if needed
    initializeTabs();

    // Status with enhanced dashboard data
    async function loadStatus(){
      try{
        const [status, dashboardData, serverStatus] = await Promise.all([
          jget('/api/status'),
          jget('/api/analytics/dashboard').catch(() => null),
          jget('/api/server/status').catch(() => null)
        ]);
        
        $('#statusChip').innerHTML = 'Status: <span class="tag">online</span>' + (status.rcon? ' <span class="tag">RCON</span>' : ' <span class="tag">no RCON</span>');
        $('#rconNote').textContent = status.rcon ? 'RCON enabled.' : 'RCON disabled; only "list" is emulated.';
        $('#nextRestart').textContent = status.next_restart_iso ? fmtDate(status.next_restart_iso) : '—';
        $('#nextRestart2').textContent = $('#nextRestart').textContent;
        $('#nextRestartIn').textContent = status.next_restart_seconds!=null ? (Math.floor(status.next_restart_seconds/60)+' min') : '—';
        
        // Update enhanced server status card
        if (serverStatus) {
          const systemStatus = serverStatus.system_status || 'unknown';
          const statusClass = systemStatus === 'active' ? 'status-online' : 
                             systemStatus === 'inactive' ? 'status-offline' : 'status-unknown';
          $('#serverStatusText').innerHTML = `<span class="status-indicator ${statusClass}"></span>${systemStatus}`;
          
          const rconStatus = serverStatus.rcon_available ? 'Available' : 'Unavailable';
          const rconClass = serverStatus.rcon_available ? 'status-online' : 'status-offline';
          $('#serverRconStatus').innerHTML = `<span class="status-indicator ${rconClass}"></span>${rconStatus}`;
          
          $('#serverStatusDetail').textContent = `${serverStatus.online_players || 0} players online • Live monitoring active`;
        } else {
          $('#serverStatusText').innerHTML = '<span class="status-indicator status-unknown"></span>Unknown';
          $('#serverRconStatus').innerHTML = '<span class="status-indicator status-offline"></span>' + (status.rcon ? 'Available' : 'Unavailable');
          $('#serverStatusDetail').textContent = 'Live log tracking enabled.';
        }
        
        // Update quick stats if available
        if (dashboardData && dashboardData.current_stats) {
          const stats = dashboardData.current_stats;
          $('#totalPlayers').textContent = stats.total_players || '0';
          $('#onlineNow').textContent = stats.online_players || '0';
          
          // Update recent activity
          if (dashboardData.recent_activity) {
            const activities = dashboardData.recent_activity.slice(0, 5).map(act => {
              const icon = act.type === 'join' ? '🟢' : '🔴';
              const time = new Date(act.timestamp).toLocaleTimeString();
              return `<div class="small" style="margin-bottom:4px">${icon} ${act.username} ${act.type === 'join' ? 'joined' : 'left'} at ${time}</div>`;
            }).join('');
            $('#recentActivity').innerHTML = activities || '<div class="empty">No recent activity</div>';
          }
          
          // Update player trend chart on dashboard
          if (dashboardData.player_trend && dashboardData.player_trend.length > 0) {
            updatePlayerTrendChart(dashboardData.player_trend);
          }
        }
      }catch(e){
        $('#statusChip').innerHTML = 'Status: <span class="tag">error</span>';
        $('#serverStatusText').innerHTML = '<span class="status-indicator status-unknown"></span>Error';
        $('#serverRconStatus').innerHTML = '<span class="status-indicator status-offline"></span>Error';
        $('#serverStatusDetail').textContent = 'Could not load server status.';
      }
    }

    // Update player trend chart (small version for dashboard)
    function updatePlayerTrendChart(data) {
      const ctx = $('#playerTrendChart').getContext('2d');
      
      if (playerTrendChart) {
        playerTrendChart.destroy();
      }
      
      // Prepare data for our fallback chart implementation
      const chartData = {
        labels: data.map(d => new Date(d.date).toLocaleDateString()),
        datasets: [{
          label: 'Unique Players',
          data: data.map(d => d.unique_players || 0),
          borderColor: '#7c5cff',
          backgroundColor: 'rgba(124, 92, 255, 0.1)',
          tension: 0.4,
          fill: true
        }]
      };
      
      playerTrendChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: { color: 'rgba(171, 179, 199, 0.1)' }
            },
            x: { 
              grid: { color: 'rgba(171, 179, 199, 0.1)' }
            }
          }
        }
      });
    }
    async function runList(){
      $('#cmdOut').textContent = 'Running…';
      try{
        const out = await jpost('/api/command',{command: $('#cmdInput').value.trim() || 'list'});
        $('#cmdOut').textContent = out.out || JSON.stringify(out,null,2);
      }catch(e){ $('#cmdOut').textContent = e.message || 'Error'; }
    }
    $('#sendCmd').addEventListener('click', runList);

    // Online
    async function loadOnline(copyToStatus=false){
      try{
        const data = await jget('/api/online');
        const onlineCountEl = $('#onlineCount');
        if (onlineCountEl) onlineCountEl.textContent = data.count ?? 0;
        
        const target1 = $('#onlineList'), target2 = $('#onlineList2');
        const empty1 = $('#onlineEmpty'), empty2 = $('#onlineEmpty2');
        const makeChip = (p)=>`<button class="btn" onclick="openPlayerByName('${p.username}')">${p.username}${p.uuid?` <span class='tag'>${p.uuid.slice(0,8)}</span>`:''}</button>`;
        
        if (target1) {
          target1.innerHTML = data.players.map(makeChip).join('');
        }
        if (target2) {
          target2.innerHTML = data.players.map(makeChip).join('');
        }
        if (empty1) {
          empty1.style.display = data.players.length? 'none':'block';
        }
        if (empty2) {
          empty2.style.display = data.players.length? 'none':'block';
        }
        
        if(copyToStatus && target1 && empty1){ 
          const onlineListEl = $('#onlineList');
          const onlineEmptyEl = $('#onlineEmpty');
          if (onlineListEl) onlineListEl.innerHTML = target1.innerHTML; 
          if (onlineEmptyEl) onlineEmptyEl.style.display = empty1.style.display; 
        }
      }catch{ 
        const onlineCountEl = $('#onlineCount');
        if (onlineCountEl) onlineCountEl.textContent = '—'; 
      }
    }

    // Players
    let playersCache = [];
    async function loadPlayers(){
      const tbody = $('#playersTable tbody'); tbody.innerHTML = '<tr><td colspan="6" class="small">Loading…</td></tr>';
      try{
        const data = await jget('/api/players'); playersCache = data; redrawPlayers();
      }catch{ tbody.innerHTML = '<tr><td colspan="6" class="small">Failed to load players</td></tr>'; }
    }
    function redrawPlayers(){
      const q = ($('#playerSearch').value||'').toLowerCase();
      const rows = playersCache.filter(p=>p.username.toLowerCase().includes(q)).map(p=>`<tr onclick="openPlayer(${p.id})" style="cursor:pointer">
          <td>${p.username}</td><td class="small">${p.uuid??'—'}</td><td class="small">${p.last_ip??'—'}</td>
          <td class="small">${fmtDate(p.first_seen)}</td><td class="small">${fmtDate(p.last_seen)}</td><td>${fmtDur(p.total_playtime)}</td>
        </tr>`);
      $('#playersTable tbody').innerHTML = rows.join('') || `<tr><td colspan="6" class="small">No players</td></tr>`;
      $('#playerCountChip').textContent = `${playersCache.length} players`;
    }
    $('#playerSearch').addEventListener('input', redrawPlayers);

    // Player modal
    function closePlayerModal(){ $('#playerModal').classList.remove('open'); }
    async function openPlayer(id){
      try{
        const d = await jget('/api/player/'+id);
        $('#pmTitle').textContent = d.player.username;
        $('#pmUuid').textContent = d.player.uuid || '—';
        $('#pmLastIp').textContent = d.player.last_ip || '—';
        $('#pmFirst').textContent = fmtDate(d.player.first_seen);
        $('#pmLast').textContent = fmtDate(d.player.last_seen);
        $('#pmPlaytime').textContent = fmtDur(d.player.total_playtime);

        const sBody = d.sessions.map(s=>`<tr><td class="small">${fmtDate(s.login_time)}</td><td class="small">${fmtDate(s.logout_time)}</td><td>${fmtDur(s.duration)}</td></tr>`).join('');
        $('#pmSessions tbody').innerHTML = sBody || '<tr><td colspan="3" class="small">No sessions</td></tr>';

        const cBody = d.commands.map(c=>`<tr><td class="small">${fmtDate(c.executed_at)}</td><td class="small"><code>${escapeHtml(c.command)}</code></td></tr>`).join('');
        $('#pmCommands tbody').innerHTML = cBody || '<tr><td colspan="2" class="small">No commands</td></tr>';

        const iBody = d.ips.map(i=>`<tr><td>${i.ip}</td><td class="small">${fmtDate(i.seen_at)}</td></tr>`).join('');
        $('#pmIps tbody').innerHTML = iBody || '<tr><td colspan="2" class="small">No IPs</td></tr>';

        $('#playerModal').classList.add('open');
      }catch{ toast('Failed to load player'); }
    }
    function openPlayerByName(name){
      const p = playersCache.find(x=>x.username===name);
      if(p) return openPlayer(p.id);
      loadPlayers().then(()=>{ const p2 = playersCache.find(x=>x.username===name); if(p2) openPlayer(p2.id); });
    }
    $('#playerModal').addEventListener('click', (e)=>{ if(e.target.id==='playerModal') closePlayerModal(); });

    // Bans
    async function loadBans(){
      $('#banPlayers').innerHTML = '<div class="small muted">Loading…</div>';
      $('#banIps').innerHTML = '<div class="small muted">Loading…</div>';
      try{
        const data = await jget('/api/bans');
        if(data.players?.length){ $('#banPlayersEmpty').style.display = 'none';
          $('#banPlayers').innerHTML = data.players.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill player">Player</span><b>${x.username||x.target}</b></div>${x.uuid?`<span class="tag">${x.uuid.slice(0,8)}</span>`:''}</div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'—'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span>${x.last_ip?`<span class="pill">Last IP: ${x.last_ip}</span>`:''}${x.last_seen?`<span class="pill">Last Seen: ${fmtDate(x.last_seen)}</span>`:''}${x.playtime_seconds!=null?`<span class="pill">Playtime: ${fmtDur(x.playtime_seconds)}</span>`:''}</div></div>`).join('');
        }else{ $('#banPlayers').innerHTML = ''; $('#banPlayersEmpty').style.display = 'block'; }

        if(data.ips?.length){ $('#banIpsEmpty').style.display = 'none';
          $('#banIps').innerHTML = data.ips.map(x=>`<div class="ban-card"><div class="head"><div class="who"><span class="pill ip">IP</span><b>${x.target}</b></div></div>
            <div class="small"><b>By:</b> ${x.by||'Server'}</div><div class="small"><b>Reason:</b> ${x.reason||'—'}</div>
            <div class="split small"><span class="pill">Banned: ${fmtDate(x.banned_at)}</span></div></div>`).join('');
        }else{ $('#banIps').innerHTML = ''; $('#banIpsEmpty').style.display = 'block'; }
      }catch{
        $('#banPlayers').innerHTML = '<div class="empty">Failed to load bans</div>'; $('#banIps').innerHTML = '';
      }
    }

    // Schedules
    async function loadSchedules(){
      const tbody = $('#schedTable tbody'); tbody.innerHTML = '<tr><td colspan="5" class="small">Loading…</td></tr>';
      try{
        const rows = await jget('/api/schedules');
        tbody.innerHTML = rows.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small"><code>${r.cron}</code></td><td><button class="btn ghost" onclick="toggleSchedule(${r.id})">${r.enabled?'✓ Enabled':'Disabled'}</button></td><td><button class="btn danger ghost" onclick="deleteSchedule(${r.id})">Delete</button></td></tr>`).join('') || '<tr><td colspan="5" class="small">No schedules</td></tr>';
      }catch{ tbody.innerHTML = '<tr><td colspan="5" class="small">Failed to load schedules</td></tr>'; }
    }
    async function toggleSchedule(id){
      try{ await jpost('/api/schedules/'+id+'/toggle'); loadSchedules(); toast('Schedule toggled'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteSchedule(id){
      if(!confirm('Delete this schedule?')) return;
      try{ await jdel('/api/schedules/'+id); loadSchedules(); toast('Schedule deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    $('#addSchedule').addEventListener('click', async ()=>{
      const cron = $('#cronExpr').value.trim(), label = $('#cronLabel').value.trim();
      if(!cron) return toast('Cron expression required');
      try{ await jpost('/api/schedules', {cron, label:label||null}); $('#cronExpr').value = ''; $('#cronLabel').value = ''; loadSchedules(); toast('Schedule added'); }catch(e){ toast('Failed: '+e.message); }
    });

    // Moderation
    async function loadModeration(){
      try{
        const [banPresets, kickPresets] = await Promise.all([
          jget('/api/ban-presets'),
          jget('/api/kick-presets')
        ]);
        
        // Populate ban presets dropdown
        $('#modBanSelect').innerHTML = '<option value="">Select ban reason…</option>' + 
          banPresets.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
        
        // Populate kick presets dropdown
        $('#modKickSelect').innerHTML = '<option value="">Select kick reason…</option>' + 
          kickPresets.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
      }catch(e){ 
        console.error('Failed to load moderation presets:', e); 
        $('#modBanSelect').innerHTML = '<option value="">Select ban reason…</option>';
        $('#modKickSelect').innerHTML = '<option value="">Select kick reason…</option>';
      }
    }

    // Presets
    async function loadSettings(){
      try{
        const [bc, ban, kick] = await Promise.all([
          jget('/api/broadcast-presets'), 
          jget('/api/ban-presets'),
          jget('/api/kick-presets')
        ]);
        
        // Broadcast presets table
        const bcRows = bc.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small">${escapeHtml(r.message||'')}</td><td><button class="btn danger ghost" onclick="deleteBcPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#bcTable tbody').innerHTML = bcRows || '<tr><td colspan="4" class="small">No presets</td></tr>';
        
        // Ban presets table
        const banRows = ban.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small">${escapeHtml(r.reason||'')}</td><td><button class="btn danger ghost" onclick="deleteBanPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#banTable tbody').innerHTML = banRows || '<tr><td colspan="4" class="small">No presets</td></tr>';
        
        // Kick presets table
        const kickRows = kick.map(r=>`<tr><td>${r.id}</td><td>${r.label||'—'}</td><td class="small">${escapeHtml(r.reason||'')}</td><td><button class="btn danger ghost" onclick="deleteKickPreset(${r.id})">Delete</button></td></tr>`).join('');
        $('#kickTable tbody').innerHTML = kickRows || '<tr><td colspan="4" class="small">No presets</td></tr>';

        // Update server controls broadcast preset dropdown
        const serverBcSelect = $('#serverBroadcastPreset');
        if (serverBcSelect) {
          serverBcSelect.innerHTML = '<option value="">Or select preset message...</option>' + bc.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
        }
      }catch(e){ console.error('Failed to load settings:', e); }
    }
    
    async function deleteBcPreset(id){
      if(!confirm('Delete this broadcast preset?')) return;
      try{ await jdel('/api/broadcast-presets/'+id); loadSettings(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteBanPreset(id){
      if(!confirm('Delete this ban preset?')) return;
      try{ await jdel('/api/ban-presets/'+id); loadSettings(); loadModeration(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    async function deleteKickPreset(id){
      if(!confirm('Delete this kick preset?')) return;
      try{ await jdel('/api/kick-presets/'+id); loadSettings(); loadModeration(); toast('Preset deleted'); }catch(e){ toast('Failed: '+e.message); }
    }
    
    $('#bcAdd').addEventListener('click', async ()=>{
      const label = $('#bcLabel').value.trim(), message = $('#bcMessage').value.trim();
      if(!message) return toast('Message required');
      try{ await jpost('/api/broadcast-presets', {label:label||null, message}); $('#bcLabel').value = ''; $('#bcMessage').value = ''; loadSettings(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#banAdd').addEventListener('click', async ()=>{
      const label = $('#banLabel').value.trim(), reason = $('#banReason').value.trim();
      if(!reason) return toast('Reason required');
      try{ await jpost('/api/ban-presets', {label:label||null, reason}); $('#banLabel').value = ''; $('#banReason').value = ''; loadSettings(); loadModeration(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#kickAdd').addEventListener('click', async ()=>{
      const label = $('#kickLabel').value.trim(), reason = $('#kickReason').value.trim();
      if(!reason) return toast('Reason required');
      try{ await jpost('/api/kick-presets', {label:label||null, reason}); $('#kickLabel').value = ''; $('#kickReason').value = ''; loadSettings(); loadModeration(); toast('Preset saved'); }catch(e){ toast('Failed: '+e.message); }
    });
    
    // Performance monitoring functions
    async function loadPerformance() {
      try {
        // Load live metrics first
        await updateLiveMetrics();
        
        // Load historical data
        await updatePerformanceHistory();
        
        // Set up auto-refresh
        if (window.performanceInterval) clearInterval(window.performanceInterval);
        window.performanceInterval = setInterval(updateLiveMetrics, 5000);
      } catch (e) {
        console.error('Failed to load performance data:', e);
      }
    }
    
    async function updateLiveMetrics() {
      try {
        const data = await jget('/api/performance/live');
        
        $('#liveCPU').textContent = data.cpu?.usage ? data.cpu.usage + '%' : '—';
        $('#liveRAM').textContent = data.memory?.usage ? data.memory.usage + '%' : '—';
        $('#liveDisk').textContent = data.disk?.usage ? data.disk.usage + '%' : '—';
        $('#liveTPS').textContent = data.tps ? data.tps.toFixed(1) : '—';
        $('#networkRx').textContent = data.network?.rxRate ? data.network.rxRate + ' KB/s' : '—';
        $('#networkTx').textContent = data.network?.txRate ? data.network.txRate + ' KB/s' : '—';
        $('#serverUptime').textContent = data.uptime ? fmtDur(data.uptime) : '—';
        $('#avgTPS').textContent = data.tps ? data.tps.toFixed(1) : '—'; // Show same TPS for now
        
        // Update load average
        $('#load1').textContent = data.load?.[1] ? data.load[1].toFixed(2) : '—';
        $('#load5').textContent = data.load?.[5] ? data.load[5].toFixed(2) : '—';
        $('#load15').textContent = data.load?.[15] ? data.load[15].toFixed(2) : '—';
      } catch (e) {
        console.error('Failed to update live metrics:', e);
      }
    }
    
    async function updatePerformanceHistory() {
      try {
        const period = $('#perfPeriod').value || '1d';
        const data = await jget(`/api/performance/history?period=${period}`);
        
        // Create CPU/Memory chart
        if (data.system_metrics && data.system_metrics.length > 0) {
          const cpuData = data.system_metrics.map(m => m.cpu_usage || 0);
          const memData = data.system_metrics.map(m => m.memory_usage || 0);
          const labels = data.system_metrics.map(m => new Date(m.recorded_at).toLocaleTimeString());
          
          // Update CPU chart
          const cpuCtx = $('#performanceCPUChart').getContext('2d');
          const cpuChart = new Chart(cpuCtx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'CPU %',
                data: cpuData,
                borderColor: '#7c5cff',
                backgroundColor: 'rgba(124, 92, 255, 0.1)'
              }, {
                label: 'Memory %',
                data: memData,
                borderColor: '#44d3a8',
                backgroundColor: 'rgba(68, 211, 168, 0.1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true, max: 100 }
              }
            }
          });
        } else {
          // Show "no data" message when no system metrics
          const cpuCtx = $('#performanceCPUChart').getContext('2d');
          cpuCtx.fillStyle = '#aab3c7';
          cpuCtx.font = '14px system-ui';
          cpuCtx.textAlign = 'center';
          cpuCtx.fillText('No historical data available yet', cpuCtx.canvas.width / 2, cpuCtx.canvas.height / 2);
        }
        
        // Create Network chart with online players
        if (data.online_history && data.online_history.length > 0) {
          const onlineData = data.online_history.map(m => m.online_count || 0);
          const networkData = data.system_metrics ? data.system_metrics.map(m => (m.network_rx_rate || 0) + (m.network_tx_rate || 0)) : [];
          const labels = data.online_history.map(m => new Date(m.recorded_at).toLocaleTimeString());
          
          const networkCtx = $('#performanceNetworkChart').getContext('2d');
          const networkChart = new Chart(networkCtx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Online Players',
                data: onlineData,
                borderColor: '#ffb020',
                backgroundColor: 'rgba(255, 176, 32, 0.1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        } else {
          // Show "no data" message when no online history
          const networkCtx = $('#performanceNetworkChart').getContext('2d');
          networkCtx.fillStyle = '#aab3c7';
          networkCtx.font = '14px system-ui';
          networkCtx.textAlign = 'center';
          networkCtx.fillText('No player history data available yet', networkCtx.canvas.width / 2, networkCtx.canvas.height / 2);
        }
      } catch (e) {
        console.error('Failed to update performance history:', e);
        // Show error message in charts
        const cpuCtx = $('#performanceCPUChart').getContext('2d');
        const networkCtx = $('#performanceNetworkChart').getContext('2d');
        cpuCtx.fillStyle = '#ff5d5d';
        cpuCtx.font = '14px system-ui';
        cpuCtx.textAlign = 'center';
        cpuCtx.fillText('Failed to load chart data', cpuCtx.canvas.width / 2, cpuCtx.canvas.height / 2);
        networkCtx.fillStyle = '#ff5d5d';
        networkCtx.font = '14px system-ui';
        networkCtx.textAlign = 'center';
        networkCtx.fillText('Failed to load chart data', networkCtx.canvas.width / 2, networkCtx.canvas.height / 2);
      }
    }
    
    // Server controls functions
    async function loadServerControls() {
      try {
        // Load server status
        await updateServerStatus();
        
        // Load broadcast presets for server controls
        const bc = await jget('/api/broadcast-presets');
        $('#serverBroadcastPreset').innerHTML = '<option value="">Or select preset message...</option>' + 
          bc.map(r=>`<option value="${r.id}">${r.label||('ID: '+r.id)}</option>`).join('');
        
        // Set up auto-refresh
        if (window.serverControlsInterval) clearInterval(window.serverControlsInterval);
        window.serverControlsInterval = setInterval(updateServerStatus, 10000);
      } catch (e) {
        console.error('Failed to load server controls:', e);
      }
    }
    
    async function updateServerStatus() {
      try {
        const data = await jget('/api/server/status');
        
        // Update status with indicators
        const systemStatus = data.system_status || 'unknown';
        const statusClass = systemStatus === 'active' ? 'status-online' : 
                           systemStatus === 'inactive' ? 'status-offline' : 'status-unknown';
        $('#serverSystemStatus').innerHTML = `<span class="status-indicator ${statusClass}"></span>${systemStatus}`;
        
        $('#serverOnlinePlayers').textContent = data.online_players || '0';
        
        const rconStatus = data.rcon_available ? 'Available' : 'Unavailable';
        const rconClass = data.rcon_available ? 'status-online' : 'status-offline';
        $('#serverRconStatus').innerHTML = `<span class="status-indicator ${rconClass}"></span>${rconStatus}`;
        
        $('#serverLastAction').textContent = data.recent_actions && data.recent_actions.length > 0 ? 
          fmtDate(data.recent_actions[0].at) : '—';
        
        // Update action history
        if (data.recent_actions) {
          const historyHtml = data.recent_actions.map(action => {
            const actionData = JSON.parse(action.data || '{}');
            return `<div class="audit-item" style="padding:8px; border-bottom:1px solid var(--border); margin-bottom:8px">
              <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                  <div class="audit-action" style="font-weight:600; color:var(--brand)">${action.action.replace('server_', '').toUpperCase()}</div>
                  <div class="audit-ip small">by ${action.by_ip}</div>
                </div>
                <div class="audit-time small">${fmtDate(action.at)}</div>
              </div>
              ${actionData.broadcast ? `<div class="audit-extra small" style="margin-top:4px; color:var(--muted)">Message: ${escapeHtml(actionData.broadcast)}</div>` : ''}
            </div>`;
          }).join('');
          $('#serverActionHistory').innerHTML = historyHtml || '<div class="empty">No recent actions</div>';
        }
      } catch (e) {
        console.error('Failed to update server status:', e);
        $('#serverSystemStatus').innerHTML = '<span class="status-indicator status-unknown"></span>Error';
        $('#serverOnlinePlayers').textContent = '—';
        $('#serverRconStatus').innerHTML = '<span class="status-indicator status-offline"></span>Error';
        $('#serverLastAction').textContent = '—';
      }
    }
    
    // Moderation functionality
    $('#modBanSend').addEventListener('click', async ()=>{
      const username = $('#modBanUser').value.trim(), presetId = $('#modBanSelect').value;
      if(!username) return toast('Username required');
      if(!presetId) return toast('Please select a ban reason');
      if(!confirm(`Ban user "${username}"?`)) return;
      try{ const result = await jpost('/api/ban', {username, presetId: Number(presetId)}); toast('Ban executed'); $('#cmdOut').textContent = result.out || 'Ban executed successfully'; $('#modBanUser').value = ''; }catch(e){ toast('Failed: '+e.message); }
    });
    
    $('#modKickSend').addEventListener('click', async ()=>{
      const username = $('#modKickUser').value.trim(), presetId = $('#modKickSelect').value;
      if(!username) return toast('Username required');
      if(!presetId) return toast('Please select a kick reason');
      if(!confirm(`Kick user "${username}"?`)) return;
      try{ const result = await jpost('/api/kick', {username, presetId: Number(presetId)}); toast('Kick executed'); $('#cmdOut').textContent = result.out || 'Kick executed successfully'; $('#modKickUser').value = ''; }catch(e){ toast('Failed: '+e.message); }
    });

    // Analytics
    async function loadAnalytics() {
      try {
        const data = await jget('/api/analytics/dashboard');
        
        // Update today's stats
        if (data.current_stats && data.current_stats.today) {
          const today = data.current_stats.today;
          $('#todayPlayers').textContent = today.unique_players || '0';
          $('#todaySessions').textContent = today.total_sessions || '0';
          $('#todayPeak').textContent = today.peak_online || '0';
          $('#avgSession').textContent = Math.round((today.avg_session_duration || 0) / 60);
        }
        
        // Update player trend chart
        if (data.player_trend) {
          updateAnalyticsPlayerChart(data.player_trend);
        }
        
        // Update top players
        if (data.top_players) {
          const playersHtml = data.top_players.map((player, index) => 
            `<div class="small" style="display:flex; justify-content:space-between; margin-bottom:8px; padding:8px; background:rgba(15,17,21,0.5); border-radius:8px">
              <span><b>${index + 1}.</b> ${player.username}</span>
              <span>${player.playtime_hours}h</span>
            </div>`
          ).join('');
          $('#topPlayersList').innerHTML = playersHtml || '<div class="empty">No player data</div>';
        }
        
        // Update session distribution
        if (data.session_distribution) {
          updateSessionDistChart(data.session_distribution);
        }
        
        // Update hourly activity
        if (data.hourly_activity) {
          updateHourlyActivityChart(data.hourly_activity);
        }
        
        // Update command stats
        if (data.command_stats) {
          // Update text list
          const commandsHtml = data.command_stats.slice(0, 10).map(cmd => 
            `<div class="small" style="display:flex; justify-content:space-between; margin-bottom:4px">
              <span><code>${escapeHtml(cmd.command)}</code></span>
              <span>${cmd.usage_count} uses</span>
            </div>`
          ).join('');
          $('#commandStats').innerHTML = commandsHtml || '<div class="empty">No command data</div>';
          
          // Update command chart
          updateCommandChart(data.command_stats);
        }
        
        // Load additional analytics data
        await loadAdditionalAnalytics();
        
      } catch (e) {
        console.error('Failed to load analytics:', e);
        toast('Failed to load analytics data');
      }
    }

    function updateAnalyticsPlayerChart(data) {
      const ctx = $('#analyticsPlayerChart').getContext('2d');
      
      if (analyticsPlayerChart) {
        analyticsPlayerChart.destroy();
      }
      
      analyticsPlayerChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [
            {
              label: 'Unique Players',
              data: data.map(d => d.unique_players || 0),
              borderColor: '#7c5cff',
              backgroundColor: 'rgba(124, 92, 255, 0.1)',
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Sessions',
              data: data.map(d => d.total_sessions || 0),
              borderColor: '#44d3a8',
              backgroundColor: 'rgba(68, 211, 168, 0.1)',
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' }
          }
        }
      });
    }

    function updateSessionDistChart(data) {
      const ctx = $('#sessionDistChart').getContext('2d');
      
      if (sessionDistChart) {
        sessionDistChart.destroy();
      }
      
      sessionDistChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.map(d => d.duration_bucket),
          datasets: [{
            data: data.map(d => d.count || 0),
            backgroundColor: [
              'rgba(124, 92, 255, 0.8)',
              'rgba(68, 211, 168, 0.8)',
              'rgba(255, 176, 32, 0.8)',
              'rgba(255, 93, 93, 0.8)',
              'rgba(156, 163, 175, 0.8)',
              'rgba(99, 102, 241, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateHourlyActivityChart(data) {
      const ctx = $('#hourlyActivityChart').getContext('2d');
      
      if (hourlyActivityChart) {
        hourlyActivityChart.destroy();
      }
      
      hourlyActivityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.hour + ':00'),
          datasets: [{
            label: 'Sessions',
            data: data.map(d => d.sessions || 0),
            backgroundColor: 'rgba(124, 92, 255, 0.6)',
            borderColor: '#7c5cff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Command usage chart
    function updateCommandChart(data) {
      const ctx = $('#commandChart').getContext('2d');
      
      if (commandChart) {
        commandChart.destroy();
      }
      
      // Take top 10 commands
      const topCommands = data.slice(0, 10);
      
      commandChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topCommands.map(cmd => cmd.command),
          datasets: [{
            label: 'Usage Count',
            data: topCommands.map(cmd => cmd.usage_count),
            backgroundColor: 'rgba(68, 211, 168, 0.6)',
            borderColor: '#44d3a8',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Daily player chart
    function updateDailyPlayerChart(data) {
      const ctx = $('#dailyPlayerChart').getContext('2d');
      
      if (dailyPlayerChart) {
        dailyPlayerChart.destroy();
      }
      
      dailyPlayerChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => new Date(d.date).toLocaleDateString()),
          datasets: [{
            label: 'Unique Players',
            data: data.map(d => d.unique_players || 0),
            borderColor: '#7c5cff',
            backgroundColor: 'rgba(124, 92, 255, 0.1)',
            fill: true,
            tension: 0.4
          }, {
            label: 'Total Sessions',
            data: data.map(d => d.total_sessions || 0),
            borderColor: '#44d3a8',
            backgroundColor: 'rgba(68, 211, 168, 0.1)',
            fill: false,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // Load additional analytics data
    async function loadAdditionalAnalytics() {
      try {
        // Load daily player data for the last 7 days
        const playerTrend = await jget('/api/analytics/player-trend?days=7');
        if (playerTrend) {
          updateDailyPlayerChart(playerTrend);
        }
      } catch (e) {
        console.error('Failed to load additional analytics:', e);
      }
    }

    // System Monitoring
    async function loadSystemMonitoring() {
      try {
        const fileStats = await jget('/api/files/stats').catch(() => null);
        
        // Update file monitoring stats
        if (fileStats) {
          const fileStatsHtml = `
            <div class="grid cols-2">
              <div class="small">Banned Players: <b>${fileStats.banned_players || 0}</b></div>
              <div class="small">Banned IPs: <b>${fileStats.banned_ips || 0}</b></div>
              <div class="small">Whitelist: <b>${fileStats.whitelist || 0}</b></div>
              <div class="small">Operators: <b>${fileStats.operators || 0}</b></div>
              <div class="small">Server Settings: <b>${fileStats.server_settings || 0}</b></div>
              <div class="small">Active Watchers: <b>${fileStats.active_watchers || 0}</b></div>
            </div>
          `;
          $('#fileMonitorStats').innerHTML = fileStatsHtml;
        }
        
        // Load system history chart
        loadSystemHistoryChart();
        
      } catch (e) {
        console.error('Failed to load system monitoring:', e);
        toast('Failed to load system monitoring data');
      }
    }

    async function loadSystemHistoryChart() {
      try {
        const history = await jget('/api/system/history?hours=24');
        
        const ctx = $('#systemChart').getContext('2d');
        
        if (systemChart) {
          systemChart.destroy();
        }
        
        systemChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: history.map(h => new Date(h.recorded_at).toLocaleTimeString()),
            datasets: [
              {
                label: 'CPU %',
                data: history.map(h => h.cpu_usage || 0),
                borderColor: '#7c5cff',
                backgroundColor: 'rgba(124, 92, 255, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Memory %',
                data: history.map(h => h.memory_usage || 0),
                borderColor: '#44d3a8',
                backgroundColor: 'rgba(68, 211, 168, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              },
              {
                label: 'Disk %',
                data: history.map(h => h.disk_usage || 0),
                borderColor: '#ffb020',
                backgroundColor: 'rgba(255, 176, 32, 0.1)',
                yAxisID: 'y',
                tension: 0.4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: 'Usage %' }
              }
            }
          }
        });
        
      } catch (e) {
        console.warn('Failed to load system history chart:', e);
        // Show fallback message in the chart container
        const ctx = $('#systemChart').getContext('2d');
        ctx.fillStyle = '#aab3c7';
        ctx.font = '14px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('System history unavailable', ctx.canvas.width / 2, ctx.canvas.height / 2);
      }
    }

    // Logout function
    async function logout() {
      try {
        await jpost('/logout');
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout failed:', error);
        // Even if logout fails, redirect to login
        window.location.href = '/login';
      }
    }

    // Audit
    async function loadAudit(){
      const tbody = $('#auditTable tbody'); tbody.innerHTML = '<tr><td colspan="3" class="small">Loading…</td></tr>';
      try{
        const rows = await jget('/api/audit');
        tbody.innerHTML = rows.map(r=>`<tr><td class="small">${fmtDate(r.created_at)}</td><td class="small"><code>${r.action}</code></td><td class="small">${escapeHtml(JSON.stringify(r.payload||{}))}</td></tr>`).join('') || '<tr><td colspan="3" class="small">No audit events</td></tr>';
      }catch{ tbody.innerHTML = '<tr><td colspan="3" class="small">Failed to load audit</td></tr>'; }
    }

    // Global refresh
    $('#refreshBtn').addEventListener('click', ()=>{
      loadStatus(); loadOnline();
      const active = $('.nav button.active').dataset.tab;
      if(active==='players') loadPlayers();
      if(active==='moderation') { loadModeration(); loadBans(); }
      if(active==='schedules') loadSchedules();
      if(active==='settings') loadSettings();
      if(active==='audit') loadAudit();
      if(active==='analytics') loadAnalytics();
      if(active==='performance') { loadPerformance(); loadSystemMonitoring(); }
      if(active==='server-controls') loadServerControls();
    });

    // Logout button
    $('#logoutBtn').addEventListener('click', logout);

    // Performance tab event listeners
    $('#perfRefresh').addEventListener('click', updatePerformanceHistory);
    $('#perfPeriod').addEventListener('change', updatePerformanceHistory);

    // Server controls event listeners
    $('#startServerBtn').addEventListener('click', async () => {
      const message = $('#serverBroadcastMsg').value.trim();
      if (!confirm('Start the server?')) return;
      try {
        const result = await jpost('/api/server/start', { broadcastMessage: message || null });
        toast('Server start command sent');
        $('#serverBroadcastMsg').value = '';
        setTimeout(updateServerStatus, 3000); // Refresh status after delay
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    });

    $('#stopServerBtn').addEventListener('click', async () => {
      const message = $('#serverBroadcastMsg').value.trim();
      if (!confirm('Stop the server? This will disconnect all players.')) return;
      try {
        const result = await jpost('/api/server/stop', { broadcastMessage: message || null });
        toast('Server stop command sent');
        $('#serverBroadcastMsg').value = '';
        setTimeout(updateServerStatus, 3000); // Refresh status after delay
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    });

    $('#restartServerBtn').addEventListener('click', async () => {
      const message = $('#serverBroadcastMsg').value.trim();
      if (!confirm('Restart the server? This will temporarily disconnect all players.')) return;
      try {
        const result = await jpost('/api/server/restart', { broadcastMessage: message || null });
        toast('Server restart command sent');
        $('#serverBroadcastMsg').value = '';
        setTimeout(updateServerStatus, 5000); // Refresh status after delay
      } catch (e) {
        toast('Failed: ' + e.message);
      }
    });

    $('#usePresetMsg').addEventListener('click', () => {
      const presetId = $('#serverBroadcastPreset').value;
      if (!presetId) return toast('Please select a preset first');
      
      // Find the preset message and populate the textarea
      jget('/api/broadcast-presets').then(presets => {
        const preset = presets.find(p => p.id == presetId);
        if (preset) {
          $('#serverBroadcastMsg').value = preset.message || '';
        }
      }).catch(e => toast('Failed to load preset'));
    });

    // Theme switcher
    $('#themeSelect').addEventListener('change', (e) => {
      const theme = e.target.value;
      if (theme === 'light') {
        document.body.classList.add('light-theme');
        localStorage.setItem('panel-theme', 'light');
      } else {
        document.body.classList.remove('light-theme');
        localStorage.setItem('panel-theme', 'dark');
      }
    });

    // Load saved theme
    const savedTheme = localStorage.getItem('panel-theme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-theme');
      $('#themeSelect').value = 'light';
    }

    // Enhanced initialization with proper DOM ready handling
    function initializeApp() {
      // Ensure DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
        return;
      }
      
      console.log('[panel] Initializing application...');
      
      // Initialize tabs with retry mechanism
      initializeTabs();
      
      // Start data loading
      setTimeout(() => {
        loadStatus(); loadOnline(true);
        setInterval(()=>{ loadStatus(); loadOnline(true); }, 30000); // Refresh every 30s
      }, 1000);
      
      console.log('[panel] Application initialized successfully');
    }
    
    // Start initialization
    initializeApp();
  </script>
</body>
</html>
